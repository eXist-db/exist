<?xml version="1.0" encoding="UTF-8"?>
<book>
    <bookinfo>
        <graphic fileref="../logo.jpg"/>
        <productname>Open Source Native XML Database</productname>
        <title>Package Repository</title>
    	<subject>Package Repository</subject>
    	<date>July 2010</date>
        <author>
            <firstname>James</firstname>
            <surname>Fuller</surname>
            <affiliation>
                <address format="linespecific"><email>jim.fuller at webcomposite.com</email></address>
            </affiliation>
        </author>
    </bookinfo>
    <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="sidebar.xml"/>

    <chapter>
    	<title>Package Repository</title>
    	<section>
        <title>Overview</title>
        <para>In any computing environment, managing dependencies is difficult. The eXist-db package repository
            makes it easy to manage and deploy external packages (.xar archives) which include everything they need to run
            third party XQuery libraries to full applications or other XML technology functionality.
        </para>
         <para>
             eXist-db now uses expath repository to resolve external XQuery dependencies located in [package repository
             to be used by your own XQuery. Soon we will also have support for being able to deploy and manage
             other XML technologies like XSLT, Xproc, Schema, and data/resources.
         </para>
        <para>
            Using an XQuery package in the repository is as simple as importing it the normal way.
<example>
            <title>List existing packages</title>
            <programlisting>
            <markup>
import module namespace functx="http://www.functx.com";

functx:capitalize-first('hello')
            </markup>
            </programlisting>
    <a href="install-functx.xqy" target="_example">click here to install functx</a> |

</example>
            If you installed the functx-1.0.xar package the above would work as eXist package manager will resolve the module
            from the repository. You can <a href="/exist/rest/db?_query=import%20module%20namespace%20repo=%22http://exist-db.org/xquery/repo%22;%20repo:list%28%29" target="list">list installed packages</a>
to see if Functx module is now installed.</para>
        <para>
            <important>
                <para>eXist repository is based on the <a href="http://expath.org/modules/pkg/">expath package repository specification</a>.</para>
            </important>
            <important>
                <para>Any newly installed packages still requires you to restart eXistdb, a limitation we will be addressing in the near future.</para>
            </important>

        </para>
    </section>

        <section>
            <title>Installation</title>
            <para>
                This module relies on the presence of the following jar files in the EXIST_HOME/lib/core folder. This jar
                is included in the lib/core already.
<example>
            <programlisting>
            <markup>
pkg-repo.jar
            </markup>
            </programlisting>
</example>

</para>
            <para>
               If you are working off development /trunk you will need to do the following as eXist-db now depends on
                package management repository.
                <ul>
                    <li>
                        svn update to pick up new code
                    </li>
                    <li>
                        ensure include.module.expathrepo = true in your extensions/local.build.properties
                     </li>
                    <li>
                        rebuild eXist (so repo extension module gets built)
                    </li>
                </ul>
You will then need to add the following module element to your conf.xml
<example>
            <programlisting>
            <markup>
&lt;module class="org.exist.xquery.modules.expathrepo.ExpathPackageModule"
        uri="http://exist-db.org/xquery/repo" /&gt;

            </markup>
            </programlisting>
</example>

            </para>
        </section>

    <section>
        <title>.xar Archive</title>
        <para>The repository supports package archive in .xar format, containing XQuery, XSLT, Schema and XProc modules

 </para>
<para>
    A .xar package format is a set of files bundled with a package description (expath-pkg.xml). For example, The
    <a href="http://www.functx.com" target="functx">FunctX XQuery library</a> is packaged up as follows
<example>
            <title>functx-1.0.xar package distribution</title>
            <programlisting>
            <markup>
expath-pkg.xml
functx/
   functx.xql
   functx.xsl
            </markup>
            </programlisting>
</example>
</para>
<para>The expath-pkg.xml contains <a href="http://expath.org/modules/pkg.html#d2e112" target="expathspec">package description</a>. The
    .xar comprises of the zipped up distribution.
</para>
        <para>We have shipped a few .xar packages in the <a href="http://127.0.0.1:8080/exist/repo/packages" target="dir">.xar directory</a> which you can use
            to test installing a package. This is achieved by using controller.xql to identify
        <ul>
            <li>Functx-1.0 <a href="packages/functx-1.0.xar?install=true" target="install">install</a> | <a href="packages/functx-1.0.xar?remove=true" target="remove">remove</a> </li>
            <!--li>EXPATH-HTTP-Client-0.1 <a href="packages/expath-http-client-exist-0.1.xar?install=true" target="install">install</a> | <a href="packages/expath-http-client-exist-0.1.xar?remove=true" target="remove">remove</a> </li-->
            <li>XQuery-Json-0.1 <a href="packages/xquery-json-0.1.xar?install=true" target="install">install</a> | <a href="packages/xquery-json-0.1.xar?remove=true" target="remove">remove</a> </li>
            <li>FXSL-1.0 <a href="packages/fxsl-1.0.xar?install=true" target="install">install</a> | <a href="packages/fxsl-1.0.xar?remove=true" target="remove">remove</a></li>
            <li>example app Invoice-1.0 <a href="packages/invoice-1.0.xar?install=true" target="install">install</a> | <a href="packages/invoice-1.0.xar?remove=true" target="remove">remove</a> </li>
        </ul>
    </para>
<para>A more advanced package could contain other archive resources. We can package up eXist own modules into jars and
    distribute them using .xar. The following expath-pkg.xml package describes eXist's own math module.
    <example>
			<title>package description for extensions math module</title>
			<programlisting>
			<markup>
&lt;package xmlns="http://expath.org/ns/pkg"&gt;
   &lt;module name="math" version="1.0"&gt;
      &lt;title&gt;Math extension packaged as xar&lt;/title&gt;
      &lt;exist&gt;
         &lt;jar&gt;math.jar&lt;/jar&gt;
         &lt;java&gt;
            &lt;namespace&gt;http://exist-db.org/xquery/math&lt;/namespace&gt;
            &lt;class&gt;org.exist.xquery.modules.math.MathModule&lt;/class&gt;
         &lt;/java&gt;
      &lt;/exist&gt;
   &lt;/module&gt;
&lt;/package&gt;
            </markup>
			</programlisting>
        </example>
</para>

<para>
The <a href="packages/math-example/math" target="math">math jar</a> that is referenced from expath-pkg.xml needs to contain the correct MANIFEST.MF which lists out any other
    dependent jars (lib/exist.jar and lib/xmldb.jar), as shown below.

<example>
        <title>math.jar MANIFEST.MF</title>
        <programlisting>
        <markup>
Manifest-Version: 1.0
Ant-Version: Apache Ant 1.7.1
Created-By: 14.1-b02-90 (Apple Inc.)
Project-Name: eXist
Project-Version: 1.5.0dev
Class-Path: lib/exist.jar lib/xmldb.jar
        </markup>
        </programlisting>
    </example>

</para>
<para>
Then its just a matter of including all the extensions classes.
<example>
        <title>xar-math target in extensions/modules/build.xml creates math.jar which ships inside math-1.0.xar </title>
        <programlisting>
        <markup>
drwxr-xr-x         0  31-Jul-2010  22:09:40  META-INF/
-rw-r--r--       183  31-Jul-2010  22:09:38  META-INF/MANIFEST.MF
drwxr-xr-x         0  31-Jul-2010  14:03:36  org/
drwxr-xr-x         0  31-Jul-2010  14:03:36  org/exist/
drwxr-xr-x         0  31-Jul-2010  14:03:36  org/exist/xquery/
drwxr-xr-x         0  31-Jul-2010  14:03:46  org/exist/xquery/modules/
drwxr-xr-x         0  31-Jul-2010  14:03:46  org/exist/xquery/modules/math/
-rw-r--r--      1867  31-Jul-2010  14:03:46  org/exist/xquery/modules/math/MathModule.class
-rw-r--r--      3695  31-Jul-2010  14:03:46  org/exist/xquery/modules/math/NoParamFunctions.class
-rw-r--r--      6996  31-Jul-2010  14:03:46  org/exist/xquery/modules/math/OneParamFunctions.class
-rw-r--r--      4522  31-Jul-2010  14:03:46  org/exist/xquery/modules/math/TwoParamFunctions.class
        </markup>
        </programlisting>
</example>

</para>

<para>
We will probably be repackaging all existing extensions to take advantage of this, for now you can test deploying
    eXists own extensions using the <a href="packages/math-example" target="math">Math-1.0.xar</a> which is eXist's own math module
    repackaged up using .xar.
    <ul>
        <li>Math-1.0 <a href="packages/math-1.0.xar?install=true" target="install">install</a> | <a href="packages/math-1.0.xar?remove=true" target="remove">remove</a> </li>
    </ul>

Once you have installed and restarted eXist you should now be able to use math functions.    
<example>
            <title>List existing packages</title>
            <programlisting>
            <markup>
import module namespace math="http://exist-db.org/xquery/math";

math:pi()
            </markup>
            </programlisting>
    <a href="/exist/rest/db?_query=import module namespace math='http://exist-db.org/xquery/math';math:pi()" target="_example">click here to test math function</a>

</example>

</para>
    </section>

     <section>
        <title>Using Repository from XQuery</title>
<para>
 The repository includes an extension module which provides three functions for programmatically controlling repository
    from XQuery
</para>
         <section>
            <title>repo:list()</title>
<para>
    The repo:list() function returns a sequence of strings containing the names of installed packages.

    <example>
			<title>List existing packages</title>
			<programlisting>
			<markup>
import module namespace repo="http://exist-db.org/xquery/repo";

repo:list()
            </markup>
			</programlisting>
        <a href="list-repo.xqy" target="_example">click here to list packages in repository</a>
        </example>

</para>
 </section>
 <section>
            <title>repo:install( URI )</title>
    <para>
        The repo:install() function returns a boolean value indicating success or failure of installation.

        <example>
			<title>Install existing packages</title>
			<programlisting>
			<markup>
import module namespace repo="http://exist-db.org/xquery/repo";

repo:install('http://127.0.0.1:8080/exist/repo/packages/functx-1.0.xar')
            </markup>
			</programlisting>
            <a href="install-functx.xqy" target="_example">click here to install functx</a>
</example>
 </para>
</section>

<section>
            <title>repo:remove( package name )</title>
    <para>
        The repo:remove() function returns a sequence of strings containing the names of installed packages.

        <example>
			<title>Remove existing packages</title>
			<programlisting>
			<markup>
import module namespace repo="http://exist-db.org/xquery/repo";

repo:remove('functx-1.0')
            </markup>
			</programlisting>
            <a href="remove-functx.xqy" target="_example">click here to remove functx</a>

</example>
 </para>
<para>
 <important>
    <para>These functions will soon be usable only by DBA user, as we are still developing they will be
    available by guest user for short period of time.</para>
</important>
</para>
 </section>

    </section>

    <section>
        <title>Resources</title>
        <ul>
            <li><a href="http://expath.org/modules/pkg.html" target="_resource">Expath Package Specification</a>: Community defined specification</li>
            <li><a href="http://expath.org/modules/pkg/" target="_resource">Expath Packaging Documentation</a>: Information on vendor specific expath repository implementations.</li>
        </ul>
    </section>

    <section>
        <title>FAQ</title>
        <section>
            <title>Why do we need package management ?</title>
        <para>Dependency management is difficult, but its also important to gaurd against 'bloat'. Over the coming weeks/months we will
        be exporting functionality into third party .xar packages and it will reduce eXist core as well make it easy for you 
        to create and distribute your own libraries and applications.</para>
        </section>
        <section>
            <title>Where is the package repository located ?</title>
        <para>The repository gets created under the webapp/WEB-INF/expathrepo directory, alternatively it will use the directory stored in java.io.tmp directory to install the repository.</para>
        </section>
        <section>
            <title>Can I interact with the repository from the commandline ?</title>
        <para>Yes, currently you can run the expath package jar commandline utility againt the eXist package repository. In the future
            we may extend the expath package specification to suit eXist needs which may make it incompatible. In addition you can use
            eXist Apache Ant <a href="http://127.0.0.1:8080/exist/ant-tasks.xml#N1041F" target="ant">xdb:query</a> Task to install and remove packages.
        </para>
        </section>    
        <section>
            <title>Can we use package types other then XQuery modules ?</title>
        <para>Currently we are focused on making XQuery module packages, though in the near future we should be able to deploy full applications
            with xproc, schema, data, resources, as well as java jars.</para>
        </section>

        <section>
            <title>I want to make my own .xar package</title>
        <para>Its very easy to package up your own XQuery modules to create a .xar format. Essentially you need to define expath-pkg.xml
        file which describes the package, then include the libraries then zip it up and give it a .xar extension. You can unzip
        the webapp/repo/packages/functx-1.0.xar package as an example or review the expath <a href="http://expath.org/modules/pkg.html" target="spec">specification</a>. </para>
        </section>
        <section>
            <title>I want more developer information</title>
        <para>You can find more information in the sourcecode README at extensions/modules/src/org.exist.modules/expathrepo/readme.txt.</para>
        </section>
</section>
</chapter>
    
</book>

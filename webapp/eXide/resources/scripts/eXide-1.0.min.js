define("eXide/mode/xquery_highlight_rules",function(a,b){var c=a("ace/lib/oop"),f=a("ace/lib/lang"),d=a("ace/mode/text_highlight_rules").TextHighlightRules,e=function(){var d=f.arrayToMap("return for let where order by declare function variable xquery version option namespace import module switch default map if then else as and or typeswitch case ascending descending empty in".split(" "));this.$rules={start:[{token:"text",regex:"<\\!\\[CDATA\\[",next:"cdata"},{token:"xml_pe",regex:"<\\?.*?\\?>"},
{token:"comment",regex:"<\\!--",next:"comment"},{token:"comment",regex:"\\(:",next:"comment"},{token:"text",regex:"<\\/?",next:"tag"},{token:"constant",regex:"[+-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"variable",regex:"\\$[a-zA-Z_][a-zA-Z0-9_\\-:]*\\b"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"},{token:"text",regex:"\\s+"},{token:"comment",regex:"\\%\\w[\\w+_\\-:]+\\b"},{token:"support.function",regex:"\\w[\\w+_\\-:]+(?=\\()"},{token:"keyword.operator",regex:"\\*|=|<|>|\\-|\\+|and|or|eq|ne|lt|gt"},
{token:"lparen",regex:"[[({]"},{token:"rparen",regex:"[\\])}]"},{token:function(a){return d[a]?"keyword":"identifier"},regex:"[a-zA-Z_$][a-zA-Z0-9_$]*\\b"}],tag:[{token:"text",regex:">",next:"start"},{token:"keyword",regex:"[-_a-zA-Z0-9:]+"},{token:"text",regex:"\\s+"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"}],cdata:[{token:"text",regex:"\\]\\]>",next:"start"},{token:"text",regex:"\\s+"},{token:"text",regex:"(?:[^\\]]|\\](?!\\]>))+"}],comment:[{token:"comment",regex:".*?--\>",
next:"start"},{token:"comment",regex:".*:\\)",next:"start"},{token:"comment",regex:".+"}]}};c.inherits(e,d);b.XQueryHighlightRules=e});
define("eXide/mode/behaviour/xquery",function(a,b){var c=a("ace/lib/oop"),f=a("ace/mode/behaviour").Behaviour,d=a("ace/mode/behaviour/cstyle").CstyleBehaviour,e=function(a){this.inherit(d,["braces","parens","string_dquotes"]);this.parent=a;this.add("brackets","insertion",function(d,a,f,e,b){return"\n"==b&&(a=f.getCursorPosition(),"</"==e.doc.getLine(a.row).substring(a.column,a.column+2))?(d=this.$getIndent(e.doc.getLine(a.row))+e.getTabString(),e=this.$getIndent(e.doc.getLine(a.row)),{text:"\n"+d+
"\n"+e,selection:[1,d.length,1,d.length]}):!1});this.add("comments","insertion",function(d,a,e,f,b){d=e.getCursorPosition();f=f.doc.getLine(d.row);if("\n"==b&&f.match(/^[\(\s]:/))return{text:"\n : ",selection:[1,3,1,3]};if(":"==b&&"("==f.substring(d.column-1,1))return $.log("cursor: %d",d.column),{text:":  :",selection:[2,2]}});this.add("slash","insertion",function(d,f,e,b,c){"/"==c&&(d=e.getCursorPosition(),f=b.doc.getLine(d.row),0<d.column&&"<"==f.charAt(d.column-1)&&(f=f.substring(0,d.column)+
"/"+f.substring(d.column),e=b.doc.getAllLines(),e[d.row]=f,a.exec("closeTag",e.join(b.doc.getNewLineCharacter()),d.row)));return!1})};c.inherits(e,f);b.XQueryBehaviour=e});
define("eXide/mode/xquery",function(a,b){var c=a("ace/lib/oop"),f=a("ace/mode/text").Mode,d=a("ace/tokenizer").Tokenizer,e=a("eXide/mode/xquery_highlight_rules").XQueryHighlightRules,g=a("eXide/mode/behaviour/xquery").XQueryBehaviour,h=a("ace/range").Range,i=function(a){this.$tokenizer=new d((new e).getRules());this.$behaviour=new g(a)};c.inherits(i,f);(function(){this.getNextLineIndent=function(d,a,f){d=this.$getIndent(a);a.match(/\s*(?:then|else|return|[{\(]|<\w+>)\s*$/)&&(d+=f);return d};this.checkOutdent=
function(d,a,f){return!/^\s+$/.test(a)?!1:/^\s*[\}\)]/.test(f)};this.autoOutdent=function(d,a,f){d=a.getLine(f).match(/^(\s*[\}\)])/);if(!d)return 0;var d=d[1].length,e=a.findMatchingBracket({row:f,column:d});if(!e||e.row==f)return 0;e=this.$getIndent(a.getLine(e.row));a.replace(new h(f,0,f,d-1),e)};this.$getIndent=function(d){return(d=d.match(/^(\s+)/))?d[1]:""};this.toggleCommentLines=function(d,a,f,e){for(var b=!0,c=/^\s*\(:(.*):\)/,d=f;d<=e;d++)if(!c.test(a.getLine(d))){b=!1;break}for(var g=new h(0,
0,0,0),d=f;d<=e;d++)f=a.getLine(d),g.start.row=d,g.end.row=d,g.end.column=f.length,a.replace(g,b?f.match(c)[1]:"(:"+f+":)")}}).call(i.prototype);b.Mode=i});
define("eXide/mode/behaviour/xml",function(a,b){var c=a("ace/lib/oop"),f=a("ace/mode/behaviour").Behaviour,d=a("ace/mode/behaviour/cstyle").CstyleBehaviour;a("eXide/mode/behaviour/xquery");var e=function(a){this.inherit(d,["braces","parens","string_dquotes"]);this.parent=a;this.add("brackets","insertion",function(d,a,f,e,b){return"\n"==b&&(a=f.getCursorPosition(),"</"==e.doc.getLine(a.row).substring(a.column,a.column+2))?(d=this.$getIndent(e.doc.getLine(a.row))+e.getTabString(),e=this.$getIndent(e.doc.getLine(a.row)),
{text:"\n"+d+"\n"+e,selection:[1,d.length,1,d.length]}):!1});this.add("slash","insertion",function(d,f,e,b,c){"/"==c&&(d=e.getCursorPosition(),f=b.doc.getLine(d.row),0<d.column&&"<"==f.charAt(d.column-1)&&(f=f.substring(0,d.column)+"/"+f.substring(d.column),e=b.doc.getAllLines(),e[d.row]=f,a.exec("closeTag",e.join(b.doc.getNewLineCharacter()),d.row)));return!1})};c.inherits(e,f);b.XMLBehaviour=e});
define("eXide/mode/xml",function(a,b){var c=a("ace/lib/oop"),f=a("ace/mode/xml").Mode,d=a("ace/tokenizer").Tokenizer,e=a("ace/mode/xml_highlight_rules").XmlHighlightRules,g=a("ace/mode/folding/xml").FoldMode,h=a("eXide/mode/behaviour/xml").XMLBehaviour,i=a("ace/range").Range,j=function(a){this.$tokenizer=new d((new e).getRules());this.$behaviour=new h(a);this.foldingRules=new g};c.inherits(j,f);(function(){this.toggleCommentLines=function(d,a,f,e){for(var b=!0,c=/^\s*<\!--(.*)--\>/,d=f;d<=e;d++)if(!c.test(a.getLine(d))){b=
!1;break}for(var g=new i(0,0,0,0),d=f;d<=e;d++)f=a.getLine(d),g.start.row=d,g.end.row=d,g.end.column=f.length,a.replace(g,b?f.match(c)[1]:"<\!--"+f+"--\>")}}).call(j.prototype);b.Mode=j});
define("eXide/mode/html",function(a,b){var c=a("ace/lib/oop"),f=a("ace/mode/html").Mode,d=a("ace/tokenizer").Tokenizer,e=a("ace/mode/html_highlight_rules").HtmlHighlightRules,g=a("ace/mode/folding/html").FoldMode,h=a("eXide/mode/behaviour/xml").XMLBehaviour,i=a("ace/range").Range,j=a("ace/mode/javascript").Mode,l=a("ace/mode/css").Mode,m=function(a){var f=new e;this.$tokenizer=new d(f.getRules());this.$behaviour=new h(a);this.foldingRules=new g;this.$embeds=f.getEmbeds();this.createModeDelegates({"js-":j,
"css-":l})};c.inherits(m,f);(function(){this.toggleCommentLines=function(d,a,f,e){for(var b=!0,c=/^\s*<\!--(.*)--\>/,d=f;d<=e;d++)if(!c.test(a.getLine(d))){b=!1;break}for(var g=new i(0,0,0,0),d=f;d<=e;d++)f=a.getLine(d),g.start.row=d,g.end.row=d,g.end.column=f.length,a.replace(g,b?f.match(c)[1]:"<\!--"+f+"--\>")}}).call(m.prototype);b.Mode=m});var eXide=eXide||{};eXide.namespace=function(a){var a=a.split("."),b=eXide,c;"eXide"==a[0]&&(a=a.slice(1));for(c=0;c<a.length;c++)"undefined"==typeof b[a[c]]&&(b[a[c]]={}),b=b[a[c]];return b};eXide.namespace("eXide.util");
eXide.util=function(){var a={dir1:"up",dir2:"left",firstpos1:15,firstpos2:15};return{popup:function(a,c,f,d){function e(d){h&&(h.empty(),d.find(".tooltip").each(function(){h.html($(this).html())}))}var g=$(a),h=c?$(c):null,i=null;f.sort(function(d,a){return d.label==a.label?0:d.label>a.label?1:-1});g.empty().css("display","block").focus();a=document.createElement("a");a.href="#";a.className="popup-close";a.appendChild(document.createTextNode("Close"));g.append(a);$(a).click(function(d){d.preventDefault();
g.css("display","none");h&&h.css("display","none")});a=document.createElement("ul");for(c=0;c<f.length;c++){var j=document.createElement("li");0==c&&(j.className="first");j.appendChild(document.createTextNode(f[c].label));if(f[c].tooltip){var l=document.createElement("span");l.className="tooltip";l.appendChild(document.createTextNode(f[c].tooltip));j.appendChild(l)}a.appendChild(j);$(j).click(function(){i.removeClass("selection");$(this).addClass("selection");i=$(this);e(i)});$(j).dblclick(function(){var a=
g.find("li").index(i);g.css("display","none");h&&h.css("display","none");d.call(null,f[a])})}g.append(a);i=g.find("ul li:first").addClass("selection");e(i);var m=$(a).css("position","absolute").scrollTop(0);h&&h.css({display:"block",top:m.offset().top+"px"});var n=m.innerHeight();$(g).keydown(function(a){a.preventDefault();if(40==a.which)a=i.next(),0<a.length&&(i.removeClass("selection"),a.addClass("selection"),i=a,a.position().top+a.height()>=n&&a.get(0).scrollIntoView(),e(a));else if(38==a.which)a=
i.prev(),0<a.length&&(i.removeClass("selection"),a.addClass("selection"),i=a,a.hasClass("first")?m.scrollTop(0):0>a.position().top&&a.get(0).scrollIntoView(),e(a));else if(13==a.which){var b=g.find("li").index(i);g.css("display","none");h&&h.css("display","none");$(g).unbind(a);d.call(null,f[b])}else return g.css("display","none"),h&&h.css("display","none"),$(g).unbind(a),d.call(null,null),!0;return!1})},supportsHtml5Storage:function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}},
normalizePath:function(a){for(var a=a.replace(/^xmldb:exist:\/\//,""),c=[],a=a.split("/"),f=a.length-1;-1<f;f--)".."==a[f]?f--:c.push(a[f]);return c.reverse().join("/")},parseSignature:function(a){var c=a.indexOf("(");if(-1<c){var f=a.substring(0,c+1),a=a.substring(c);if(a=a.match(/\$[\w:-_]+/g))for(c=0;c<a.length;c++)0<c&&(f+=", "),f+=a[c];return f+")"}return a},message:function(b){$.pnotify({pnotify_text:b,pnotify_shadow:!0,pnotify_hide:!0,pnotify_closer:!0,pnotify_opacity:0.75,pnotify_addclass:"stack-bottomright",
pnotify_stack:a})},error:function(b,c){var f={pnotify_text:b,pnotify_type:"error",pnotify_shadow:!0,pnotify_hide:!0,pnotify_addclass:"stack-bottomright",pnotify_stack:a};c&&(f.pnotify_title=c);$.pnotify(f)}}}();eXide.namespace("eXide.util.Dialog");
eXide.util.Dialog=function(){var a,b=null;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-message">\t<img id="eXide-dialog-message-icon" src="resources/images/error.png"/>\t<div id="eXide-dialog-message-body"></div></div>');a=$("#eXide-dialog-message");a.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close")}}});$(document.body).append('<div id="eXide-dialog-input">\t<img id="eXide-dialog-input-icon" src="resources/images/information.png"/>\t<div id="eXide-dialog-input-body"></div></div>');
inputDialog=$("#eXide-dialog-input");inputDialog.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close");null!=b&&b.apply($("eXide-dialog-input-body"),[])},Cancel:function(){$(this).dialog("close")}}})});return{message:function(c,f){null==f&&(f="");a.dialog("option","title",c);$("#eXide-dialog-message-body").html(f);$("#eXide-dialog-message-icon").attr("src","resources/images/information.png");a.dialog("open")},warning:function(c,f){null==f&&(f="");a.dialog("option","title",c);
$("#eXide-dialog-message-body").html(f);$("#eXide-dialog-message-icon").attr("src","resources/images/error.png");a.dialog("open")},input:function(a,f,d){b=d;inputDialog.dialog("option","title",a);$("#eXide-dialog-input-body").html(f);inputDialog.dialog("open")}}}();eXide.namespace("eXide.util.mimeTypes");
eXide.util.mimeTypes=function(){var a={xml:["text/xml","application/xml","application/xhtml+xml","application/atom+xml"],xquery:["application/xquery"],css:["text/css"],html:["text/html"],javascript:["application/x-javascript"],text:["text/text"],less:["application/less"]};return{getMime:function(a){var c=a.indexOf(";");-1<c&&(a=a.substring(0,c));return a},getLangFromMime:function(b){for(var c in a)for(var f=a[c],d=0;d<f.length;d++)if(b==f[d])return c;return"xquery"},getMimeFromLang:function(b){return(b=
a[b])?b[0]:"application/xquery"}}}();eXide.namespace("eXide.util.oop");eXide.util.oop.inherit=function(){var a=function(){};return function(b,c){a.prototype=c.prototype;b.prototype=new a;b.super_=c.prototype;b.prototype.constructor=b}}();eXide.util.oop.extend=function(){return function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}}();(function(a){a.log=function(){window.console&&window.console.log&&console.log.apply(window.console,arguments)};a.fn.log=function(){a.log(this);return this}})(jQuery);eXide.namespace("eXide.events.Sender");eXide.events.Sender=function(){Constr=function(){};Constr.prototype={addEventListener:function(a,b,c){this.events=this.events||{};var f=this.events[a];f||(f=[],this.events[a]=f);f.push({obj:b,callback:c})},$triggerEvent:function(a,b){this.events=this.events||{};var c=this.events[a];if(c)for(var f=0;f<c.length;f++)c[f].callback.apply(c[f].obj,b)}};return Constr}();eXide.namespace("eXide.edit.commands");
eXide.edit.commands=function(){function a(a,f){return{win:a,mac:f,sender:"editor"}}var b=require("ace/lib/useragent");return{init:function(c){var f=c.editor.commands;f.addCommand({name:"fold",bindKey:a("Alt-L","Alt-F"),exec:function(d){d.editor.session.toggleFold(!1)},readOnly:!0});f.addCommand({name:"unfold",bindKey:a("Alt-Shift-L","Alt-Shift-F"),exec:function(d){d.editor.session.toggleFold(!0)},readOnly:!0});f.addCommand({name:"saveDocument",bindKey:a("Ctrl-Shift-S","Command-Shift-S"),exec:function(){eXide.app.saveDocument()}});
f.addCommand({name:"runQuery",bindKey:a("Ctrl-Return","Command-Return"),exec:function(){eXide.app.runQuery()}});f.addCommand({name:"openDocument",bindKey:a("Ctrl-Shift-O","Command-Shift-O"),exec:function(){eXide.app.openDocument()}});f.addCommand({name:"newDocument",bindKey:a("Ctrl-Shift-N","Command-Shift-N"),exec:function(){eXide.app.newDocument()}});f.addCommand({name:"closeDocument",bindKey:a("Ctrl-Shift-W","Command-Shift-W"),exec:function(){eXide.app.closeDocument()}});f.addCommand({name:"autocomplete",
bindKey:a("Ctrl-Space","Ctrl-Space"),exec:function(){c.autocomplete()}});f.addCommand({name:"nextTab",bindKey:a("Ctrl-Shift-PageDown","Command-Shift-PageDown"),exec:function(){c.nextTab()}});f.addCommand({name:"previousTab",bindKey:a("Ctrl-Shift-PageUp","Command-Shift-PageUp"),exec:function(){c.previousTab()}});f.addCommand({name:"functionDoc",bindKey:a("F1","F1"),exec:function(){c.exec("showFunctionDoc")}});f.addCommand({name:"gotoDefinition",bindKey:a("F3","F3"),exec:function(){c.exec("gotoDefinition")}});
f.addCommand({name:"searchIncremental",bindKey:a("Ctrl-F","Command-F"),exec:function(){c.quicksearch.start()}});f.addCommand({name:"findModule",bindKey:a("F4","F4"),exec:function(){var d=c.getActiveDocument();eXide.find.Modules.select(d.syntax)}});f.addCommand({name:"indentOrParam",bindKey:a("Tab","Tab"),exec:function(){var d=c.getActiveDocument();(!d.template||!d.template.nextParam())&&c.editor.indent()}});f.addCommand({name:"escape",bindKey:a("Esc","Esc"),exec:function(){c.getActiveDocument().template=
null;c.editor.clearSelection()}});f.addCommand({name:"dbManager",bindKey:a("Ctrl-Shift-M","Command-Shift-M"),exec:function(){eXide.app.manage()}});f.addCommand({name:"toggleComment",bindKey:a("Ctrl-Shift-C","Command-Shift-C"),exec:function(){c.editor.toggleCommentLines()}})},help:function(a,f){$(a).find("table").each(function(){this.innerHTML="";var d=f.editor.commands;for(key in d.commands){var a=d.commands[key],c=document.createElement("tr"),h=document.createElement("td");h.appendChild(document.createTextNode(a.name));
c.appendChild(h);h=document.createElement("td");a.bindKey&&(b.isMac?h.appendChild(document.createTextNode(a.bindKey.mac)):h.appendChild(document.createTextNode(a.bindKey.win)));c.appendChild(h);this.appendChild(c)}})}}}();eXide.namespace("eXide.edit.ModeHelper");eXide.edit.ModeHelper=function(){Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.commands={}};Constr.prototype={addCommand:function(a,b){this.commands||(this.commands={});this.commands[a]=b},exec:function(a,b,c){if(this.commands&&this.commands[a]){for(var b=[b],f=0;f<c.length;f++)b.push(c[f]);$.log("Calling command %s ...",a);this.commands[a].apply(this,b)}else eXide.util.message("Not supported in this mode.")}};return Constr}();eXide.namespace("eXide.edit.XQueryModeHelper");
eXide.edit.XQueryModeHelper=function(){function a(a){var d;d=a.line?a["#text"]:a;var e=c.exec(d),b=-1;e?b=parseInt(e[1])-1:a.line&&(b=parseInt(a.line)-1);return{line:b,msg:d}}var b=/^[\$\w:\-_\.]+/;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("showFunctionDoc",this.showFunctionDoc);this.addCommand("gotoDefinition",this.gotoDefinition);this.addCommand("locate",this.locate);this.addCommand("closeTag",this.closeTag);this.addCommand("importModule",this.importModule)};
eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.closeTag=function(f,d,e){var f="xmldb:exist://"+f.getBasePath(),c=this;$.ajax({type:"POST",url:"modules/compile.xql",data:{q:d,base:f},dataType:"json",success:function(d){"fail"==d.result&&(d=a(d.error),d.line<=e&&(d=/constructor:\s(.*)$/.exec(d.msg),0<d.length&&c.editor.insert(d[1]+">")))},error:function(){}})};Constr.prototype.validate=function(a,d,e){$.log("Running validation...");var c=this,b="xmldb:exist://"+a.getBasePath();
$.ajax({type:"POST",url:"modules/compile.xql",data:{q:d,base:b},dataType:"json",success:function(d){c.compileError(d,a);e.call(this,!0)},error:function(d,a){e.call(this,!0);$.log("Compile error: %s - %s",a,d.responseText)}})};Constr.prototype.compileError=function(f,d){if("fail"==f.result){var e=a(f.error),c=[{row:e.line,text:e.msg,type:"error"}];this.parent.updateStatus(e.msg,d.getPath()+"#"+e.line);d.getSession().setAnnotations(c)}else this.parent.clearErrors(),this.parent.updateStatus("")};Constr.prototype.autocomplete=
function(a){require("pilot/lang");for(var d=require("ace/range").Range,e=this.editor.getSelection(),c=a.getSession(),e=e.getSelectionLead(),c=c.getDisplayLine(e.row),b=e.column-1,i=e.column;0<=b;){var j=c.substring(b,i);if(j.match(/^\$[\w:\-_\.]+$/))break;if(!j.match(/^[\w:\-_\.]+$/)){b++;break}b--}c=c.substring(b,i);$.log("completing token: %s",c);d=new d(e.row,b,e.row,i);e=this.editor.renderer.textToScreenCoordinates(e.row,e.column);b=this.parent.getHeight();e.pageY+150>b&&(e.pageY=b-150,$.log("window height: %i, pageY: %i",
b,e.pageY));$("#autocomplete-box").css({left:e.pageX+"px",top:e.pageY+10+"px"});$("#autocomplete-help").css({left:e.pageX+324+"px",top:e.pageY+10+"px"});0==c.length?this.templateLookup(a,c,d,!0):this.functionLookup(a,c,d,!0);return!0};Constr.prototype.$localVars=function(a,d){for(var e=[],c=/declare function|};/,b=/let \$[\w\:]+|for \$[\w\:]+|\$[\w\:]+\)/,i=/\$[\w\:]+/,j=RegExp("^\\"+a),l=this.editor.getSession(),m=d.start.row;-1<m;){var n=l.getDisplayLine(m),o;if(o=n.match(b))$.log("Var: %s",o[0]),
o=o[0].match(i),o[0].match(j)&&e.push({name:o[0],type:"variable"});if(n.match(c)){$.log("Stop: %s",n);break}m--}return e};Constr.prototype.functionLookup=function(a,d,e,c){var b=this;$.ajax({url:"modules/docs.xql",dataType:"text",type:"POST",data:{prefix:d},success:function(i){var i=$.parseJSON(i),j=[],l;"$"==d.substring(0,1)?(l="^\\"+d,j=b.$localVars(d,e,c)):l="^"+d;var m=RegExp(l);$.each(a.functions,function(d,a){a.name.match(m)&&j.push(a)});i&&(j=j.concat(i));i=[];for(l=0;l<j.length;l++){var n=
{label:j[l].signature?j[l].signature:j[l].name,type:j[l].type};j[l].help&&(n.tooltip=j[l].help);i.push(n)}b.$addTemplates(d,i);b.$showPopup(a,e,i)},error:function(d,a){eXide.util.error(a)}})};Constr.prototype.templateLookup=function(a,d,e){var c=[];this.$addTemplates(d,c);this.$showPopup(a,e,c)};Constr.prototype.$addTemplates=function(a,d){for(var e=this.parent.outline.getTemplates(a),c=0;c<e.length;c++)d.push({type:"template",label:"[S] "+e[c].name,tooltip:e[c].help,template:e[c].template})};Constr.prototype.$showPopup=
function(a,d,e){var c=this;eXide.util.popup($("#autocomplete-box"),$("#autocomplete-help"),e,function(e){if(e){var b=e.label;"template"==e.type?b=e.template:"function"==e.type&&(b=eXide.util.parseSignature(b));a.template=new eXide.edit.Template(c.parent,d,b,e.type);a.template.insert()}c.editor.focus()})};Constr.prototype.getFunctionAtCursor=function(a){var d=a.row,d=this.editor.getSession().getDisplayLine(d),e=a.column;do e--;while(0<=e&&d.charAt(e).match(b));e++;for(a=a.column;a<d.length&&d.charAt(a).match(b);)a++;
return d.substring(e,a)};Constr.prototype.showFunctionDoc=function(a){var d=this.editor.getSelection().getSelectionLead(),e=this.editor.renderer.textToScreenCoordinates(d.row,d.column);$("#autocomplete-box").css({left:e.pageX+"px",top:e.pageY+20+"px"});$("#autocomplete-help").css({left:e.pageX+324+"px",top:e.pageY+20+"px"});d=this.getFunctionAtCursor(d);this.functionLookup(a,d,null,!1)};Constr.prototype.gotoDefinition=function(a){var d=this.getFunctionAtCursor(this.editor.getSelection().getSelectionLead());
d&&this.parent.outline.gotoDefinition(a,d)};Constr.prototype.locate=function(a,d,e){switch(d){case "function":this.gotoFunction(a,e);break;default:this.gotoVarDecl(a,e)}};Constr.prototype.gotoFunction=function(a,d){$.log("Goto function %s",d);var e=this.getModuleNamespacePrefix();null!=e&&(d=d.replace(/[^:]+:/,e+":"));for(var e=RegExp("function\\s+"+d+"\\s*\\("),c=a.$session.getLength(),b=0;b<c;b++)if(a.$session.getLine(b).match(e)){this.editor.gotoLine(b+1);this.editor.focus();break}};Constr.prototype.gotoVarDecl=
function(a,d){var e=this.getModuleNamespacePrefix();null!=e&&(d=d.replace(/[^:]+:/,"$"+e+":"));$.log("Goto variable declaration %s",d);for(var e=RegExp("variable\\s+\\"+d),c=a.$session.getLength(),b=0;b<c;b++)if(a.$session.getLine(b).match(e)){this.editor.gotoLine(b+1);this.editor.focus();break}};Constr.prototype.getModuleNamespacePrefix=function(){for(var a=/^\s*module\s+namespace\s+([^=\s]+)\s*=/,d=this.parent.getActiveDocument().$session.getLength(),e=0;e<d;e++){var c=this.parent.getActiveDocument().$session.getLine(e).match(a);
if(c)return c[1]}return null};Constr.prototype.importModule=function(a,d,e,c){$.log("location = %s path = %s",c,a.path);a=a.getBasePath();c=0===c.lastIndexOf(a,0)?c.substring(a.length+1):"xmldb:exist://"+c;this.editor.insert("import module namespace "+d+'="'+e+'" at "'+c+'";\n')};var c=/.*line:?\s(\d+)/i;return Constr}();eXide.namespace("eXide.edit.XMLModeHelper");
eXide.edit.XMLModeHelper=function(){Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("closeTag",this.closeTag)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.closeTag=function(a,b,c){a.getBasePath();var f=this;$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:b},dataType:"json",success:function(a){a.status&&"invalid"==a.status&&parseInt(a.message.line)-1<=c&&(a=/element type \"([^\"]+)\"/.exec(a.message["#text"]),0<a.length&&f.editor.insert(a[1]+
">"))},error:function(){}})};Constr.prototype.validate=function(a,b,c){var f=this;$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:b},dataType:"json",success:function(d){f.compileError(d,a);c.call(this,!0)},error:function(a,e){c.call(this,!0);$.log("Compile error: %s - %s",e,a.responseText)}})};Constr.prototype.compileError=function(a,b){$.log("Validation returned %o",a);if(a.status&&"invalid"==a.status){var c=[{row:parseInt(a.message.line)-1,text:a.message["#text"],type:"error"}];$.log("annotation: %o",
c);this.parent.updateStatus(a.message["#text"],b.getPath()+"#"+a.message.line);b.getSession().setAnnotations(c)}else this.parent.clearErrors(),this.parent.updateStatus("")};return Constr}();eXide.namespace("eXide.edit.LessModeHelper");
eXide.edit.LessModeHelper=function(){Constr=function(a){this.parent=a;this.editor=this.parent.editor};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.documentSaved=function(a){var b=this,c=a.getText();(new less.Parser).parse(c,function(c,d){if(c)return $.error(c);b.saveCSS(a,d.toCSS())})};Constr.prototype.saveCSS=function(a,b){var c=a.getPath().replace(/\.less$/,".css");eXide.util.message("Compiling less file to "+c);$.ajax({url:"modules/store.xql",type:"POST",data:{path:c,data:b,
mime:"text/css"},dataType:"json",success:function(a){"error"==a.status?eXide.util.error(a.message):eXide.util.message(c+" stored.")},error:function(a){eXide.util.error(a.responseText)}})};return Constr}();eXide.namespace("eXide.edit.Outline");
eXide.edit.Outline=function(){Constr=function(){this.funcDefRe=/declare\s+(?:%(\w+)\s+)?function\s+([^\(]+)\(/g;this.varDefRe=/declare\s+(?:%\w+\s+)?variable\s+\$[^\s;]+/gm;this.varRe=/declare\s+(?:%\w+\s+)?variable\s+(\$[^\s;]+)/;this.parseImportRe=/import\s+module\s+namespace\s+[^=]+\s*=\s*["'][^"']+["']\s*at\s+["'][^"']+["']\s*;/g;this.moduleRe=/import\s+module\s+namespace\s+([^=\s]+)\s*=\s*["']([^"']+)["']\s*at\s+["']([^"']+)["']\s*;/;this.currentDoc=null;this.templates=[];this.$loadTemplates()};
Constr.prototype={getTemplates:function(a){for(var a=RegExp("^"+a),b=[],c=0;c<this.templates.length;c++)this.templates[c].name.match(a)&&b.push(this.templates[c]);return b},gotoDefinition:function(a,b){$.each(a.functions,function(a,f){b==f.name&&eXide.app.locate(f.type,""==f.source?null:f.source,b)})},updateOutline:function(a){this.currentDoc=a;a.functions=[];$("#outline").empty();if("application/xquery"==a.getMime()){var b=a.getText();this.$parseLocalFunctions(b,a);this.$outlineUpdate(a);(b=this.$parseImports(b))&&
this.$resolveImports(a,b)}},clearOutline:function(){$("#outline").empty()},$parseLocalFunctions:function(a,b){for(b.functions=[];;){var c=this.funcDefRe.exec(a);if(null==c)break;var f=this.funcDefRe.lastIndex,d=this.$findMatchingParen(a,f),e=3==c.length?c[2]:c[1];b.functions.push({type:"function",name:e,visibility:3==c.length?c[1]:"public",signature:e+"("+a.substring(f,d)+")"})}if(c=a.match(this.varDefRe))for(f=0;f<c.length;f++)d=this.varRe.exec(c[f]),b.functions.push({type:"variable",name:d[1]})},
$findMatchingParen:function(a,b){for(var c=1,f=b;f<a.length;f++){var d=a.charAt(f);if(")"==d){if(c-=1,0==c)return f}else"("==d&&(c+=1)}return-1},$parseImports:function(a){return a.match(this.parseImportRe)},$resolveImports:function(a,b){for(var c=this,f=[],d=[],e=0;e<b.length;e++){var g=this.moduleRe.exec(b[e]);null!=g&&4==g.length&&(d.push("prefix="+encodeURIComponent(g[1])),d.push("uri="+encodeURIComponent(g[2])),d.push("source="+encodeURIComponent(g[3])))}e="xmldb:exist://"+a.getBasePath();d.push("base="+
encodeURIComponent(e));$.ajax({url:"outline",dataType:"json",type:"POST",data:d.join("&"),success:function(d){if(null!=d){for(var d=d.modules,e=0;e<d.length;e++){var b=d[e].functions;if(b)for(var g=0;g<b.length;g++)f.push({type:"function",name:b[g].name,signature:b[g].signature,visibility:b[g].visibility,source:d[e].source});if(b=d[e].variables)for(g=0;g<b.length;g++)f.push({type:"variable",name:"$"+b[g],source:d[e].source})}a.functions=a.functions.concat(f);c.$outlineUpdate(a)}}});return f},$sortFunctions:function(a){a.functions.sort(function(a,
c){return a.name==c.name?0:a.name>c.name?1:-1})},$outlineUpdate:function(a){this.$sortFunctions(a);if(this.currentDoc==a){$("body").layout();eXide.app.resize();var b=$("#outline");b.empty();for(var c=0;c<a.functions.length;c++){var f=a.functions[c],d=document.createElement("li"),e=document.createElement("a");f.signature&&(e.title=f.signature);var g=$(e);"function"==f.type?g.addClass("t_function"):g.addClass("t_variable");e.href=f.source?"#"+f.source:"#";"private"===f.visibility?g.addClass("private"):
g.addClass("public");e.appendChild(document.createTextNode(f.name));d.appendChild(e);b.append(d);g.click(function(){var a=this.hash.substring(1);$(this).hasClass("t_function")?eXide.app.locate("function",a==""?null:a,$(this).text()):eXide.app.locate("variable",a==""?null:a,$(this).text());return false})}}},$loadTemplates:function(){var a=this;$.ajax({url:"templates/snippets.xml",dataType:"xml",type:"GET",success:function(b){$(b).find("snippet").each(function(){var c=$(this),b=c.attr("abbrev"),d=c.find("description").text(),
c=c.find("code").text();a.templates.push({TYPE:"template",name:b,help:d,template:c})})}})}};return Constr}();eXide.namespace("eXide.edit.Document");
eXide.edit.Document=function(){Constr=function(a,b,c){this.name=a;this.path=b;this.mime=null;this.syntax="xquery";this.saved=!1;this.editable=!0;this.functions=[];this.helper=null;this.history=[];this.$session=c;a=eXide.app.getPreference("softWrap");this.$session.setUseWrapMode(0!=a);0<a?this.$session.setWrapLimitRange(a,a):0>a&&this.$session.setWrapLimitRange(null,null);this.$session.setFoldStyle("markbegin")};Constr.prototype.getText=function(){return this.$session.getValue()};Constr.prototype.getName=
function(){return this.name};Constr.prototype.getPath=function(){return this.path};Constr.prototype.setPath=function(a){this.path=a};Constr.prototype.getBasePath=function(){return this.path.replace(/(^.+)\/[^\/]*$/,"$1")};Constr.prototype.getMime=function(){return this.mime};Constr.prototype.getSyntax=function(){return this.syntax};Constr.prototype.setSyntax=function(a){this.syntax=a};Constr.prototype.getSession=function(){return this.$session};Constr.prototype.isSaved=function(){return this.saved};
Constr.prototype.isEditable=function(){return this.editable};Constr.prototype.isXQuery=function(){return"application/xquery"==this.mime};Constr.prototype.setModeHelper=function(a){this.helper=a};Constr.prototype.getModeHelper=function(){return this.helper};Constr.prototype.addToHistory=function(a){this.history.push(a)};Constr.prototype.getLastLine=function(){return this.history.pop(line)};Constr.prototype.getCurrentLine=function(){return this.$session.getSelection().getSelectionLead().row};return Constr}();
eXide.namespace("eXide.edit.Editor");
eXide.edit.Editor=function(){var a=require("ace/virtual_renderer").VirtualRenderer,b=require("ace/editor").Editor,c=require("ace/edit_session").EditSession,f=require("ace/undomanager").UndoManager;Constr=function(d){var e=this;e.container=d;e.documents=[];e.activeDoc=null;e.tabCounter=0;e.newDocCounter=0;e.pendingCheck=!1;e.themes={};d=new a(e.container,"ace/theme/eclipse");d.setShowGutter(!0);this.editor=new b(d);this.editor.setBehavioursEnabled(!0);this.editor.setShowFoldWidgets(!0);this.editor.setFadeFoldWidgets(!1);
eXide.edit.commands.init(e);this.outline=new eXide.edit.Outline;this.addEventListener("activate",this.outline,this.outline.updateOutline);this.addEventListener("validate",this.outline,this.outline.updateOutline);this.addEventListener("close",this.outline,this.outline.clearOutline);this.status=document.getElementById("error-status");$(this.status).click(function(a){a.preventDefault();var d=this.pathname,a=this.hash.substring(1);if(d=e.getDocument(d))e.switchTo(d),e.editor.gotoLine(parseInt(a)+1)});
this.quicksearch=new eXide.find.IncrementalSearch($("#search-box"),this.editor);$("#tab-next").button({icons:{primary:"ui-icon-triangle-1-e"},text:!1}).click(function(){e.nextTab()});$("#tab-prev").button({icons:{primary:"ui-icon-triangle-1-w"},text:!1}).click(function(){e.previousTab()});this.lastChangeEvent=(new Date).getTime();this.validateTimeout=null;e.modes={xquery:new eXide.edit.XQueryModeHelper(e),xml:new eXide.edit.XMLModeHelper(e),html:new eXide.edit.XMLModeHelper(e),less:new eXide.edit.LessModeHelper(e)}};
eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.init=function(){0==this.documents.length&&this.newDocument()};Constr.prototype.exec=function(){if(this.activeDoc.getModeHelper()){var a=Array.prototype.slice.call(arguments,1);this.activeDoc.getModeHelper().exec(arguments[0],this.activeDoc,a)}else eXide.util.message("Not supported in this mode.")};Constr.prototype.getActiveDocument=function(){return this.activeDoc};Constr.prototype.getText=function(){return this.activeDoc.getText()};
Constr.prototype.newDocument=function(a,e){for(var b=0,f=0;f<this.documents.length;f++)this.documents[f].path.match(/^__new__(\d+)/)&&(b=parseInt(RegExp.$1));b++;f=a&&"string"==typeof a?new c(a):e&&"xquery"===e?new c('xquery version "3.0";\n'):new c("");b=new eXide.edit.Document("new-document "+b,"__new__"+b,f);e?b.setSyntax(e):b.setSyntax("text");this.$initDocument(b)};Constr.prototype.newDocumentWithText=function(a,e,b){a=new eXide.edit.Document(b.name,b.path,new c(a));a.editable=b.writable;a.mime=
e;a.syntax=eXide.util.mimeTypes.getLangFromMime(e);a.saved=!1;b.line&&(a.addToHistory(b.line),this.editor.gotoLine(b.line));this.$initDocument(a)};Constr.prototype.openDocument=function(a,e,b){b.writable?eXide.util.message("Opening "+b.path):eXide.util.message("Opening "+b.path+" readonly!");a=new eXide.edit.Document(b.name,b.path,new c(a));a.editable=b.writable;a.mime=e;a.syntax=eXide.util.mimeTypes.getLangFromMime(e);a.saved=!0;b.line&&(a.addToHistory(b.line),e=a.$session.getSelection(),e.clearSelection(),
e.moveCursorTo(b.line,1),a.$session.setScrollTop(b.line));$.log("opening %s, mime: %s, syntax: %s, line: %i",b.name,a.mime,a.syntax,b.line);this.$initDocument(a)};Constr.prototype.$initDocument=function(a){var e=this;e.$setMode(a,!1);a.$session.setUndoManager(new f);a.$session.addEventListener("change",function(){a.saved&&(a.saved=!1,e.updateTabStatus(a.path,a));e.triggerCheck()});e.addTab(a);e.editor.setSession(a.$session);e.editor.resize();e.editor.focus()};Constr.prototype.setMode=function(a){this.activeDoc.syntax=
a;this.$setMode(this.activeDoc,!0)};Constr.prototype.$setMode=function(a,e){switch(a.getSyntax()){case "xquery":var b=require("eXide/mode/xquery").Mode;a.$session.setMode(new b(this));e&&(a.mime="application/xquery");break;case "xml":b=require("eXide/mode/xml").Mode;a.$session.setMode(new b(this));e&&(a.mime="application/xml");break;case "html":b=require("eXide/mode/html").Mode;a.$session.setMode(new b(this));e&&(a.mime="text/html");break;case "javascript":b=require("ace/mode/javascript").Mode;a.$session.setMode(new b);
e&&(a.mime="application/x-javascript");break;case "css":b=require("ace/mode/css").Mode;a.$session.setMode(new b);e&&(a.mime="text/css");break;case "text":b=require("ace/mode/text").Mode,a.$session.setMode(new b),e&&(a.mime="text/text");case "less":b=require("ace/mode/less").Mode,a.$session.setMode(new b),e&&(a.mime="application/less")}a.setModeHelper(this.modes[a.getSyntax()])};Constr.prototype.closeDocument=function(){this.$triggerEvent("close",[this.activeDoc]);$('#tabs a[title="'+this.activeDoc.path+
'"]').parent().remove();for(var a=0;a<this.documents.length;a++)this.documents[a].path==this.activeDoc.path&&this.documents.splice(a,1);0==this.documents.length?this.newDocument():(this.activeDoc=this.documents[this.documents.length-1],$('#tabs a[title="'+this.activeDoc.path+'"]').addClass("active"),this.editor.setSession(this.activeDoc.$session),this.editor.resize(),this.$triggerEvent("activate",[this.activeDoc]))};Constr.prototype.saveDocument=function(a,e,b){var c=this,f=c.activeDoc.path,j=c.activeDoc.name;
a&&(c.activeDoc.path=a.path,c.activeDoc.name=a.name);eXide.util.message("Storing resource "+c.activeDoc.name+"...");a={path:c.activeDoc.path,data:c.activeDoc.getText()};c.activeDoc.mime&&(a.mime=c.activeDoc.mime);$.ajax({url:"modules/store.xql",type:"POST",data:a,dataType:"json",success:function(a){if(a.status=="error")b?b.apply(c.activeDoc,[a.message]):eXide.util.error(a.message);else{c.activeDoc.saved=true;c.updateTabStatus(f,c.activeDoc);e?e.apply(c.activeDoc):eXide.util.message(c.activeDoc.name+
" stored.");(a=c.activeDoc.getModeHelper())&&a.documentSaved&&a.documentSaved(c.activeDoc)}},error:function(a){c.activeDoc.path=f;c.activeDoc.name=j;b?b.apply(c.activeDoc,a.responseText):eXide.util.error(a.responseText)}})};Constr.prototype.reload=function(a){this.activeDoc.getSession().setValue(a)};Constr.prototype.getDocument=function(a){for(var a=eXide.util.normalizePath(a),b=0;b<this.documents.length;b++)if(this.documents[b].path==a)return this.documents[b]};Constr.prototype.onInput=function(a,
b){var c=a.getModeHelper();if(c&&c.onInput)c.onInput(a,b)};Constr.prototype.autocomplete=function(){var a=this.activeDoc.getModeHelper();a&&a.autocomplete&&a.autocomplete(this.activeDoc)};Constr.prototype.getHeight=function(){return $(this.container).height()};Constr.prototype.resize=function(){this.editor.resize()};Constr.prototype.clearErrors=function(){this.editor.getSession().clearAnnotations()};Constr.prototype.forEachDocument=function(a){for(var b=0;b<this.documents.length;b++)a(this.documents[b])};
Constr.prototype.addTab=function(a){var b=this,c="t"+b.tabCounter++,f=a.name;a.saved||(f+="*");$("#tabs li a").removeClass("active");var i=document.createElement("li"),j=document.createElement("a");j.appendChild(document.createTextNode(f));j.className="tab active";j.id=c;j.title=a.path;i.appendChild(j);$("#tabs").append(i);$(j).click(function(c){c.preventDefault();b.switchTo(a)});b.activeDoc=a;b.documents.push(a);b.$triggerEvent("activate",[a]);b.scrollToTab($(j))};Constr.prototype.nextTab=function(){if(!(2>
this.documents.length)){for(var a=0,b=0;b<this.documents.length;b++)if(this.documents[b]==this.activeDoc){a=b;break}a==this.documents.length-1?a=0:a++;this.switchTo(this.documents[a])}};Constr.prototype.previousTab=function(){if(!(2>this.documents.length)){for(var a=0,b=0;b<this.documents.length;b++)if(this.documents[b]==this.activeDoc){a=b;break}0==a?a=this.documents.length-1:a--;this.switchTo(this.documents[a])}};Constr.prototype.switchTo=function(a){this.editor.setSession(a.$session);this.editor.resize();
this.activeDoc=a;var b=this;$("#tabs a").each(function(){var c=$(this);this.title==a.path?(c.addClass("active"),b.scrollToTab(c)):c.removeClass("active")});this.updateStatus("");this.$triggerEvent("activate",[a])};Constr.prototype.updateTabStatus=function(a,b){var c;c=b.saved?b.name:b.name+"*";$('#tabs a[title="'+a+'"]').attr("title",b.path).text(c)};Constr.prototype.scrollToTab=function(a){var b=a.offset().left,a=b+a.outerWidth(),c=$("#tabs").innerWidth(),f=$("#tabs").scrollLeft();a>c?($("#tab-next").show(),
$("#tab-prev").show(),$("#tabs").scrollLeft(a-c)):b<f&&(b<c?$("#tabs").scrollLeft(0):$("#tabs").scrollLeft(b));$.log("Scrolling to %d %d",b,$("#tabs").scrollLeft())};Constr.prototype.setTheme=function(a){$.log("Changing theme to %s",a);var b=this;b.loadTheme(a,function(){b.editor.setTheme("ace/theme/"+a)})};Constr.prototype.loadTheme=function(a,b){if(this.themes[a])return b();require("ace/lib/net");this.themes[a]=1;var c="resources/scripts/ace/theme-"+a.split("/").pop()+".js",f=document.getElementsByTagName("head")[0],
i=document.createElement("script");i.src=c;f.appendChild(i);i.onload=b};Constr.prototype.updateStatus=function(a,b){this.status.innerHTML=a;b&&(this.status.href=b)};Constr.prototype.triggerCheck=function(){if(this.activeDoc.getModeHelper()){var a=this;if(!a.pendingCheck){var b=(new Date).getTime();a.validateTimeout&&2E3>b-a.lastChangeEvent&&clearTimeout(a.validateTimeout);a.lastChangeEvent=b;a.validateTimeout=setTimeout(function(){a.validate.apply(a)},2E3)}}};Constr.prototype.validate=function(){var a=
this,b=a.activeDoc.getModeHelper();b&&b.validate&&(a.pendingCheck=!0,$.log("Running validation..."),b.validate(a.activeDoc,a.getText(),function(){a.pendingCheck=!1}),a.$triggerEvent("validate",[a.activeDoc]))};Constr.prototype.evalError=function(a){var b=/.*line\s(\d+)/i.exec(a),c=-1;b&&(c=parseInt(b[1]));$.log("error in line %d",b[1]);this.editor.focus();this.editor.gotoLine(c);b=[{row:c-1,text:a,type:"error"}];this.updateStatus(a);this.editor.getSession().setAnnotations(b)};Constr.prototype.focus=
function(){this.editor.focus()};Constr.prototype.saveState=function(){var a=0;$.each(this.documents,function(b,c){if(c.path.match("^__new__.*")){var f=c.getText();f&&0<f.length&&(localStorage["eXide."+a+".path"]=c.path,localStorage["eXide."+a+".name"]=c.name,localStorage["eXide."+a+".mime"]=c.mime,localStorage["eXide."+a+".data"]=c.getText(),localStorage["eXide."+a+".last-line"]=c.getCurrentLine())}else localStorage["eXide."+a+".path"]=c.path,localStorage["eXide."+a+".name"]=c.name,localStorage["eXide."+
a+".mime"]=c.mime,localStorage["eXide."+a+".writable"]=c.editable?"true":"false",localStorage["eXide."+a+".last-line"]=c.getCurrentLine(),c.saved||(localStorage["eXide."+a+".data"]=c.getText());a++});localStorage["eXide.documents"]=a};return Constr}();$(document).ready(function(){var a=function(a){if(""==a)return{};for(var c={},f=0;f<a.length;++f){var d=a[f].split("=");2==d.length&&(c[d[0]]=decodeURIComponent(d[1].replace(/\+/g," ")))}return c}(window.location.search.substr(1).split("&"));eXide.app.init(function(b){var c=a.open,f=a.snip;c&&!b[c]?eXide.app.findDocument(a.open):f&&eXide.app.newDocument(f)})});eXide.namespace("eXide.app");
eXide.app=function(){var a,b,c,f,d=0,e=0,g=0,h=0;return{init:function(d){a=new eXide.edit.Editor(document.getElementById("editor"));b=new eXide.edit.PackageEditor(document.getElementById("deployment-editor"));c=new eXide.browse.Browser(document.getElementById("open-dialog"));b.addEventListener("change",null,function(){c.onChange();eXide.app.openDocument()});f=new eXide.util.Preferences(a);eXide.app.initGUI();var e=eXide.app.restoreState();a.init();a.addEventListener("outlineChange",eXide.app.onOutlineChange);
$(window).resize(eXide.app.resize);$(window).unload(function(){eXide.app.saveState()});eXide.find.Modules.addEventListener("open",null,function(a){eXide.app.findDocument(a.at)});eXide.find.Modules.addEventListener("import",null,function(b){a.exec("importModule",b.prefix,b.uri,b.at)});d&&d(e)},resize:function(){$("#editor");$(".header");a.resize()},newDocument:function(b,c){a.newDocument(b,c)},findDocument:function(b){var c=a.getDocument(b);null==c?(b={name:b.match(/[^\/]+$/),path:b},eXide.app.$doOpenDocument(b)):
a.switchTo(c)},locate:function(b,c,d){if(null==c)a.exec("locate",b,d);else{$.log("Locating %s in document %s",d,c);var f=a.getDocument(c);null==f?(c={name:c.match(/[^\/]+$/),path:c},eXide.app.$doOpenDocument(c,function(){a.exec("locate",b,d)})):(a.switchTo(f),a.exec("locate",b,d))}},openDocument:function(){c.reload(["reload"],"open");$("#open-dialog").dialog("option","title","Open Document");$("#open-dialog").dialog("option","buttons",{cancel:function(){$(this).dialog("close");a.focus()},open:eXide.app.openSelectedDocument});
$("#open-dialog").dialog("open")},openSelectedDocument:function(a){var b=c.getSelection();b&&eXide.app.$doOpenDocument(b);(void 0==a||a)&&$("#open-dialog").dialog("close")},$doOpenDocument:function(b,c,d){b.path=eXide.util.normalizePath(b.path);var f=a.getDocument(b.path);if(f&&!d)return a.switchTo(f),!0;$.ajax({url:"modules/load.xql?path="+b.path,dataType:"text",success:function(f,e,g){d?a.reload(f):(e=eXide.util.mimeTypes.getMime(g.getResponseHeader("Content-Type")),a.openDocument(f,e,b));c&&c.call(null,
b);return!0},error:function(a){eXide.util.error("Failed to load document "+b.path+": "+a.status+" "+a.statusText);return!1}})},reloadDocument:function(){var b=a.getActiveDocument();b.isSaved()?eXide.app.$reloadDocument(b):eXide.util.Dialog.input("Reload Document","Do you really want to reload the document?",function(){eXide.app.$reloadDocument(b)})},$reloadDocument:function(a){a={name:a.getName(),path:a.getPath()};eXide.app.$doOpenDocument(a,null,!0)},closeDocument:function(){a.getActiveDocument().isSaved()?
a.closeDocument():$("#dialog-confirm-close").dialog({resizable:!1,height:140,modal:!0,buttons:{Close:function(){$(this).dialog("close");a.closeDocument()},Cancel:function(){$(this).dialog("close")}}})},saveDocument:function(){eXide.app.requireLogin(function(){a.getActiveDocument().getPath().match("^__new__")?(c.reload(["reload","create"],"save"),$("#open-dialog").dialog("option","title","Save Document"),$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){a.saveDocument(c.getSelection(),
function(){$("#open-dialog").dialog("close");b.autoSync(a.getActiveDocument().getBasePath())},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}}),$("#open-dialog").dialog("open")):a.saveDocument(null,function(){eXide.util.message(a.getActiveDocument().getName()+" stored.");b.autoSync(a.getActiveDocument().getBasePath())},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})})},saveDocumentAs:function(){eXide.app.requireLogin(function(){c.reload(["reload","create"],
"save");$("#open-dialog").dialog("option","title","Save Document As ...");$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){a.saveDocument(c.getSelection(),function(){$("#open-dialog").dialog("close");b.autoSync(a.getActiveDocument().getBasePath())},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}});$("#open-dialog").dialog("open")})},exec:function(){a.exec(arguments)},download:function(){var b=a.getActiveDocument();b.getPath().match("^__new__")||
!b.isSaved()?eXide.util.error("There are unsaved changes in the document. Please save it first."):window.location.href="modules/load.xql?download=true&path="+encodeURIComponent(b.getPath())},runQuery:function(){a.updateStatus("Running query ...");var b=a.getText(),c="xmldb:exist://"+a.getActiveDocument().getBasePath();$("#results-container .results").empty();$.ajax({type:"POST",url:"execute",dataType:"xml",data:{qu:b,base:c},success:function(b){b=b.documentElement;if("error"==b.nodeName)b=$(b).text(),
eXide.util.error(b,"Compilation Error"),a.evalError(b);else{a.updateStatus("");a.clearErrors();var c=$("body").layout();c.open("south");c.sizePane("south",300);eXide.app.resize();g=e=1;d=b.getAttribute("hits");h=e+10-1;d<h&&(h=d);eXide.util.message("Found "+d+" in "+b.getAttribute("elapsed")+"s");eXide.app.retrieveNext()}},error:function(a){eXide.util.error(a.responseText,"Server Error")}})},checkQuery:function(){a.validate()},retrieveNext:function(){$.log("retrieveNext: %d",g);if(0<g&&g<=h){var a=
"results/"+g;g++;$.ajax({url:a,dataType:"html",success:function(a){$("#results-container .results").append(a);$("#results-container .current").text("Showing results "+e+" to "+(g-1)+" of "+d);$("#results-container .pos:last a").click(function(){eXide.app.findDocument(this.pathname);return!1});eXide.app.retrieveNext()}})}},browseNext:function(){0<g&&h<d&&(e=g,h=g+10-1,d<h&&(h=d),$("#results-container .results").empty(),eXide.app.retrieveNext());return!1},browsePrevious:function(){0<g&&1<e&&(e-=10,
1>e&&(e=1),g=e,h=g+9,d<h&&(h=d),$("#results-container .results").empty(),eXide.app.retrieveNext());return!1},manage:function(){eXide.app.requireLogin(function(){c.reload("reload create upload open cut copy paste".split(" "),"manage");$("#open-dialog").dialog("option","title","DB Manager");$("#open-dialog").dialog("option","buttons",{Close:function(){$(this).dialog("close")}});$("#open-dialog").dialog("open")})},deploymentSettings:function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());
c&&eXide.app.requireLogin(function(){$.log("Editing deployment settings for collection: %s",c[1]);b.open(c[1])})},newDeployment:function(){eXide.app.requireLogin(function(){b.open()})},deploy:function(){eXide.app.requireLogin(function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());if(!c)return eXide.util.error("The file open in the editor does not belong to an application package!"),!1;$.log("Deploying application from collection: %s",c[1]);b.deploy(c[1])});return!1},synchronize:function(){eXide.app.requireLogin(function(){var c=
/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());c?b.synchronize(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},downloadApp:function(){eXide.app.requireLogin(function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());$.log("downloading %s",c);c?b.download(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},openApp:function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());
c?b.runApp(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")},restoreState:function(){if(!eXide.util.supportsHtml5Storage)return!1;f.read();var c={},d=localStorage["eXide.documents"];d||(d=0);for(var e=0;e<d;e++){var g={path:localStorage["eXide."+e+".path"],name:localStorage["eXide."+e+".name"],writable:"true"==localStorage["eXide."+e+".writable"],line:parseInt(localStorage["eXide."+e+".last-line"])};$.log("Restoring doc %s, going to line = %i",g.path,
g.line);var h=localStorage["eXide."+e+".data"];h?a.newDocumentWithText(h,localStorage["eXide."+e+".mime"],g):eXide.app.$doOpenDocument(g);c[g.path]=g}a.getActiveDocument()||eXide.app.newDocument("","xquery");b.restoreState();return c},saveState:function(){eXide.util.supportsHtml5Storage&&(localStorage.clear(),f.save(),a.saveState(),b.saveState())},getLogin:function(){$.ajax({url:"login",dataType:"json",success:function(a){eXide.app.login=a;$("#user").text("Logged in as "+eXide.app.login+". ")},error:function(){eXide.app.login=
null}})},$checkLogin:function(){if(eXide.app.login)return!0;eXide.util.error("Warning: you are not logged in.");return!1},requireLogin:function(a){eXide.app.login?a():($("#login-dialog").dialog("option","close",function(){eXide.app.login?a():eXide.util.error("Warning: you are not logged in!")}),$("#login-dialog").dialog("open"))},getPreference:function(a){return f.get(a)},initGUI:function(){eXide.app.getLogin();var b=$("body").layout({enableCursorHotkey:!1,north__size:70,north__resizable:!1,north__closable:!0,
north__showOverflowOnHover:!0,south__minSize:200,south__initClosed:!0,west__size:200,west__initClosed:!1,west__contentSelector:".content",center__minSize:300,center__onresize:eXide.app.resize,center__contentSelector:".content"}),d=new eXide.util.Menubar($(".menu"));$("#open-dialog").dialog({title:"Open File",modal:!1,autoOpen:!1,height:480,width:700,open:function(){c.init()},resize:function(){c.resize()}});$("#login-dialog").dialog({title:"Login",modal:!0,autoOpen:!1,buttons:{Login:function(){var b=
$('#login-form input[name="user"]').val(),c=$('#login-form input[name="password"]').val(),b={user:b,password:c};$('#login-form input[name="duration"]').is(":checked")&&(b.duration="P14D");$.ajax({url:"login",data:b,dataType:"json",success:function(){eXide.app.login=$('#login-form input[name="user"]').val();$.log("Logged in as %s",eXide.app.login);$("#login-dialog").dialog("close");$("#user").text("Logged in as "+eXide.app.login+". ");a.focus()},error:function(){$("#login-error").text("Login failed. Bad username or password.");
$("#login-dialog input:first").focus()}})},Cancel:function(){$(this).dialog("close");a.focus()}},open:function(){$(this).find("input").val("");$(this).find("input:first").focus();$("#login-error").empty();var a=$(this);a.find("input").keyup(function(b){13==b.keyCode&&a.parent().find(".ui-dialog-buttonpane button:first").trigger("click")})}});$("#keyboard-help").dialog({title:"Keyboard Shortcuts",modal:!1,autoOpen:!1,height:400,buttons:{Close:function(){$(this).dialog("close")}},open:function(){eXide.edit.commands.help($("#keyboard-help"),
a)}});$("#about-dialog").dialog({title:"About",modal:!1,autoOpen:!1,height:300,width:450,buttons:{Close:function(){$(this).dialog("close")}}});var e=$("#open").button({icons:{primary:"ui-icon-folder-open"}});e.click(eXide.app.openDocument);d.click("#menu-file-open",eXide.app.openDocument);e=$("#close").button({icons:{primary:"ui-icon-close"}});e.click(eXide.app.closeDocument);d.click("#menu-file-close",eXide.app.closeDocument);e=$("#new").button({icons:{primary:"ui-icon-document"}});e.click(eXide.app.newDocument);
d.click("#menu-file-new",eXide.app.newDocument);d.click("#menu-file-new-xquery",function(){eXide.app.newDocument(null,"xquery")});e=$("#run").button({icons:{primary:"ui-icon-play"}});e.click(eXide.app.runQuery);e=$("#validate").button({icons:{primary:"ui-icon-check"}});e.click(eXide.app.checkQuery);e=$("#save").button({icons:{primary:"ui-icon-disk"}});e.click(eXide.app.saveDocument);d.click("#menu-file-save",eXide.app.saveDocument);d.click("#menu-file-save-as",eXide.app.saveDocumentAs);d.click("#menu-file-reload",
eXide.app.reloadDocument);e=$("#download").button({icons:{primary:"ui-icon-transferthick-e-w"}});e.click(eXide.app.download);d.click("#menu-file-download",eXide.app.download);d.click("#menu-file-manager",eXide.app.manage);d.click("#menu-deploy-new",eXide.app.newDeployment);d.click("#menu-deploy-edit",eXide.app.deploymentSettings);d.click("#menu-deploy-deploy",eXide.app.deploy);d.click("#menu-deploy-sync",eXide.app.synchronize);d.click("#menu-deploy-download",eXide.app.downloadApp);d.click("#menu-edit-undo",
function(){a.editor.undo()});d.click("#menu-edit-redo",function(){a.editor.redo()});d.click("#menu-edit-toggle-comment",function(){a.editor.toggleCommentLines()});d.click("#menu-edit-preferences",function(){f.show()});d.click("#menu-navigate-definition",function(){a.exec("gotoDefinition")});d.click("#menu-navigate-modules",function(){var b=a.getActiveDocument();eXide.find.Modules.select(b.syntax)});d.click("#menu-deploy-run",eXide.app.openApp);d.click("#menu-help-keyboard",function(){$("#keyboard-help").dialog("open")});
d.click("#menu-help-about",function(){$("#about-dialog").dialog("open")});d.click("#menu-help-hints",function(){eXide.util.Help.show()});$("#syntax").change(function(){a.setMode($(this).val())});a.addEventListener("activate",null,function(a){$("#syntax").val(a.getSyntax())});$("#user").click(function(a){a.preventDefault();eXide.app.login?($.get("login?logout=logout"),$("#user").text("Login"),eXide.app.login=null):$("#login-dialog").dialog("open")});$("#results-container .next").click(eXide.app.browseNext);
$("#results-container .previous").click(eXide.app.browsePrevious);b.toggle("south");b.toggle("south");$("#error-status").mouseover(function(){var a=this;$("#ext-status-bar").each(function(){this.innerHTML=a.innerHTML;$(this).css("display","block")})});$("#ext-status-bar").mouseout(function(){$(this).css("display","none")})}}}();eXide.namespace("eXide.edit.Projects");
eXide.edit.Projects=function(){Constr=function(){this.projects={}};Constr.prototype.getProject=function(a,b){var c=this;$.getJSON("modules/deployment.xql",{info:a},function(a){if(a){var d=c.projects[a.abbrev];d?eXide.util.oop.extend(d,a):(d=a,c.projects[a.abbrev]=d);b(d)}else eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};Constr.prototype.getProjectFor=function(a){for(k in this.projects){var b=this.projects[k];$.log("collection: %s -> root: %s",
a.substring(0,b.root.length),b.root);if(a.substring(0,b.root.length)===b.root)return b}return null};Constr.prototype.saveState=function(){localStorage["eXide.projects"]=JSON.stringify(this.projects)};Constr.prototype.restoreState=function(){localStorage["eXide.projects"]&&(this.projects=JSON.parse(localStorage["eXide.projects"]),"object"!=typeof this.projects&&(this.projects={}))};return Constr}();eXide.namespace("eXide.edit.PackageEditor");
eXide.edit.PackageEditor=function(){Constr=function(){var a=this;this.projects=new eXide.edit.Projects;this.currentProject=null;this.container=$("#dialog-deploy");this.container.dialog({title:"Deployment Editor",modal:!1,autoOpen:!1,width:520,height:600});this.syncDialog=$("#synchronize-dialog");this.syncDialog.dialog({title:"Synchronize to Directory",modal:!1,autoOpen:!1,width:500,height:400,buttons:{Apply:function(){var b=a.syncDialog.find('input[name="dir"]').val();b&&0<b.length&&(a.currentProject.dir=
b);a.currentProject.autoSync=a.syncDialog.find('input[name="auto"]').is(":checked");$(this).dialog("close")},Synchronize:function(){var b=a.syncDialog.find('input[name="dir"]').val();!b||0==b.length?$("#synchronize-report").text("No output directory specified!"):(a.currentProject.dir=b,b=a.syncDialog.find("form").serialize(),$("#synchronize-report").text("Synchronization in progress ..."),$("#synchronize-report").load("modules/synchronize.xql",b))},Close:function(){$(this).dialog("close")}}})};eXide.util.oop.inherit(Constr,
eXide.events.Sender);Constr.prototype.open=function(a){var b=this,c=null;a&&(c={collection:a});$.ajax({url:"modules/deployment.xql",type:"POST",data:c,success:function(c){b.container.html(c);b.container.form({done:function(){var c=b.container.find("form").serialize();$.ajax({url:"modules/deployment.xql",type:"POST",data:c,success:function(){b.container.dialog("close");b.$triggerEvent("change",a)},error:function(a){eXide.util.error(a.responseText)}})},cancel:function(){b.container.dialog("close")}});
b.container.find(".author-repeat").repeat("#author-add-trigger",{deleteTrigger:"#author-remove-trigger"});b.container.dialog("open")},error:function(a){eXide.util.error(a.responseText)}})};Constr.prototype.deploy=function(a){var b=this;eXide.util.Dialog.input("Deploy",'<p>Note: target has to be different from the source package or it will be overwritten!</p><p><label for="target">Target collection:</label><input id="deployment-target" type="text" name="target" value="'+a+'-test"size="30"/></p>',function(){var c=
$("#deployment-target").val();""===c&&(c=a);$.ajax({url:"modules/deployment.xql",type:"POST",dataType:"json",data:{collection:a,target:c,deploy:"true"},success:function(c){c=location.protocol+"//"+location.hostname+":"+location.port+"/exist/apps/"+c+"/";eXide.util.Dialog.message("Application Deployed",'<p>The application has been deployed. On a standard installation the following link should open it:</p><center><a href="'+c+'" target="_new">'+c+"</a></center>");b.$triggerEvent("change",a)},error:function(a){404==
a.status?eXide.util.error("Deployment failed. The document currently opened in the editor should belong to an application package."):eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>")}})})};Constr.prototype.download=function(a){window.location.href="modules/deployment.xql?download=true&collection="+encodeURIComponent(a)};Constr.prototype.synchronize=function(a){var b=this;b.projects.getProject(a,function(a){a.isAdmin?(b.currentProject=
a,b.syncDialog.find(".project-name").text(a.abbrev),b.syncDialog.find('input[name="start"]').val(a.deployed),a.dir&&b.syncDialog.find('input[name="dir"]').val(a.dir),b.syncDialog.find('input[name="collection"]').val(a.root),b.syncDialog.find('input[name="auto"]').attr("checked",a.autoSync),b.syncDialog.dialog("open")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature.")})};Constr.prototype.autoSync=function(a){(a=this.projects.getProjectFor(a))&&a.autoSync&&
$.ajax({url:"modules/synchronize.xql",type:"GET",data:{collection:a.root,start:a.deployed,dir:a.dir},success:function(){eXide.util.message("Synchronized directory")}})};Constr.prototype.runApp=function(a){this.projects.getProject(a,function(a){var c="/exist/apps/"+a.root.replace(/^\/db\//,"")+"/";eXide.util.Dialog.message("Run Application "+a.abbrev,'<p>Click on the following link to open your application:</p><center><a href="'+c+'" target="_new">'+c+"</a></center>")})};Constr.prototype.saveState=
function(){this.projects.saveState()};Constr.prototype.restoreState=function(){this.projects.restoreState()};return Constr}();eXide.namespace("eXide.edit.Template");
eXide.edit.Template=function(){var a=/\n/;Constr=function(b,c,f,d){var e=f.split(a).length;this.code=f;this.editor=b.editor;this.range=c;this.type=d;this.startLine=c.start.row;this.endLine=this.startLine+e-1;$.log("startLine = %i, endLine = %i",this.startLine,this.endLine);this.currentLine=this.startLine;this.lineOffset=this.startColumn=c.start.column;this.regex=/\$[\w\-:_]+/g;0<this.startColumn&&(this.regex.lastIndex=this.startColumn)};Constr.prototype={insert:function(){this.editor.getSession().remove(this.range);this.editor.insert(this.code);
var a=this.editor.getSelection().getSelectionLead();"$"!=this.code.substring(0,1)&&0<a.column&&this.editor.navigateLeft();"variable"!=this.type&&this.nextParam();this.editor.focus()},nextParam:function(){var a=this.editor.getSession(),c=this.editor.getSelection(),f=c.getSelectionLead();$.log("lead.row = %i startLine = %i",f.row,this.startLine);if(f.row<this.startLine||f.row>this.endLine)return!1;for(var d=f=!1;this.currentLine<=this.endLine;){var e=a.getDisplayLine(this.currentLine);$.log("Checking line %s",
e);if(e=this.regex.exec(e)){$.log("Matched %s",e[0]);c.setSelectionAnchor(this.currentLine,e.index);c.selectTo(this.currentLine,e.index+e[0].length);this.lineOffset=e.index;d=!0;break}else this.lineOffset=0,this.currentLine++;this.currentLine>this.endLine&&!f&&($.log("loop %i",this.startColumn),this.currentLine=this.startLine,0<this.startColumn&&(this.lineOffset=this.startColumn,this.regex.lastIndex=this.lineOffset),f=!0)}return d}};return Constr}();eXide.namespace("eXide.util.Help");
eXide.util.Help=function(){var a=null,b=-1;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-help">\t<div class="help" id="eXide-dialog-help-body"></div></div>');helpDialog=$("#eXide-dialog-help");helpDialog.dialog({modal:!1,title:"Quick Start",autoOpen:!1,width:600,height:400,buttons:{OK:function(){$(this).dialog("close")},Next:function(){eXide.util.Help.next()},Previous:function(){eXide.util.Help.previous()}}});eXide.util.Help.showFirstTime()});return{show:function(){helpDialog.dialog("open");
a?eXide.util.Help.next():eXide.util.Help.load()},next:function(){b+1<a.length&&(b++,$("#eXide-dialog-help-body").html(a[b]))},previous:function(){0<b&&(b--,$("#eXide-dialog-help-body").html(a[b]))},showFirstTime:function(){if(eXide.util.supportsHtml5Storage){var a=localStorage.getItem("eXide.hints");(!a||1==a)&&eXide.util.Help.show()}},load:function(){$.ajax({url:"help.html",type:"GET",success:function(b){a=$("section",b);eXide.util.Help.show()},error:function(a){404==a.status?eXide.util.error("Failed to open help texts."):
eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>");helpDialog.dialog("close")}})}}}();eXide.namespace("eXide.util.Preferences");
eXide.util.Preferences=function(){var a={theme:"tomorrow",fontSize:"14px",showInvisibles:!1,showPrintMargin:!0,showHScroll:!1,softWrap:-1};Constr=function(b){this.editor=b;this.preferences=$.extend({},a);var c=this;$("#preferences-dialog").dialog({title:"Preferences",modal:!0,autoOpen:!1,height:400,width:600,buttons:{Cancel:function(){$(this).dialog("close");b.focus()},"Reset Defaults":function(){c.preferences=$.extend({},a);c.updateForm()},Save:function(){var a=$("form",this);c.preferences.theme=
$('select[name="theme"]',a).val();c.preferences.fontSize=$('select[name="font-size"]',a).val();c.preferences.showInvisibles=$('input[name="show-invisibles"]',a).is(":checked");c.preferences.showPrintMargin=$('input[name="print-margin"]',a).is(":checked");a=$('select[name="soft-wrap"]',a).val();"free"===a?a=-1:"off"===a&&(a=0);c.preferences.softWrap=parseInt(a);c.applyPreferences();$(this).dialog("close");b.focus()}}})};Constr.prototype.show=function(){this.updateForm();$("#preferences-dialog").dialog("open")};
Constr.prototype.updateForm=function(){$.log("Updating form");var a=$("#preferences-dialog form");$('select[name="theme"]',a).val(this.preferences.theme);$('select[name="font-size"]',a).val(this.preferences.fontSize);$('input[name="show-invisibles"]',a).attr("checked",this.preferences.showInvisibles);$('input[name="print-margin"]',a).attr("checked",this.preferences.showPrintMargin);var c=this.preferences.softWrap;0==c?c="off":-1===c&&(c="free");$('input[name="soft-wrap"]',a).val(c)};Constr.prototype.applyPreferences=
function(){$.log("Applying preferences: %o",this.preferences);var a=this;this.editor.setTheme(this.preferences.theme);this.editor.editor.setShowInvisibles(this.preferences.showInvisibles);this.editor.editor.renderer.setShowPrintMargin(this.preferences.showPrintMargin);this.editor.forEachDocument(function(c){0<a.preferences.softWrap?c.getSession().setWrapLimitRange(a.preferences.softWrap,a.preferences.softWrap):0>a.preferences.softWrap&&c.getSession().setWrapLimitRange(null,null);c.getSession().setUseWrapMode(0!=
a.preferences.softWrap)});$("#editor").css("font-size",this.preferences.fontSize);this.editor.resize()};Constr.prototype.get=function(a){return this.preferences[a]};Constr.prototype.read=function(){localStorage["eXide.preferences"]&&(this.preferences=JSON.parse(localStorage.getItem("eXide.preferences")));this.applyPreferences()};Constr.prototype.save=function(){localStorage.setItem("eXide.preferences",JSON.stringify(this.preferences));localStorage.setItem("eXide.hints",0)};return Constr}();eXide.namespace("eXide.browse.CollectionBrowser");
eXide.browse.CollectionBrowser=function(){Constr=function(a){var b=this;this.events={activate:[]};this.selected=null;var c=document.createElement("div");c.className="eXide-browse-collections eXide-browse-content";a.append(c);this.container=$(c);this.container.dynatree({persist:!1,rootVisible:!1,initAjax:{url:"modules/collections.xql"},clickFolderMode:1,autoFocus:!0,keyboard:!1,onActivate:function(a){var c=a.data.key;$.log("activate %s: is writable: %s",c,a.data.writable);b.selected=c;b.$triggerEvent("activate",
[c,a.data.writable])},onPostInit:function(a){$.log("Reloading: %s",a);b.select(b.selected)}})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.getSelection=function(){return this.selected};Constr.prototype.getSelected=function(){return{isCollection:!1,name:this.selected}};Constr.prototype.select=function(a){var b=this.container.dynatree("getTree"),c=null;a&&(c=b.getNodeByKey(a),null==c&&(a=a.substring(0,a.lastIndexOf("/")),$.log("Activating parent collection %s",a),c=b.getNodeByKey(a)));
null==c&&(a="/db",c=b.getNodeByKey(a));null!=c&&(this.selected=a);c.activate();c.expand(!0)};Constr.prototype.reload=function(){$.log("Reloading tree...");this.container.dynatree("getTree").reload()};Constr.prototype.createCollection=function(){var a=this;eXide.app.$checkLogin()&&eXide.util.Dialog.input("Create Collection",'<label for="collection">Name: </label><input type="text" name="collection" id="eXide-browse-collection-name"/>',function(){$.getJSON("modules/collections.xql",{create:$("#eXide-browse-collection-name").val(),
collection:a.selected},function(b){"fail"==b.status?eXide.util.Dialog.warning("Create Collection Error",b.message):a.reload()})})};Constr.prototype.deleteCollection=function(){var a=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete collection "+a.selected+"?",function(){$.getJSON("modules/collections.xql",{remove:a.selected},function(b){"fail"==b.status?eXide.util.Dialog.warning("Delete Collection Error",b.message):a.reload()})})};return Constr}();eXide.namespace("eXide.browse.ResourceBrowser");
eXide.browse.ResourceBrowser=function(){var a=[{id:"name",name:"Name",field:"name",width:120,formatter:function(a,b,c,g,h){return h.isCollection?'<span class="collection"><img src="resources/images/folder_add.png"/> '+c+"</span>":c},editor:Slick.Editors.Text},{id:"permissions",name:"Permissions",field:"permissions",width:80},{id:"owner",name:"Owner",field:"owner",width:70},{id:"group",name:"Group",field:"group",width:70},{id:"lastMod",name:"Last Modified",field:"last-modified",width:115}],b={editable:!1,
multiSelect:!1},c={editable:!0,autoEdit:!0,multiSelect:!0,enableCellNavigation:!0};Constr=function(b){var d=this;this.container=$(b);this.clipboard=[];this.clipboardMode="copy";this.events={activate:[],activateCollection:[],activateParent:[]};this.mode="save";this.inEditor=!1;this.collection=null;this.data=[];this.grid=new Slick.Grid(this.container,this.data,a,c);var e=new Slick.RowSelectionModel;this.grid.setSelectionModel(e);e.onSelectedRangesChanged.subscribe(function(){var a=e.getSelectedRows();
if(0!=d.data.length){for(var b=!0,c=0;c<a.length;c++)if(a[c]<d.data.length&&d.data[a[c]]&&!d.data[a[c]].writable){b=!1;break}d.$triggerEvent("activate",[1==a.length&&d.data[a[0]]&&!d.data[a[0]].isCollection?d.data[a[0]]:null,b])}});this.grid.onDblClick.subscribe(function(a){a=d.grid.getCellFromEvent(a);d.data[a.row].isCollection&&d.$triggerEvent("activateCollection",[d.collection+"/"+d.data[a.row].name])});this.grid.onKeyDown.subscribe(function(a){if(!d.inEditor&&!a.shiftKey&&!a.altKey&&!a.ctrlKey)if(13==
a.which)a.stopPropagation(),a.preventDefault(),a=e.getSelectedRows(),1==a.length&&(d.data[a[0]].isCollection?d.$triggerEvent("activateCollection",[d.collection+"/"+d.data[a[0]].name]):eXide.app.openSelectedDocument());else if(8==a.which){var b=d.collection.lastIndexOf("/");0<b&&(a.stopPropagation(),a.preventDefault(),"/db"!=d.collection&&(a=d.collection.substring(0,b),d.$triggerEvent("activateCollection",[a])))}});this.grid.onBeforeEditCell.subscribe(function(a,b){d.inEditor=!0;d.oldValue=d.data[b.row].name});
this.grid.onBeforeCellEditorDestroy.subscribe(function(){d.inEditor=!1});this.grid.onCellChange.subscribe(function(a,b){d.oldValue&&$.getJSON("modules/collections.xql",{target:d.data[b.row].name,rename:d.oldValue,root:d.collection},function(a){d.reload();d.data[b.row].isCollection&&d.$triggerEvent("activateCollection",[d.data[b.row].name]);"fail"==a.status&&eXide.util.Dialog.warning("Rename Error",a.message)})});this.grid.onViewportChanged.subscribe(function(){var a=d.grid.getViewport();d.load(a.top,
a.bottom)})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.setMode=function(a){this.mode=a;"manage"==a?this.grid.setOptions(c):this.grid.setOptions(b)};Constr.prototype.resize=function(){this.grid.resizeCanvas();this.grid.focus()};Constr.prototype.update=function(a,b){if(b||a!==this.collection)$.log("Opening resources for %s",a),this.collection=a,this.grid.invalidate(),this.data.length=0,this.grid.setActiveCell(0,1),this.grid.setSelectedRows([]),this.grid.onViewportChanged.notify(),
this.grid.focus()};Constr.prototype.load=function(a,b){var c=this;$.getJSON("modules/collections.xql",{root:this.collection,view:"r",start:a,end:b},function(g){for(var h=a;h<=b;h++)c.grid.invalidateRow(h);if(g&&g.items){c.data.length=g.total;for(h=0;h<g.items.length;h++)c.data[a+h]=g.items[h]}else c.data.length=0;c.grid.updateRowCount();c.grid.render();0==a&&(c.grid.setActiveCell(0,1),c.grid.focus())})};Constr.prototype.hasSelection=function(){var a=this.grid.getSelectionModel().getSelectedRows();
return a&&0<a.length};Constr.prototype.getSelected=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0==a.length)return null;for(var b=[],c=0;c<a.length;c++)b.push(this.collection+"/"+this.data[a[c]].name);return b};Constr.prototype.deleteResource=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0!=a.length){for(var b=[],c=0;c<a.length;c++)b.push(this.data[a[c]].name);var g=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete the selected resources?",
function(){$.log("Deleting resources %o",b);$.getJSON("modules/collections.xql",{remove:b,root:g.collection},function(a){g.reload();"fail"==a.status&&eXide.util.Dialog.warning("Delete Resource Error",a.message)})})}};Constr.prototype.cut=function(){this.clipboardMode="move";this.copy()};Constr.prototype.copy=function(){var a=this.grid.getSelectionModel().getSelectedRows();this.clipboard=[];for(var b=0;b<a.length;b++){var c=this.data[a[b]].name;"/"!=c.substr(0,1)&&(c=this.collection+"/"+c);this.clipboard.push(c)}$.log("Clipboard: %o",
this.clipboard)};Constr.prototype.paste=function(){var a=this;$.log("Copying resources %o to %s",this.clipboard,this.collection);var b={root:this.collection};b[this.clipboardMode]=this.clipboard;$.getJSON("modules/collections.xql",b,function(b){$.log(b.status);"fail"==b.status?eXide.util.Dialog.warning("Delete Resource Error",b.message):a.reload()})};Constr.prototype.focus=function(){this.container.find(".grid-canvas").focus()};Constr.prototype.reload=function(){this.update(this.collection,!0)};return Constr}();
eXide.namespace("eXide.browse.Upload");
eXide.browse.Upload=function(){Constr=function(a){this.container=a;this.events={done:[]};$("#file_upload").fileUploadUI({sequentialUploads:!0,uploadTable:$("#files"),buildUploadRow:function(a,b){return $("<tr><td>"+a[b].name+'</td><td class="file_upload_progress"><div></div></td><td class="file_upload_cancel"><button class="ui-state-default ui-corner-all" title="Cancel"><span class="ui-icon ui-icon-cancel">Cancel</span></button></td></tr>')},buildDownloadRow:function(a){return a.error?$("<tr><td>"+
a.name+"</td><td>"+a.error+"</td></tr>"):null}});var b=this;$("#eXide-browse-upload-done").button().click(function(){$("#files").empty();b.$triggerEvent("done",[])})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.update=function(a){$('input[name="collection"]',this.container).val(a)};return Constr}();eXide.namespace("eXide.browse.Browser");
eXide.browse.Browser=function(){function a(a,c,f,d,e){var g=document.createElement("button");g.title=c;g.id="eXide-browse-toolbar-"+f;g.tabindex=d;c=document.createElement("img");c.src="resources/images/"+e;g.appendChild(c);a.append(g);return g}Constr=function(b){var c=this;this.mode="open";var f=$(".eXide-browse-toolbar",b),d=a(f,"Reload","reload",1,"arrow_refresh.png");$(d).click(function(){c.resources.reload(!0);c.collections.reload()});this.btnCreateCollection=a(f,"Create Collection","create",
3,"folder_add.png");$(this.btnCreateCollection).click(function(a){a.preventDefault();c.collections.createCollection()});this.btnUpload=a(f,"Upload Files","upload",4,"database_add.png");$(this.btnUpload).click(function(a){a.preventDefault();$(".eXide-browse-resources",b).hide();$(".eXide-browse-upload",b).show()});this.btnDeleteResource=a(f,"Delete","delete-resource",5,"bin.png");$(this.btnDeleteResource).click(function(a){a.preventDefault();c.deleteSelected()});d=a(f,"Open Selected","open",6,"page_edit.png");
$(d).click(function(a){a.preventDefault();eXide.app.openSelectedDocument(!1)});this.btnCopy=a(f,"Copy","copy",7,"page_copy.png");this.btnCut=a(f,"Cut","cut",8,"cut.png");this.btnPaste=a(f,"Paste","paste",9,"page_paste.png");this.selection=$(".eXide-browse-form input",b);this.container=b;this.resources=new eXide.browse.ResourceBrowser($(".eXide-browse-resources",b));this.collections=new eXide.browse.CollectionBrowser($(".eXide-browse-collections",b));this.upload=new eXide.browse.Upload($(".eXide-browse-upload",
b).hide());this.layout=null;this.collections.addEventListener("activate",this,this.onActivateCollection);this.collections.addEventListener("activate",this.resources,this.resources.update);this.collections.addEventListener("activate",this.upload,this.upload.update);this.resources.addEventListener("activate",this,this.onActivateResource);this.resources.addEventListener("activateCollection",this,this.onChangeCollection);this.upload.addEventListener("done",this,function(){$(".eXide-browse-resources",
b).show();$(".eXide-browse-upload",b).hide();this.reload()});$(this.btnCopy).click(function(a){a.preventDefault();c.resources.copy()});$(this.btnCut).click(function(a){a.preventDefault();c.resources.cut()});$(this.btnPaste).click(function(a){a.preventDefault();c.resources.paste()})};Constr.prototype={init:function(){var a=$(this.container).innerHeight()-$(".eXide-browse-form",this.container).height()-25;$(".eXide-browse-panel",this.container).height(a);null==this.layout&&(this.layout=$(".eXide-browse-panel",
this.container).layout({enableCursorHotkey:!1,north__resizable:!1,north__closable:!1,north__spacing_open:0,south__resizable:!1,west__size:200,west__initClosed:!1,west__contentSelector:".eXide-browse-content",center__minSize:300,center__contentSelector:".eXide-browse-content",onresize:function(){this.resources.resize()}}),this.resources.resize())},reload:function(a,c){if(a){$(".eXide-browse-toolbar button",this.container).hide();for(var f=0;f<a.length;f++)$("#eXide-browse-toolbar-"+a[f]).show()}c&&
(this.mode=c);this.resources.setMode(c);"save"===this.mode?$(".eXide-browse-form",this.container).show().focus():$(".eXide-browse-form",this.container).hide();null!=this.layout&&(this.resize(),this.collections.reload(),this.resources.update(this.collections.getSelection(),!0),$(this.selection).val(""))},resize:function(){var a=$(this.container).innerHeight()-$(".eXide-browse-form",this.container).height()-25;$(".eXide-browse-panel",this.container).height(a);this.layout.resizeAll()},deleteSelected:function(){var a=
this.resources.getSelected();if(null==a){var a=this.collections.getSelected(),c=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete the selected collections?",function(){$.log("Deleting collection %o",a);$.getJSON("modules/collections.xql",{remove:[a.name]},function(a){c.reload();"fail"==a.status&&eXide.util.Dialog.warning("Delete Collection Error",a.message)})})}else this.resources.deleteResource()},getSelection:function(){var a=$(this.selection).val();return null==a||
""==a?null:{name:a,path:this.collections.getSelection()+"/"+a,writable:!0}},onActivateResource:function(a,c){a?$(this.selection).val(a.name):$(this.selection).val("");"open"!=this.mode&&c?$(this.btnDeleteResource).css("display",""):$(this.btnDeleteResource).css("display","none")},onActivateCollection:function(a,c){"open"!=this.mode&&c?($(this.btnCreateCollection).css("display",""),$(this.btnUpload).css("display",""),$(this.btnDeleteResource).css("display",""),$(this.btnCut).css("display",""),$(this.btnPaste).css("display",
"")):($(this.btnCreateCollection).css("display","none"),$(this.btnUpload).css("display","none"),$(this.btnDeleteResource).css("display","none"),$(this.btnCut).css("display","none"),$(this.btnPaste).css("display","none"));this.resources.update(a,c);this.upload.update(a,c)},onChangeCollection:function(a){this.collections.select(a);this.collections.reload();this.resources.update(this.collections.getSelection())},onChange:function(){$.log("Reloading db manager views");this.collections.reload()}};return Constr}();eXide.namespace("eXide.find.IncrementalSearch");
eXide.find.IncrementalSearch=function(){var a={backwards:!1,wrap:!1,caseSensitive:!1,wholeWord:!1,regExp:!1};Constr=function(a,c){var f=this;f.input=$(a);f.input.hide();f.input.keydown(function(a){switch(a.which){case 27:case 13:a.preventDefault();f.input.hide();f.editor.focus();break;case 40:a.preventDefault();f.editor.findNext();break;case 38:a.preventDefault();f.editor.findPrevious();break;default:f.onChange()}});f.editor=c};Constr.prototype.start=function(){this.currentLine=this.editor.getSession().getSelection().getSelectionLead().row;
this.input.val("");this.input.show().focus()};Constr.prototype.onChange=function(){this.editor.gotoLine(this.currentLine);this.editor.find(this.input.val(),a,!0)};return Constr}();eXide.namespace("eXide.find.Modules");
eXide.find.Modules=function(){var a={open:[],"import":[]},b=[{id:"prefix",name:"Prefix",field:"prefix",sortable:!0,resizable:!0,maxWidth:100,minWidth:60},{id:"uri",name:"URI",field:"uri",sortable:!0,resizable:!0,minWidth:100},{id:"at",name:"Location",field:"at",sortable:!0,resizable:!0}],c={editable:!1,multiSelect:!1,forceFitColumns:!0},f=[],d;$(document).ready(function(){d=new Slick.Grid("#module-list",f,b,c);var a=new Slick.RowSelectionModel({selectActiveRow:!0});d.setSelectionModel(a);d.onDblClick.subscribe(function(a){a=
d.getCellFromEvent(a);eXide.find.Modules.$triggerEvent("open",[f[a.row]])});d.onSort.subscribe(function(a,b){$.log("sorting on field: %s",b.sortCol.field);f.sort(function(a,c){var d=b.sortCol.field,e=a[d],d=c[d],e=(e==d?0:e>d?1:-1)*(b.sortAsc?1:-1);return 0!=e?e:0});d.invalidate();d.render()});$("#select-module-dialog").dialog({modal:!1,autoOpen:!1,height:400,width:600,open:eXide.find.Modules.$init})});return{select:function(a){var b={Open:function(){eXide.find.Modules.trigger("open");$(this).dialog("close")},
Cancel:function(){$(this).dialog("close")}};"xquery"==a&&(b.Import=function(){eXide.find.Modules.trigger("import");$(this).dialog("close")});$("#select-module-dialog").dialog("option","buttons",b);$("#select-module-dialog").dialog("open")},trigger:function(a){var b=d.getSelectionModel().getSelectedRows();1==b.length&&eXide.find.Modules.$triggerEvent(a,[f[b[0]]])},$init:function(){d.resizeCanvas();d.invalidate();f.length=0;$.getJSON("modules/find.xql",function(a){f.length=a.length;for(var b=0;b<a.length;b++)f[b]=
a[b];d.updateRowCount();d.render();d.setActiveCell(0,0);d.setSelectedRows([0]);$("#module-list").find(".grid-canvas").focus()})},addEventListener:function(b,c,d){(b=a[b])&&b.push({obj:c,callback:d})},$triggerEvent:function(b,c){var d=a[b];if(d)for(var f=0;f<d.length;f++)d[f].callback.apply(d[f].obj,c)}}}();eXide.namespace("eXide.util.Menubar");eXide.util.Menubar=function(){Constr=function(a){var b=this;this.container=a;var c=!1;$("ul li",this.container).click(function(a){a.stopPropagation();$("ul",this).css({display:"block"});c=!0});$("body").click(function(){c&&$("ul li ul",b.container).css({display:"none"})})};Constr.prototype.click=function(a,b){var c=this;$(a).click(function(a){a.preventDefault();$("ul li ul",c.container).css({display:"none"});menuVisible=!1;b()})};return Constr}();
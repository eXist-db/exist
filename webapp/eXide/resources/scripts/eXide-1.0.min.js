define("eXide/mode/xquery_highlight_rules",function(a,c){var d=a("ace/lib/oop"),f=a("ace/lib/lang"),e=a("ace/mode/text_highlight_rules").TextHighlightRules,b=function(){var e=f.arrayToMap("return|for|let|where|order|by|declare|function|variable|xquery|version|option|namespace|import|module|switch|default|if|then|else|as|and|or|typeswitch|case|ascending|descending|empty|in".split("|"));this.$rules={start:[{token:"text",regex:"<\\!\\[CDATA\\[",next:"cdata"},{token:"xml_pe",regex:"<\\?.*?\\?>"},{token:"comment",
regex:"<\\!--",next:"comment"},{token:"comment",regex:"\\(:",next:"comment"},{token:"text",regex:"<\\/?",next:"tag"},{token:"constant",regex:"[+-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"variable",regex:"\\$[a-zA-Z_][a-zA-Z0-9_\\-:]*\\b"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"},{token:"text",regex:"\\s+"},{token:"support.function",regex:"\\w[\\w+_\\-:]+(?=\\()"},{token:"keyword.operator",regex:"\\*|=|<|>|\\-|\\+|and|or|eq|ne|lt|gt"},{token:"lparen",regex:"[[({]"},
{token:"rparen",regex:"[\\])}]"},{token:function(a){return e[a]?"keyword":"identifier"},regex:"[a-zA-Z_$][a-zA-Z0-9_$]*\\b"}],tag:[{token:"text",regex:">",next:"start"},{token:"keyword",regex:"[-_a-zA-Z0-9:]+"},{token:"text",regex:"\\s+"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"}],cdata:[{token:"text",regex:"\\]\\]>",next:"start"},{token:"text",regex:"\\s+"},{token:"text",regex:"(?:[^\\]]|\\](?!\\]>))+"}],comment:[{token:"comment",regex:".*?--\>",next:"start"},{token:"comment",
regex:".*:\\)",next:"start"},{token:"comment",regex:".+"}]}};d.inherits(b,e);c.XQueryHighlightRules=b});
define("eXide/mode/behaviour/xquery",function(a,c){var d=a("ace/lib/oop"),f=a("ace/mode/behaviour").Behaviour,e=a("ace/mode/behaviour/cstyle").CstyleBehaviour,b=function(a){this.inherit(e,["braces","parens","string_dquotes"]);this.parent=a;this.add("brackets","insertion",function(e,a,b,f,c){return c=="\n"&&(a=b.getCursorPosition(),f.doc.getLine(a.row).substring(a.column,a.column+2)=="</")?(e=this.$getIndent(f.doc.getLine(a.row))+f.getTabString(),f=this.$getIndent(f.doc.getLine(a.row)),{text:"\n"+
e+"\n"+f,selection:[1,e.length,1,e.length]}):!1});this.add("slash","insertion",function(e,b,f,c,d){d=="/"&&(e=f.getCursorPosition(),b=c.doc.getLine(e.row),e.column>0&&b.charAt(e.column-1)=="<"&&(b=b.substring(0,e.column)+"/"+b.substring(e.column),f=c.doc.getAllLines(),f[e.row]=b,a.exec("closeTag",f.join(c.doc.getNewLineCharacter()),e.row)));return!1})};d.inherits(b,f);c.XQueryBehaviour=b});
define("eXide/mode/xquery",function(a,c){var d=a("ace/lib/oop"),f=a("ace/mode/text").Mode,e=a("ace/tokenizer").Tokenizer,b=a("eXide/mode/xquery_highlight_rules").XQueryHighlightRules,g=a("eXide/mode/behaviour/xquery").XQueryBehaviour,h=a("ace/range").Range,i=function(a){this.$tokenizer=new e((new b).getRules());this.$behaviour=new g(a)};d.inherits(i,f);(function(){this.getNextLineIndent=function(e,a,b){e=this.$getIndent(a);a.match(/\s*(?:then|else|return|[{\(]|<\w+>)\s*$/)&&(e+=b);return e};this.checkOutdent=
function(e,a,b){return!/^\s+$/.test(a)?!1:/^\s*[\}\)]/.test(b)};this.autoOutdent=function(e,a,b){e=a.getLine(b).match(/^(\s*[\}\)])/);if(!e)return 0;var e=e[1].length,f=a.findMatchingBracket({row:b,column:e});if(!f||f.row==b)return 0;f=this.$getIndent(a.getLine(f.row));a.replace(new h(b,0,b,e-1),f)};this.$getIndent=function(e){return(e=e.match(/^(\s+)/))?e[1]:""};this.toggleCommentLines=function(e,a,b,f){for(var c=!0,g=/^\s*\(:(.*):\)/,e=b;e<=f;e++)if(!g.test(a.getLine(e))){c=!1;break}for(var d=new h(0,
0,0,0),e=b;e<=f;e++)b=a.getLine(e),d.start.row=e,d.end.row=e,d.end.column=b.length,a.replace(d,c?b.match(g)[1]:"(:"+b+":)")}}).call(i.prototype);c.Mode=i});
define("eXide/mode/behaviour/xml",function(a,c){var d=a("ace/lib/oop"),f=a("ace/mode/behaviour").Behaviour,e=a("ace/mode/behaviour/cstyle").CstyleBehaviour;a("eXide/mode/behaviour/xquery");var b=function(a){this.inherit(e,["braces","parens","string_dquotes"]);this.parent=a;this.add("brackets","insertion",function(e,a,b,f,c){return c=="\n"&&(a=b.getCursorPosition(),f.doc.getLine(a.row).substring(a.column,a.column+2)=="</")?(e=this.$getIndent(f.doc.getLine(a.row))+f.getTabString(),f=this.$getIndent(f.doc.getLine(a.row)),
{text:"\n"+e+"\n"+f,selection:[1,e.length,1,e.length]}):!1});this.add("slash","insertion",function(e,b,f,c,d){d=="/"&&(e=f.getCursorPosition(),b=c.doc.getLine(e.row),e.column>0&&b.charAt(e.column-1)=="<"&&(b=b.substring(0,e.column)+"/"+b.substring(e.column),f=c.doc.getAllLines(),f[e.row]=b,a.exec("closeTag",f.join(c.doc.getNewLineCharacter()),e.row)));return!1})};d.inherits(b,f);c.XMLBehaviour=b});
define("eXide/mode/xml",function(a,c){var d=a("ace/lib/oop"),f=a("ace/mode/xml").Mode,e=a("ace/tokenizer").Tokenizer,b=a("ace/mode/xml_highlight_rules").XmlHighlightRules,g=a("eXide/mode/behaviour/xml").XMLBehaviour,h=a("ace/range").Range,i=function(a){this.$tokenizer=new e((new b).getRules());this.$behaviour=new g(a)};d.inherits(i,f);(function(){this.toggleCommentLines=function(e,a,b,f){for(var c=!0,d=/^\s*<\!--(.*)--\>/,e=b;e<=f;e++)if(!d.test(a.getLine(e))){c=!1;break}for(var g=new h(0,0,0,0),
e=b;e<=f;e++)b=a.getLine(e),g.start.row=e,g.end.row=e,g.end.column=b.length,a.replace(g,c?b.match(d)[1]:"<\!--"+b+"--\>")}}).call(i.prototype);c.Mode=i});
define("eXide/mode/html",function(a,c){var d=a("ace/lib/oop"),f=a("ace/mode/html").Mode,e=a("ace/tokenizer").Tokenizer,b=a("ace/mode/html_highlight_rules").HtmlHighlightRules,g=a("eXide/mode/behaviour/xml").XMLBehaviour,h=a("ace/range").Range,i=function(a){this.$tokenizer=new e((new b).getRules());this.$behaviour=new g(a)};d.inherits(i,f);(function(){this.toggleCommentLines=function(e,a,b,f){for(var c=!0,g=/^\s*<\!--(.*)--\>/,e=b;e<=f;e++)if(!g.test(a.getLine(e))){c=!1;break}for(var d=new h(0,0,0,
0),e=b;e<=f;e++)b=a.getLine(e),d.start.row=e,d.end.row=e,d.end.column=b.length,a.replace(d,c?b.match(g)[1]:"<\!--"+b+"--\>")}}).call(i.prototype);c.Mode=i});var eXide=eXide||{};eXide.namespace=function(a){var a=a.split("."),c=eXide,d;a[0]=="eXide"&&(a=a.slice(1));for(d=0;d<a.length;d++)typeof c[a[d]]=="undefined"&&(c[a[d]]={}),c=c[a[d]];return c};eXide.namespace("eXide.util");
eXide.util=function(){var a={dir1:"up",dir2:"left",firstpos1:15,firstpos2:15};return{popup:function(a,d,f,e){function b(e){h&&(h.empty(),e.find(".tooltip").each(function(){h.html($(this).html())}))}var g=$(a),h=d?$(d):null,i=null;f.sort(function(e,a){return e.label==a.label?0:e.label>a.label?1:-1});g.empty().css("display","block").focus();a=document.createElement("a");a.href="#";a.className="popup-close";a.appendChild(document.createTextNode("Close"));g.append(a);$(a).click(function(e){e.preventDefault();
g.css("display","none");h&&h.css("display","none")});a=document.createElement("ul");for(d=0;d<f.length;d++){var j=document.createElement("li");if(d==0)j.className="first";j.appendChild(document.createTextNode(f[d].label));if(f[d].tooltip){var l=document.createElement("span");l.className="tooltip";l.appendChild(document.createTextNode(f[d].tooltip));j.appendChild(l)}a.appendChild(j);$(j).click(function(){i.removeClass("selection");$(this).addClass("selection");i=$(this);b(i)});$(j).dblclick(function(){var a=
g.find("li").index(i);g.css("display","none");h&&h.css("display","none");e.call(null,f[a])})}g.append(a);i=g.find("ul li:first").addClass("selection");b(i);var m=$(a).css("position","absolute").scrollTop(0);h&&h.css({display:"block",top:m.offset().top+"px"});var o=m.innerHeight();$(g).keydown(function(a){a.preventDefault();if(a.which==40)a=i.next(),a.length>0&&(i.removeClass("selection"),a.addClass("selection"),i=a,a.position().top+a.height()>=o&&a.get(0).scrollIntoView(),b(a));else if(a.which==38)a=
i.prev(),a.length>0&&(i.removeClass("selection"),a.addClass("selection"),i=a,a.hasClass("first")?m.scrollTop(0):a.position().top<0&&a.get(0).scrollIntoView(),b(a));else if(a.which==13){var c=g.find("li").index(i);g.css("display","none");h&&h.css("display","none");$(g).unbind(a);e.call(null,f[c])}else return g.css("display","none"),h&&h.css("display","none"),$(g).unbind(a),e.call(null,null),!0;return!1})},supportsHtml5Storage:function(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return!1}},
normalizePath:function(a){for(var a=a.replace(/^xmldb:exist:\/\//,""),d=[],a=a.split("/"),f=a.length-1;f>-1;f--)a[f]==".."?f--:d.push(a[f]);return d.reverse().join("/")},parseSignature:function(a){var d=a.indexOf("(");if(d>-1){var f=a.substring(0,d+1),a=a.substring(d);if(a=a.match(/\$[\w:-_]+/g))for(d=0;d<a.length;d++)d>0&&(f+=", "),f+=a[d];f+=")";return f}return a},message:function(c){$.pnotify({pnotify_text:c,pnotify_shadow:!0,pnotify_hide:!0,pnotify_closer:!0,pnotify_opacity:0.75,pnotify_addclass:"stack-bottomright",
pnotify_stack:a})},error:function(c,d){var f={pnotify_text:c,pnotify_type:"error",pnotify_shadow:!0,pnotify_hide:!0,pnotify_addclass:"stack-bottomright",pnotify_stack:a};if(d)f.pnotify_title=d;$.pnotify(f)}}}();eXide.namespace("eXide.util.Dialog");
eXide.util.Dialog=function(){var a,c=null;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-message">\t<img id="eXide-dialog-message-icon" src="resources/images/error.png"/>\t<div id="eXide-dialog-message-body"></div></div>');a=$("#eXide-dialog-message");a.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close")}}});$(document.body).append('<div id="eXide-dialog-input">\t<img id="eXide-dialog-input-icon" src="resources/images/information.png"/>\t<div id="eXide-dialog-input-body"></div></div>');
inputDialog=$("#eXide-dialog-input");inputDialog.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close");c!=null&&c.apply($("eXide-dialog-input-body"),[])},Cancel:function(){$(this).dialog("close")}}})});return{message:function(d,f){f==null&&(f="");a.dialog("option","title",d);$("#eXide-dialog-message-body").html(f);$("#eXide-dialog-message-icon").attr("src","resources/images/information.png");a.dialog("open")},warning:function(d,f){f==null&&(f="");a.dialog("option","title",d);
$("#eXide-dialog-message-body").html(f);$("#eXide-dialog-message-icon").attr("src","resources/images/error.png");a.dialog("open")},input:function(a,f,e){c=e;inputDialog.dialog("option","title",a);$("#eXide-dialog-input-body").html(f);inputDialog.dialog("open")}}}();eXide.namespace("eXide.util.mimeTypes");
eXide.util.mimeTypes=function(){var a={xml:["text/xml","application/xml","application/xhtml+xml"],xquery:["application/xquery"],css:["text/css"],html:["text/html"],javascript:["application/x-javascript"]};return{getMime:function(a){var d=a.indexOf(";");d>-1&&(a=a.substring(0,d));return a},getLangFromMime:function(c){for(var d in a)for(var f=a[d],e=0;e<f.length;e++)if(c==f[e])return d;return"xquery"},getMimeFromLang:function(c){return(c=a[c])?c[0]:"application/xquery"}}}();eXide.namespace("eXide.util.oop");
eXide.util.oop.inherit=function(){var a=function(){};return function(c,d){a.prototype=d.prototype;c.prototype=new a;c.super_=d.prototype;c.prototype.constructor=c}}();eXide.util.oop.extend=function(){return function(a,c){for(var d in c)c.hasOwnProperty(d)&&(a[d]=c[d])}}();(function(a){a.log=function(){window.console&&window.console.log&&console.log.apply(window.console,arguments)};a.fn.log=function(){a.log(this);return this}})(jQuery);eXide.namespace("eXide.events.Sender");eXide.events.Sender=function(){Constr=function(){};Constr.prototype={addEventListener:function(a,c,d){this.events=this.events||{};var f=this.events[a];f||(f=[],this.events[a]=f);f.push({obj:c,callback:d})},$triggerEvent:function(a,c){this.events=this.events||{};var d=this.events[a];if(d)for(var f=0;f<d.length;f++)d[f].callback.apply(d[f].obj,c)}};return Constr}();eXide.namespace("eXide.edit.commands");
eXide.edit.commands=function(){function a(a,f){return{win:a,mac:f,sender:"editor"}}var c=require("ace/lib/useragent");return{init:function(d){var f=d.editor.commands;$.log("commands: %o",f);f.addCommand({name:"saveDocument",bindKey:a("Ctrl-Shift-S","Command-Shift-S"),exec:function(){eXide.app.saveDocument()}});f.addCommand({name:"runQuery",bindKey:a("Ctrl-Return","Command-Return"),exec:function(){eXide.app.runQuery()}});f.addCommand({name:"openDocument",bindKey:a("Ctrl-Shift-O","Command-Shift-O"),
exec:function(){eXide.app.openDocument()}});f.addCommand({name:"newDocument",bindKey:a("Ctrl-Shift-N","Command-Shift-N"),exec:function(){eXide.app.newDocument()}});f.addCommand({name:"closeDocument",bindKey:a("Ctrl-Shift-W","Command-Shift-W"),exec:function(){eXide.app.closeDocument()}});f.addCommand({name:"autocomplete",bindKey:a("Ctrl-Space","Ctrl-Space"),exec:function(){d.autocomplete()}});f.addCommand({name:"nextTab",bindKey:a("Ctrl-Shift-PageDown","Command-Shift-PageDown"),exec:function(){d.nextTab()}});
f.addCommand({name:"previousTab",bindKey:a("Ctrl-Shift-PageUp","Command-Shift-PageUp"),exec:function(){d.previousTab()}});f.addCommand({name:"functionDoc",bindKey:a("F1","F1"),exec:function(){d.exec("showFunctionDoc")}});f.addCommand({name:"gotoDefinition",bindKey:a("F3","F3"),exec:function(){d.exec("gotoDefinition")}});f.addCommand({name:"searchIncremental",bindKey:a("Ctrl-F","Command-F"),exec:function(){d.quicksearch.start()}});f.addCommand({name:"findModule",bindKey:a("F4","F4"),exec:function(){var e=
d.getActiveDocument();eXide.find.Modules.select(e.syntax)}});f.addCommand({name:"indentOrParam",bindKey:a("Tab","Tab"),exec:function(){var e=d.getActiveDocument();(!e.template||!e.template.nextParam())&&d.editor.indent()}});f.addCommand({name:"escape",bindKey:a("Esc","Esc"),exec:function(){d.getActiveDocument().template=null;d.editor.clearSelection()}});f.addCommand({name:"dbManager",bindKey:a("Ctrl-Shift-M","Command-Shift-M"),exec:function(){eXide.app.manage()}})},help:function(a,f){$(a).find("table").each(function(){this.innerHTML=
"";var e=f.editor.commands;for(key in e.commands){var a=e.commands[key],g=document.createElement("tr"),d=document.createElement("td");d.appendChild(document.createTextNode(a.name));g.appendChild(d);d=document.createElement("td");a.bindKey&&(c.isMac?d.appendChild(document.createTextNode(a.bindKey.mac)):d.appendChild(document.createTextNode(a.bindKey.win)));g.appendChild(d);this.appendChild(g)}})}}}();eXide.namespace("eXide.edit.ModeHelper");eXide.edit.ModeHelper=function(){Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.commands={}};Constr.prototype={addCommand:function(a,c){if(!this.commands)this.commands={};this.commands[a]=c},exec:function(a,c,d){if(this.commands&&this.commands[a]){for(var c=[c],f=0;f<d.length;f++)c.push(d[f]);$.log("Calling command %s ...",a);this.commands[a].apply(this,c)}else eXide.util.message("Not supported in this mode.")}};return Constr}();eXide.namespace("eXide.edit.XQueryModeHelper");
eXide.edit.XQueryModeHelper=function(){function a(a){var e;e=a.line?a["#text"]:a;var b=d.exec(e),g=-1;b?g=parseInt(b[1])-1:a.line&&(g=parseInt(a.line)-1);return{line:g,msg:e}}var c=/^[\$\w:\-_\.]+/;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("showFunctionDoc",this.showFunctionDoc);this.addCommand("gotoDefinition",this.gotoDefinition);this.addCommand("locate",this.locate);this.addCommand("closeTag",this.closeTag);this.addCommand("importModule",this.importModule)};
eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.closeTag=function(f,e,b){var f="xmldb:exist://"+f.getBasePath(),d=this;$.ajax({type:"POST",url:"modules/compile.xql",data:{q:e,base:f},dataType:"json",success:function(e){e.result=="fail"&&(e=a(e.error),e.line<=b&&(e=/constructor:\s(.*)$/.exec(e.msg),e.length>0&&d.editor.insert(e[1]+">")))},error:function(){}})};Constr.prototype.validate=function(a,e,b){$.log("Running validation...");var d=this,c="xmldb:exist://"+a.getBasePath();
$.ajax({type:"POST",url:"modules/compile.xql",data:{q:e,base:c},dataType:"json",success:function(e){d.compileError(e,a);b.call(this,!0)},error:function(e,a){b.call(this,!0);$.log("Compile error: %s - %s",a,e.responseText)}})};Constr.prototype.compileError=function(f,e){if(f.result=="fail"){var b=a(f.error),d=[{row:b.line,text:b.msg,type:"error"}];this.parent.updateStatus(b.msg,e.getPath()+"#"+b.line);e.getSession().setAnnotations(d)}else this.parent.clearErrors(),this.parent.updateStatus("")};Constr.prototype.autocomplete=
function(a){require("pilot/lang");for(var e=require("ace/range").Range,b=this.editor.getSelection(),d=a.getSession(),b=b.getSelectionLead(),d=d.getDisplayLine(b.row),c=b.column-1,i=b.column;c>=0;){var j=d.substring(c,i);if(j.match(/^\$[\w:\-_\.]+$/))break;if(!j.match(/^[\w:\-_\.]+$/)){c++;break}c--}d=d.substring(c,i);$.log("completing token: %s",d);e=new e(b.row,c,b.row,i);b=this.editor.renderer.textToScreenCoordinates(b.row,b.column);c=this.parent.getHeight();if(b.pageY+150>c)b.pageY=c-150,$.log("window height: %i, pageY: %i",
c,b.pageY);$("#autocomplete-box").css({left:b.pageX+"px",top:b.pageY+10+"px"});$("#autocomplete-help").css({left:b.pageX+324+"px",top:b.pageY+10+"px"});d.length==0?this.templateLookup(a,d,e,!0):this.functionLookup(a,d,e,!0);return!0};Constr.prototype.$localVars=function(a,e){for(var b=[],d=/declare function|};/,c=/let \$[\w\:]+|for \$[\w\:]+|\$[\w\:]+\)/,i=/\$[\w\:]+/,j=RegExp("^\\"+a),l=this.editor.getSession(),m=e.start.row;m>-1;){var o=l.getDisplayLine(m),p;if(p=o.match(c))$.log("Var: %s",p[0]),
p=p[0].match(i),p[0].match(j)&&b.push({name:p[0],type:"variable"});if(o.match(d)){$.log("Stop: %s",o);break}m--}return b};Constr.prototype.functionLookup=function(a,e,b,d){var c=this;$.ajax({url:"modules/docs.xql",dataType:"text",type:"POST",data:{prefix:e},success:function(i){var i=$.parseJSON(i),j=[],l;e.substring(0,1)=="$"?(l="^\\"+e,j=c.$localVars(e,b,d)):l="^"+e;var m=RegExp(l);$.each(a.functions,function(a,e){e.name.match(m)&&j.push(e)});i&&(j=j.concat(i));i=[];for(l=0;l<j.length;l++){var o=
{label:j[l].signature?j[l].signature:j[l].name,type:j[l].type};if(j[l].help)o.tooltip=j[l].help;i.push(o)}c.$addTemplates(e,i);c.$showPopup(a,b,i)},error:function(a,e){eXide.util.error(e)}})};Constr.prototype.templateLookup=function(a,e,b){var d=[];this.$addTemplates(e,d);this.$showPopup(a,b,d)};Constr.prototype.$addTemplates=function(a,e){for(var b=this.parent.outline.getTemplates(a),d=0;d<b.length;d++)e.push({type:"template",label:"[S] "+b[d].name,tooltip:b[d].help,template:b[d].template})};Constr.prototype.$showPopup=
function(a,e,b){var d=this;eXide.util.popup($("#autocomplete-box"),$("#autocomplete-help"),b,function(b){if(b){var c=b.label;b.type=="template"?c=b.template:b.type=="function"&&(c=eXide.util.parseSignature(c));a.template=new eXide.edit.Template(d.parent,e,c,b.type);a.template.insert()}d.editor.focus()})};Constr.prototype.getFunctionAtCursor=function(a){var e=a.row,e=this.editor.getSession().getDisplayLine(e),b=a.column;do b--;while(b>=0&&e.charAt(b).match(c));b++;for(a=a.column;a<e.length&&e.charAt(a).match(c);)a++;
return e.substring(b,a)};Constr.prototype.showFunctionDoc=function(a){var e=this.editor.getSelection().getSelectionLead(),b=this.editor.renderer.textToScreenCoordinates(e.row,e.column);$("#autocomplete-box").css({left:b.pageX+"px",top:b.pageY+20+"px"});$("#autocomplete-help").css({left:b.pageX+324+"px",top:b.pageY+20+"px"});e=this.getFunctionAtCursor(e);this.functionLookup(a,e,null,!1)};Constr.prototype.gotoDefinition=function(a){var e=this.getFunctionAtCursor(this.editor.getSelection().getSelectionLead());
e&&this.parent.outline.gotoDefinition(a,e)};Constr.prototype.locate=function(a,e,b){switch(e){case "function":this.gotoFunction(a,b);break;default:this.gotoVarDecl(a,b)}};Constr.prototype.gotoFunction=function(a,e){$.log("Goto function %s",e);var b=this.getModuleNamespacePrefix();b!=null&&(e=e.replace(/[^:]+:/,b+":"));for(var b=RegExp("function\\s+"+e+"\\s*\\("),d=a.$session.getLength(),c=0;c<d;c++)if(a.$session.getLine(c).match(b)){this.editor.gotoLine(c+1);this.editor.focus();break}};Constr.prototype.gotoVarDecl=
function(a,e){var b=this.getModuleNamespacePrefix();b!=null&&(e=e.replace(/[^:]+:/,"$"+b+":"));$.log("Goto variable declaration %s",e);for(var b=RegExp("variable\\s+\\"+e),d=a.$session.getLength(),c=0;c<d;c++)if(a.$session.getLine(c).match(b)){this.editor.gotoLine(c+1);this.editor.focus();break}};Constr.prototype.getModuleNamespacePrefix=function(){for(var a=/^\s*module\s+namespace\s+([^=\s]+)\s*=/,e=this.parent.getActiveDocument().$session.getLength(),b=0;b<e;b++){var d=this.parent.getActiveDocument().$session.getLine(b).match(a);
if(d)return d[1]}return null};Constr.prototype.importModule=function(a,e,b,d){$.log("location = %s path = %s",d,a.path);a=a.getBasePath();d=d.lastIndexOf(a,0)===0?d.substring(a.length+1):"xmldb:exist://"+d;this.editor.insert("import module namespace "+e+'="'+b+'" at "'+d+'";\n')};var d=/.*line:?\s(\d+)/i;return Constr}();eXide.namespace("eXide.edit.XMLModeHelper");
eXide.edit.XMLModeHelper=function(){Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("closeTag",this.closeTag)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.closeTag=function(a,c,d){a.getBasePath();var f=this;$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:c},dataType:"json",success:function(a){a.status&&a.status=="invalid"&&parseInt(a.message.line)-1<=d&&(a=/element type \"([^\"]+)\"/.exec(a.message["#text"]),a.length>0&&f.editor.insert(a[1]+
">"))},error:function(){}})};Constr.prototype.validate=function(a,c,d){var f=this;$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:c},dataType:"json",success:function(e){f.compileError(e,a);d.call(this,!0)},error:function(a,b){d.call(this,!0);$.log("Compile error: %s - %s",b,a.responseText)}})};Constr.prototype.compileError=function(a,c){$.log("Validation returned %o",a);if(a.status&&a.status=="invalid"){var d=[{row:parseInt(a.message.line)-1,text:a.message["#text"],type:"error"}];$.log("annotation: %o",
d);this.parent.updateStatus(a.message["#text"],c.getPath()+"#"+a.message.line);c.getSession().setAnnotations(d)}else this.parent.clearErrors(),this.parent.updateStatus("")};return Constr}();eXide.namespace("eXide.edit.Outline");
eXide.edit.Outline=function(){Constr=function(){this.funcDefRe=/declare\s+function\s+([^\(]+)\(/g;this.varDefRe=/declare\s+variable\s+\$[^\s;]+/gm;this.varRe=/declare\s+variable\s+(\$[^\s;]+)/;this.parseImportRe=/import\s+module\s+namespace\s+[^=]+\s*=\s*["'][^"']+["']\s*at\s+["'][^"']+["']\s*;/g;this.moduleRe=/import\s+module\s+namespace\s+([^=\s]+)\s*=\s*["']([^"']+)["']\s*at\s+["']([^"']+)["']\s*;/;this.currentDoc=null;this.templates=[];this.$loadTemplates()};Constr.prototype={getTemplates:function(a){for(var a=
RegExp("^"+a),c=[],d=0;d<this.templates.length;d++)this.templates[d].name.match(a)&&c.push(this.templates[d]);return c},gotoDefinition:function(a,c){$.each(a.functions,function(a,f){c==f.name&&eXide.app.locate(f.type,f.source==""?null:f.source,c)})},updateOutline:function(a){this.currentDoc=a;a.functions=[];$("#outline").empty();if(a.getMime()=="application/xquery"){var c=a.getText();this.$parseLocalFunctions(c,a);this.$outlineUpdate(a);(c=this.$parseImports(c))&&this.$resolveImports(a,c)}},clearOutline:function(){$("#outline").empty()},
$parseLocalFunctions:function(a,c){for(c.functions=[];;){var d=this.funcDefRe.exec(a);if(d==null)break;var f=this.funcDefRe.lastIndex,e=this.$findMatchingParen(a,f);c.functions.push({type:"function",name:d[1],signature:d[1]+"("+a.substring(f,e)+")"})}if(d=a.match(this.varDefRe))for(f=0;f<d.length;f++)e=this.varRe.exec(d[f]),c.functions.push({type:"variable",name:e[1]})},$findMatchingParen:function(a,c){for(var d=1,f=c;f<a.length;f++){var e=a.charAt(f);if(e==")"){if(d-=1,d==0)return f}else e=="("&&
(d+=1)}return-1},$parseImports:function(a){return a.match(this.parseImportRe)},$resolveImports:function(a,c){for(var d=this,f=[],e=[],b=0;b<c.length;b++){var g=this.moduleRe.exec(c[b]);g!=null&&g.length==4&&(e.push("prefix="+encodeURIComponent(g[1])),e.push("uri="+encodeURIComponent(g[2])),e.push("source="+encodeURIComponent(g[3])))}b="xmldb:exist://"+a.getBasePath();e.push("base="+encodeURIComponent(b));$.ajax({url:"outline",dataType:"json",type:"POST",data:e.join("&"),success:function(e){if(e!=
null){for(var e=e.modules,b=0;b<e.length;b++){var c=e[b].functions;if(c)for(var g=0;g<c.length;g++)f.push({type:"function",name:c[g].name,signature:c[g].signature,source:e[b].source});if(c=e[b].variables)for(g=0;g<c.length;g++)f.push({type:"variable",name:"$"+c[g],source:e[b].source})}a.functions=a.functions.concat(f);d.$outlineUpdate(a)}}});return f},$sortFunctions:function(a){a.functions.sort(function(a,d){return a.name==d.name?0:a.name>d.name?1:-1})},$outlineUpdate:function(a){this.$sortFunctions(a);
if(this.currentDoc==a){$("body").layout().open("west");eXide.app.resize();var c=$("#outline");c.empty();for(var d=0;d<a.functions.length;d++){var f=a.functions[d],e=document.createElement("li"),b=document.createElement("a");if(f.signature)b.title=f.signature;b.className=f.type=="function"?"t_function":"t_variable";b.href=f.source?"#"+f.source:"#";b.appendChild(document.createTextNode(f.name));e.appendChild(b);c.append(e);$(b).click(function(){var a=this.hash.substring(1);this.className=="t_function"?
eXide.app.locate("function",a==""?null:a,$(this).text()):eXide.app.locate("variable",a==""?null:a,$(this).text());return!1})}}},$loadTemplates:function(){var a=this;$.ajax({url:"templates/snippets.xml",dataType:"xml",type:"GET",success:function(c){$(c).find("snippet").each(function(){var d=$(this),c=d.attr("abbrev"),e=d.find("description").text(),d=d.find("code").text();a.templates.push({TYPE:"template",name:c,help:e,template:d})})}})}};return Constr}();eXide.namespace("eXide.edit.Document");
eXide.edit.Document=function(){Constr=function(a,c,d){this.name=a;this.path=c;this.mime="application/xquery";this.syntax="xquery";this.saved=!1;this.editable=!0;this.functions=[];this.helper=null;this.history=[];this.$session=d;a=eXide.app.getPreferences().softWrap;this.$session.setUseWrapMode(a!=0);a>0?this.$session.setWrapLimitRange(a,a):a<0&&this.$session.setWrapLimitRange(null,null)};Constr.prototype.getText=function(){return this.$session.getValue()};Constr.prototype.getName=function(){return this.name};
Constr.prototype.getPath=function(){return this.path};Constr.prototype.setPath=function(a){this.path=a};Constr.prototype.getBasePath=function(){return this.path.replace(/(^.+)\/[^\/]*$/,"$1")};Constr.prototype.getMime=function(){return this.mime};Constr.prototype.getSyntax=function(){return this.syntax};Constr.prototype.getSession=function(){return this.$session};Constr.prototype.isSaved=function(){return this.saved};Constr.prototype.isEditable=function(){return this.editable};Constr.prototype.isXQuery=
function(){return this.mime=="application/xquery"};Constr.prototype.setModeHelper=function(a){this.helper=a};Constr.prototype.getModeHelper=function(){return this.helper};Constr.prototype.addToHistory=function(a){this.history.push(a)};Constr.prototype.getLastLine=function(){return this.history.pop(line)};Constr.prototype.getCurrentLine=function(){return this.$session.getSelection().getSelectionLead().row};return Constr}();eXide.namespace("eXide.edit.Editor");
eXide.edit.Editor=function(){var a=require("ace/virtual_renderer").VirtualRenderer,c=require("ace/editor").Editor,d=require("ace/edit_session").EditSession,f=require("ace/undomanager").UndoManager;Constr=function(e){var b=this;b.container=e;b.documents=[];b.activeDoc=null;b.tabCounter=0;b.newDocCounter=0;b.pendingCheck=!1;b.themes={};e=new a(b.container,"ace/theme/eclipse");e.setShowGutter(!0);this.editor=new c(e);this.editor.setBehavioursEnabled(!0);eXide.edit.commands.init(b);this.outline=new eXide.edit.Outline;
this.addEventListener("activate",this.outline,this.outline.updateOutline);this.addEventListener("validate",this.outline,this.outline.updateOutline);this.addEventListener("close",this.outline,this.outline.clearOutline);this.status=document.getElementById("error-status");$(this.status).click(function(a){a.preventDefault();var e=this.pathname,a=this.hash.substring(1);if(e=b.getDocument(e))b.switchTo(e),b.editor.gotoLine(parseInt(a)+1)});this.quicksearch=new eXide.find.IncrementalSearch($("#search-box"),
this.editor);$("#tab-next").button({icons:{primary:"ui-icon-triangle-1-e"},text:!1}).click(function(){b.nextTab()});$("#tab-prev").button({icons:{primary:"ui-icon-triangle-1-w"},text:!1}).click(function(){b.previousTab()});this.lastChangeEvent=(new Date).getTime();this.validateTimeout=null;b.modes={xquery:new eXide.edit.XQueryModeHelper(b),xml:new eXide.edit.XMLModeHelper(b),html:new eXide.edit.XMLModeHelper(b)}};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.init=function(){this.documents.length==
0&&this.newDocument()};Constr.prototype.exec=function(){if(this.activeDoc.getModeHelper()){var a=Array.prototype.slice.call(arguments,1);this.activeDoc.getModeHelper().exec(arguments[0],this.activeDoc,a)}else eXide.util.message("Not supported in this mode.")};Constr.prototype.getActiveDocument=function(){return this.activeDoc};Constr.prototype.getText=function(){return this.activeDoc.getText()};Constr.prototype.newDocument=function(a){for(var b=0,c=0;c<this.documents.length;c++)this.documents[c].path.match(/^__new__(\d+)/)&&
(b=parseInt(RegExp.$1));b++;a=typeof a=="string"?new d(a):new d('xquery version "1.0";\n');this.$initDocument(new eXide.edit.Document("new-document "+b,"__new__"+b,a))};Constr.prototype.newDocumentWithText=function(a,b,c){a=new eXide.edit.Document(c.name,c.path,new d(a));a.editable=c.writable;a.mime=b;a.syntax=eXide.util.mimeTypes.getLangFromMime(b);a.saved=!1;c.line&&(a.addToHistory(c.line),this.editor.gotoLine(c.line));this.$initDocument(a)};Constr.prototype.openDocument=function(a,b,c){c.writable?
eXide.util.message("Opening "+c.path):eXide.util.message("Opening "+c.path+" readonly!");a=new eXide.edit.Document(c.name,c.path,new d(a));a.editable=c.writable;a.mime=b;a.syntax=eXide.util.mimeTypes.getLangFromMime(b);a.saved=!0;c.line&&(a.addToHistory(c.line),b=a.$session.getSelection(),b.clearSelection(),b.moveCursorTo(c.line,1),a.$session.setScrollTop(c.line));$.log("opening %s, mime: %s, syntax: %s, line: %i",c.name,a.mime,a.syntax,c.line);this.$initDocument(a)};Constr.prototype.$initDocument=
function(a){var b=this;b.$setMode(a);a.$session.setUndoManager(new f);a.$session.addEventListener("change",function(){if(a.saved)a.saved=!1,b.updateTabStatus(a.path,a);b.triggerCheck()});b.addTab(a);b.editor.setSession(a.$session);b.editor.resize();b.editor.focus()};Constr.prototype.setMode=function(a){this.activeDoc.syntax=a;this.$setMode(this.activeDoc,!0)};Constr.prototype.$setMode=function(a,b){switch(a.getSyntax()){case "xquery":var c=require("eXide/mode/xquery").Mode;a.$session.setMode(new c(this));
if(b)a.mime="application/xquery";break;case "xml":c=require("eXide/mode/xml").Mode;a.$session.setMode(new c(this));if(b)a.mime="application/xml";break;case "html":c=require("eXide/mode/html").Mode;a.$session.setMode(new c(this));if(b)a.mime="text/html";break;case "javascript":c=require("ace/mode/javascript").Mode;a.$session.setMode(new c);if(b)a.mime="application/x-javascript";break;case "css":if(c=require("ace/mode/css").Mode,a.$session.setMode(new c),b)a.mime="text/css"}a.setModeHelper(this.modes[a.getSyntax()])};
Constr.prototype.closeDocument=function(){this.$triggerEvent("close",[this.activeDoc]);$('#tabs a[title="'+this.activeDoc.path+'"]').parent().remove();for(var a=0;a<this.documents.length;a++)this.documents[a].path==this.activeDoc.path&&this.documents.splice(a,1);this.documents.length==0?this.newDocument():(this.activeDoc=this.documents[this.documents.length-1],$('#tabs a[title="'+this.activeDoc.path+'"]').addClass("active"),this.editor.setSession(this.activeDoc.$session),this.editor.resize(),this.$triggerEvent("activate",
[this.activeDoc]))};Constr.prototype.saveDocument=function(a,b,c){var d=this,f=d.activeDoc.path,j=d.activeDoc.name;if(a)d.activeDoc.path=a.path,d.activeDoc.name=a.name;eXide.util.message("Storing resource "+d.activeDoc.name+"...");a={path:d.activeDoc.path,data:d.activeDoc.getText()};if(d.activeDoc.mime)a.mime=d.activeDoc.mime;$.ajax({url:"modules/store.xql",type:"POST",data:a,dataType:"json",success:function(a){a.status=="error"?c?c.apply(d.activeDoc,[a.message]):eXide.util.error(a.message):(d.activeDoc.saved=
!0,d.updateTabStatus(f,d.activeDoc),b?b.apply(d.activeDoc):eXide.util.message(d.activeDoc.name+" stored."))},error:function(a){d.activeDoc.path=f;d.activeDoc.name=j;c?c.apply(d.activeDoc,a.responseText):eXide.util.error(a.responseText)}})};Constr.prototype.getDocument=function(a){for(var a=eXide.util.normalizePath(a),b=0;b<this.documents.length;b++)if(this.documents[b].path==a)return this.documents[b]};Constr.prototype.onInput=function(a,b){var c=a.getModeHelper();if(c&&c.onInput)c.onInput(a,b)};
Constr.prototype.autocomplete=function(){var a=this.activeDoc.getModeHelper();a&&a.autocomplete&&a.autocomplete(this.activeDoc)};Constr.prototype.getHeight=function(){return $(this.container).height()};Constr.prototype.resize=function(){this.editor.resize()};Constr.prototype.clearErrors=function(){this.editor.getSession().clearAnnotations()};Constr.prototype.forEachDocument=function(a){for(var b=0;b<this.documents.length;b++)a(this.documents[b])};Constr.prototype.addTab=function(a){var b=this,c="t"+
b.tabCounter++,d=a.name;a.saved||(d+="*");$("#tabs li a").removeClass("active");var f=document.createElement("li"),j=document.createElement("a");j.appendChild(document.createTextNode(d));j.className="tab active";j.id=c;j.title=a.path;f.appendChild(j);$("#tabs").append(f);$(j).click(function(c){c.preventDefault();b.switchTo(a)});b.activeDoc=a;b.documents.push(a);b.$triggerEvent("activate",[a]);b.scrollToTab($(j))};Constr.prototype.nextTab=function(){if(!(this.documents.length<2)){for(var a=0,b=0;b<
this.documents.length;b++)if(this.documents[b]==this.activeDoc){a=b;break}a==this.documents.length-1?a=0:a++;this.switchTo(this.documents[a])}};Constr.prototype.previousTab=function(){if(!(this.documents.length<2)){for(var a=0,b=0;b<this.documents.length;b++)if(this.documents[b]==this.activeDoc){a=b;break}a==0?a=this.documents.length-1:a--;this.switchTo(this.documents[a])}};Constr.prototype.switchTo=function(a){this.editor.setSession(a.$session);this.editor.resize();this.activeDoc=a;var b=this;$("#tabs a").each(function(){var c=
$(this);this.title==a.path?(c.addClass("active"),b.scrollToTab(c)):c.removeClass("active")});this.updateStatus("");this.$triggerEvent("activate",[a])};Constr.prototype.updateTabStatus=function(a,b){var c;c=b.saved?b.name:b.name+"*";$('#tabs a[title="'+a+'"]').attr("title",b.path).text(c)};Constr.prototype.scrollToTab=function(a){var b=a.offset().left,a=b+a.outerWidth(),c=$("#tabs").innerWidth(),d=$("#tabs").scrollLeft();a>c?($("#tab-next").show(),$("#tab-prev").show(),$("#tabs").scrollLeft(a-c)):
b<d&&(b<c?$("#tabs").scrollLeft(0):$("#tabs").scrollLeft(b));$.log("Scrolling to %d %d",b,$("#tabs").scrollLeft())};Constr.prototype.setTheme=function(a){$.log("Changing theme to %s",a);var b=this;b.loadTheme(a,function(){b.editor.setTheme("ace/theme/"+a)})};Constr.prototype.loadTheme=function(a,b){if(this.themes[a])return b();require("ace/lib/net");this.themes[a]=1;var c="resources/scripts/ace/theme-"+a.split("/").pop()+".js",d=document.getElementsByTagName("head")[0],f=document.createElement("script");
f.src=c;d.appendChild(f);f.onload=b};Constr.prototype.updateStatus=function(a,b){this.status.innerHTML=a;if(b)this.status.href=b};Constr.prototype.triggerCheck=function(){if(this.activeDoc.getModeHelper()){var a=this;if(!a.pendingCheck){var b=(new Date).getTime();a.validateTimeout&&b-a.lastChangeEvent<2E3&&clearTimeout(a.validateTimeout);a.lastChangeEvent=b;a.validateTimeout=setTimeout(function(){a.validate.apply(a)},2E3)}}};Constr.prototype.validate=function(){var a=this,b=a.activeDoc.getModeHelper();
if(b&&b.validate)a.pendingCheck=!0,$.log("Running validation..."),b.validate(a.activeDoc,a.getText(),function(){a.pendingCheck=!1}),a.$triggerEvent("validate",[a.activeDoc])};Constr.prototype.evalError=function(a){var b=/.*line\s(\d+)/i.exec(a),c=-1;b&&(c=parseInt(b[1]));$.log("error in line %d",b[1]);this.editor.focus();this.editor.gotoLine(c);b=[{row:c-1,text:a,type:"error"}];this.updateStatus(a);this.editor.getSession().setAnnotations(b)};Constr.prototype.focus=function(){this.editor.focus()};
Constr.prototype.saveState=function(){var a=0;$.each(this.documents,function(b,c){c.path.match("^__new__.*")?(localStorage["eXide."+a+".path"]=c.path,localStorage["eXide."+a+".name"]=c.name,localStorage["eXide."+a+".mime"]=c.mime,localStorage["eXide."+a+".data"]=c.getText(),localStorage["eXide."+a+".last-line"]=c.getCurrentLine()):(localStorage["eXide."+a+".path"]=c.path,localStorage["eXide."+a+".name"]=c.name,localStorage["eXide."+a+".mime"]=c.mime,localStorage["eXide."+a+".writable"]=c.editable?
"true":"false",localStorage["eXide."+a+".last-line"]=c.getCurrentLine(),c.saved||(localStorage["eXide."+a+".data"]=c.getText()));a++});localStorage["eXide.documents"]=a};return Constr}();$(document).ready(function(){var a=function(a){if(a=="")return{};for(var d={},f=0;f<a.length;++f){var e=a[f].split("=");e.length==2&&(d[e[0]]=decodeURIComponent(e[1].replace(/\+/g," ")))}return d}(window.location.search.substr(1).split("&"));eXide.app.init(function(c){var d=a.open,f=a.snip;d&&!c[d]?eXide.app.findDocument(a.open):f&&eXide.app.newDocument(f)})});eXide.namespace("eXide.app");
eXide.app=function(){var a,c,d,f=0,e=0,b=0,g=0,h={theme:"ace/theme/dawn",fontSize:"12px",showInvisibles:!1,showPrintMargin:!0,showHScroll:!1,softWrap:"free"};return{init:function(b){a=new eXide.edit.Editor(document.getElementById("editor"));c=new eXide.edit.PackageEditor(document.getElementById("deployment-editor"));d=new eXide.browse.Browser(document.getElementById("open-dialog"));eXide.app.initGUI();var e=eXide.app.restoreState();a.init();a.addEventListener("outlineChange",eXide.app.onOutlineChange);
eXide.app.resize();$(window).resize(eXide.app.resize);$(window).unload(function(){eXide.app.saveState()});eXide.find.Modules.addEventListener("open",null,function(a){eXide.app.findDocument(a.at)});eXide.find.Modules.addEventListener("import",null,function(b){a.exec("importModule",b.prefix,b.uri,b.at)});b&&b(e)},resize:function(){$("#editor");$(".header");a.resize()},newDocument:function(b){a.newDocument(b)},findDocument:function(b){var c=a.getDocument(b);c==null?(b={name:b.match(/[^\/]+$/),path:b},
eXide.app.$doOpenDocument(b)):a.switchTo(c)},locate:function(b,c,e){if(c==null)a.exec("locate",b,e);else{$.log("Locating %s in document %s",e,c);var d=a.getDocument(c);d==null?(c={name:c.match(/[^\/]+$/),path:c},eXide.app.$doOpenDocument(c,function(){a.exec("locate",b,e)})):(a.switchTo(d),a.exec("locate",b,e))}},openDocument:function(){d.reload(["reload"],"open");$("#open-dialog").dialog("option","title","Open Document");$("#open-dialog").dialog("option","buttons",{cancel:function(){$(this).dialog("close");
a.focus()},open:eXide.app.openSelectedDocument});$("#open-dialog").dialog("open")},openSelectedDocument:function(a){var b=d.getSelection();b&&eXide.app.$doOpenDocument(b);(a==void 0||a)&&$("#open-dialog").dialog("close")},$doOpenDocument:function(b,c){b.path=eXide.util.normalizePath(b.path);var e=a.getDocument(b.path);e?a.switchTo(e):$.ajax({url:"modules/load.xql?path="+b.path,dataType:"text",success:function(e,d,f){d=eXide.util.mimeTypes.getMime(f.getResponseHeader("Content-Type"));a.openDocument(e,
d,b);c&&c.call(null,b)},error:function(a){eXide.util.error("Failed to load document "+b.path+": "+a.status+" "+a.statusText)}})},closeDocument:function(){a.getActiveDocument().isSaved()?a.closeDocument():$("#dialog-confirm-close").dialog({resizable:!1,height:140,modal:!0,buttons:{Close:function(){$(this).dialog("close");a.closeDocument()},Cancel:function(){$(this).dialog("close")}}})},saveDocument:function(){eXide.app.requireLogin(function(){a.getActiveDocument().getPath().match("^__new__")?(d.reload(["reload",
"create"],"save"),$("#open-dialog").dialog("option","title","Save Document"),$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){a.saveDocument(d.getSelection(),function(){$("#open-dialog").dialog("close");c.autoSync(a.getActiveDocument().getBasePath())},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}}),$("#open-dialog").dialog("open")):a.saveDocument(null,function(){eXide.util.message(a.getActiveDocument().getName()+" stored.");
c.autoSync(a.getActiveDocument().getBasePath())},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})})},saveDocumentAs:function(){eXide.app.requireLogin(function(){d.reload(["reload","create"],"save");$("#open-dialog").dialog("option","title","Save Document As ...");$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){a.saveDocument(d.getSelection(),function(){$("#open-dialog").dialog("close");c.autoSync(a.getActiveDocument().getBasePath())},
function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}});$("#open-dialog").dialog("open")})},exec:function(){a.exec(arguments)},download:function(){var b=a.getActiveDocument();b.getPath().match("^__new__")||!b.isSaved()?eXide.util.error("There are unsaved changes in the document. Please save it first."):window.location.href="modules/load.xql?download=true&path="+encodeURIComponent(b.getPath())},runQuery:function(){a.updateStatus("Running query ...");var c=a.getText(),d="xmldb:exist://"+
a.getActiveDocument().getBasePath();$("#results-container .results").empty();$.ajax({type:"POST",url:"execute",dataType:"xml",data:{qu:c,base:d},success:function(c){c=c.documentElement;if(c.nodeName=="error")c=$(c).text(),eXide.util.error(c,"Compilation Error"),a.evalError(c);else{a.updateStatus("");a.clearErrors();var d=$("body").layout();d.open("south");d.sizePane("south",300);eXide.app.resize();b=e=1;f=c.getAttribute("hits");g=e+10-1;f<g&&(g=f);eXide.util.message("Found "+f+" in "+c.getAttribute("elapsed")+
"s");eXide.app.retrieveNext()}},error:function(a){eXide.util.error(a.responseText,"Server Error")}})},checkQuery:function(){a.validate()},retrieveNext:function(){$.log("retrieveNext: %d",b);if(b>0&&b<=g){var a="results/"+b;b++;$.ajax({url:a,dataType:"html",success:function(a){$("#results-container .results").append(a);$("#results-container .current").text("Showing results "+e+" to "+(b-1)+" of "+f);$("#results-container .pos:last a").click(function(){eXide.app.findDocument(this.pathname);return!1});
eXide.app.retrieveNext()}})}},browseNext:function(){b>0&&g<f&&(e=b,g=b+10-1,f<g&&(g=f),$("#results-container .results").empty(),eXide.app.retrieveNext());return!1},browsePrevious:function(){b>0&&e>1&&(e-=10,e<1&&(e=1),b=e,g=b+9,f<g&&(g=f),$("#results-container .results").empty(),eXide.app.retrieveNext());return!1},manage:function(){eXide.app.requireLogin(function(){d.reload(["reload","create","upload","open"],"manage");$("#open-dialog").dialog("option","title","DB Manager");$("#open-dialog").dialog("option",
"buttons",{Close:function(){$(this).dialog("close")}});$("#open-dialog").dialog("open")})},deploymentSettings:function(){var b=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());b&&eXide.app.requireLogin(function(){$.log("Editing deployment settings for collection: %s",b[1]);c.open(b[1])})},newDeployment:function(){eXide.app.requireLogin(function(){c.open()})},deploy:function(){eXide.app.requireLogin(function(){var b=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());if(!b)return eXide.util.error("The file open in the editor does not belong to an application package!"),
!1;$.log("Deploying application from collection: %s",b[1]);c.deploy(b[1])});return!1},synchronize:function(){eXide.app.requireLogin(function(){var b=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());b?c.synchronize(b[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},downloadApp:function(){eXide.app.requireLogin(function(){var b=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());$.log("downloading %s",b);b?c.download(b[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},
openApp:function(){var b=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());b?c.runApp(b[1]):eXide.util.error("The file open in the editor does not belong to an application package!")},preferences:function(){var a=$("#preferences-dialog form");$('select[name="theme"]',a).val(h.theme);$('select[name="font-size"]',a).val(h.fontSize);$('input[name="show-invisibles"]',a).attr("checked",h.showInvisibles);$('input[name="print-margin"]',a).attr("checked",h.showPrintMargin);var b=h.softWrap;b==0?b="off":
b===-1&&(b="free");$('input[name="soft-wrap"]',a).val(b);$("#preferences-dialog").dialog("open")},applyPreferences:function(){$.log("preferences: %o",h);a.setTheme(h.theme);a.editor.setShowInvisibles(h.showInvisibles);a.editor.renderer.setShowPrintMargin(h.showPrintMargin);a.forEachDocument(function(a){h.softWrap>0?a.getSession().setWrapLimitRange(h.softWrap,h.softWrap):h.softWrap<0&&a.getSession().setWrapLimitRange(null,null);a.getSession().setUseWrapMode(h.softWrap!=0)});$("#editor").css("font-size",
h.fontSize);a.resize()},getPreferences:function(){return h},restoreState:function(){if(!eXide.util.supportsHtml5Storage)return!1;for(conf in h){var b="eXide.preferences."+conf;localStorage[b]&&(h[conf]=localStorage[b]=="true"?!0:localStorage[b]=="false"?!1:localStorage[b])}eXide.app.applyPreferences();var b={},e=localStorage["eXide.documents"];e||(e=0);for(var d=0;d<e;d++){var f={path:localStorage["eXide."+d+".path"],name:localStorage["eXide."+d+".name"],writable:localStorage["eXide."+d+".writable"]==
"true",line:parseInt(localStorage["eXide."+d+".last-line"])};$.log("Restoring doc %s, going to line = %i",f.path,f.line);var g=localStorage["eXide."+d+".data"];g?a.newDocumentWithText(g,localStorage["eXide."+d+".mime"],f):eXide.app.$doOpenDocument(f);b[f.path]=f}c.restoreState();return b},saveState:function(){if(eXide.util.supportsHtml5Storage){localStorage.clear();for(conf in h)localStorage["eXide.preferences."+conf]=h[conf];a.saveState();c.saveState()}},ping:function(){$.ajax({url:"index.html",
type:"HEAD",success:function(){setTimeout(function(){eXide.app.ping()},3E4)},error:function(a,b){$.log("ping failed: %s",b);eXide.app.login=null;$("#user").empty();$("#login").text("Login")}})},$checkLogin:function(){if(eXide.app.login)return!0;eXide.util.error("Warning: you are not logged in.");return!1},requireLogin:function(a){eXide.app.login?a():($("#login-dialog").dialog("option","close",function(){eXide.app.login?a():eXide.util.error("Warning: you are not logged in!")}),$("#login-dialog").dialog("open"))},
initGUI:function(){$("body").layout({enableCursorHotkey:!1,north__size:70,north__resizable:!1,north__closable:!0,north__showOverflowOnHover:!0,south__minSize:200,south__initClosed:!0,west__size:200,west__initClosed:!0,west__contentSelector:".content",center__minSize:300,center__onresize:eXide.app.resize,center__contentSelector:".content"});$(".menu ul li").hover(function(){$("ul",this).css({visibility:"visible",display:"none"}).show(400)},function(){$("ul",this).css({visibility:"hidden"})});$("#open-dialog").dialog({title:"Open File",
modal:!1,autoOpen:!1,height:480,width:700,open:function(){d.init()},resize:function(){d.resize()}});$("#preferences-dialog").dialog({title:"Preferences",modal:!0,autoOpen:!1,height:400,width:600,buttons:{Cancel:function(){$(this).dialog("close");a.focus()},Save:function(){var b=$("form",this);h.theme=$('select[name="theme"]',b).val();h.fontSize=$('select[name="font-size"]',b).val();h.showInvisibles=$('input[name="show-invisibles"]',b).is(":checked");h.showPrintMargin=$('input[name="print-margin"]',
b).is(":checked");b=$('select[name="soft-wrap"]',b).val();b==="free"?b=-1:b==="off"&&(b=0);h.softWrap=parseInt(b);eXide.app.applyPreferences();$(this).dialog("close");a.focus()}}});$("#login-dialog").dialog({title:"Login",modal:!0,autoOpen:!1,buttons:{Login:function(){$.ajax({url:"login",data:$("#login-form").serialize(),success:function(){eXide.app.login=$('#login-form input[name="user"]').val();$.log("Logged in as %s",eXide.app.login);$("#login-dialog").dialog("close");$("#user").text("Logged in as "+
eXide.app.login+". ");$("#login").text("Logout");setTimeout(function(){eXide.app.ping()},3E4);a.focus()},error:function(){$("#login-error").text("Login failed. Bad username or password.");$("#login-dialog input:first").focus()}})},Cancel:function(){$(this).dialog("close");a.focus()}},open:function(){$(this).find("input").val("");$(this).find("input:first").focus();$("#login-error").empty();var a=$(this);a.find("input").keyup(function(b){b.keyCode==13&&a.parent().find(".ui-dialog-buttonpane button:first").trigger("click")})}});
$("#keyboard-help").dialog({title:"Keyboard Shortcuts",modal:!1,autoOpen:!1,height:400,buttons:{Close:function(){$(this).dialog("close")}},open:function(){eXide.edit.commands.help($("#keyboard-help"),a)}});$("#about-dialog").dialog({title:"About",modal:!1,autoOpen:!1,height:300,width:450,buttons:{Close:function(){$(this).dialog("close")}}});var b=$("#open").button({icons:{primary:"ui-icon-folder-open"}});b.click(eXide.app.openDocument);$("#menu-file-open").click(eXide.app.openDocument);b=$("#close").button({icons:{primary:"ui-icon-close"}});
b.click(eXide.app.closeDocument);$("#menu-file-close").click(eXide.app.closeDocument);b=$("#new").button({icons:{primary:"ui-icon-document"}});b.click(eXide.app.newDocument);$("#menu-file-new").click(eXide.app.newDocument);b=$("#run").button({icons:{primary:"ui-icon-play"}});b.click(eXide.app.runQuery);b=$("#validate").button({icons:{primary:"ui-icon-check"}});b.click(eXide.app.checkQuery);b=$("#save").button({icons:{primary:"ui-icon-disk"}});b.click(eXide.app.saveDocument);$("#menu-file-save").click(eXide.app.saveDocument);
$("#menu-file-save-as").click(eXide.app.saveDocumentAs);b=$("#download").button({icons:{primary:"ui-icon-transferthick-e-w"}});b.click(eXide.app.download);$("#menu-file-download").click(eXide.app.download);$("#menu-file-manager").click(eXide.app.manage);$("#menu-deploy-new").click(eXide.app.newDeployment);$("#menu-deploy-edit").click(eXide.app.deploymentSettings);$("#menu-deploy-deploy").click(eXide.app.deploy);$("#menu-deploy-sync").click(eXide.app.synchronize);$("#menu-deploy-download").click(eXide.app.downloadApp);
$("#menu-edit-undo").click(function(b){b.preventDefault();a.editor.undo()});$("#menu-edit-redo").click(function(b){b.preventDefault();a.editor.redo()});$("#menu-edit-toggle-comment").click(function(b){b.preventDefault();a.editor.toggleCommentLines()});$("#menu-edit-preferences").click(eXide.app.preferences);$("#menu-navigate-definition").click(function(a){a.preventDefault();eXide.app.exec("gotoDefinition")});$("#menu-navigate-modules").click(function(b){b.preventDefault();b=a.getActiveDocument();
eXide.find.Modules.select(b.syntax)});$("#menu-deploy-run").click(eXide.app.openApp);$("#menu-help-keyboard").click(function(a){a.preventDefault();$("#keyboard-help").dialog("open")});$("#menu-help-about").click(function(a){a.preventDefault();$("#about-dialog").dialog("open")});$("#syntax").change(function(){a.setMode($(this).val())});a.addEventListener("activate",null,function(a){$("#syntax").val(a.getSyntax())});$("#login").click(function(a){a.preventDefault();eXide.app.login?($.get("logout"),$("#user").empty(),
$("#login").text("Login"),eXide.app.login=null):$("#login-dialog").dialog("open")});$("#results-container .next").click(eXide.app.browseNext);$("#results-container .previous").click(eXide.app.browsePrevious)}}}();eXide.namespace("eXide.edit.Projects");
eXide.edit.Projects=function(){Constr=function(){this.projects={}};Constr.prototype.getProject=function(a,c){var d=this;$.getJSON("modules/deployment.xql",{info:a},function(a){if(a){var e=d.projects[a.abbrev];e?eXide.util.oop.extend(e,a):(e=a,d.projects[a.abbrev]=e);c(e)}else eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};Constr.prototype.getProjectFor=function(a){for(k in this.projects){var c=this.projects[k];$.log("collection: %s -> root: %s",
a.substring(0,c.root.length),c.root);if(a.substring(0,c.root.length)===c.root)return c}return null};Constr.prototype.saveState=function(){var a=0;for(k in this.projects){var c=this.projects[k];for(n in c)localStorage["eXide.projects."+a+"."+n]=c[n];a++}localStorage["eXide.projects"]=a};Constr.prototype.restoreState=function(){var a=localStorage["eXide.projects"];a||(a=0);this.projects={};for(var c=0;c<a;c++){var d=localStorage["eXide.projects."+c+".abbrev"];this.projects[d]={abbrev:d,root:localStorage["eXide.projects."+
c+".root"],dir:localStorage["eXide.projects."+c+".dir"],autoSync:localStorage["eXide.projects."+c+".autoSync"]}}};return Constr}();eXide.namespace("eXide.edit.PackageEditor");
eXide.edit.PackageEditor=function(){Constr=function(){var a=this;this.projects=new eXide.edit.Projects;this.currentProject=null;this.container=$("#dialog-deploy");this.container.dialog({title:"Deployment Editor",modal:!1,autoOpen:!1,width:520,height:600});this.syncDialog=$("#synchronize-dialog");this.syncDialog.dialog({title:"Synchronize to Directory",modal:!1,autoOpen:!1,width:500,height:400,buttons:{Synchronize:function(){var c=a.syncDialog.find('input[name="dir"]').val();!c||c.length==0?$("#synchronize-report").text("No output directory specified!"):
(a.currentProject.dir=c,c=a.syncDialog.find("form").serialize(),$("#synchronize-report").text("Synchronization in progress ..."),$("#synchronize-report").load("modules/synchronize.xql",c))},Close:function(){$(this).dialog("close")}}});a.syncDialog.find('input[name="auto"]').click(function(){if(a.currentProject)a.currentProject.autoSync=$(this).is(":checked")})};Constr.prototype={open:function(a){var c=this,d=null;a&&(d={collection:a});$.ajax({url:"modules/deployment.xql",type:"POST",data:d,success:function(a){c.container.html(a);
c.container.find("input[name='collection']").change(function(){var a=c.container.find("input[name='target']");a.val()===""&&a.val($(this).val())});c.container.form({done:function(){var a=c.container.find("form").serialize();$.ajax({url:"modules/deployment.xql",type:"POST",data:a,success:function(){c.container.dialog("close")},error:function(a){eXide.util.error(a.responseText)}})},cancel:function(){c.container.dialog("close")}});c.container.find(".author-repeat").repeat("#author-add-trigger",{deleteTrigger:"#author-remove-trigger"});
c.container.dialog("open")},error:function(a){eXide.util.error(a.responseText)}})},deploy:function(a){$.ajax({url:"modules/deployment.xql",type:"POST",dataType:"json",data:{collection:a,deploy:"true"},success:function(a){a=location.protocol+"//"+location.hostname+":"+location.port+"/exist/apps/"+a+"/";eXide.util.Dialog.message("Application Deployed",'<p>The application has been deployed. On a standard installation the following link should open it:</p><center><a href="'+a+'" target="_new">'+a+"</a></center>")},
error:function(a){a.status==404?eXide.util.error("Deployment failed. The document currently opened in the editor should belong to an application package."):eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>")}})},download:function(a){window.location.href="modules/deployment.xql?download=true&collection="+encodeURIComponent(a)},synchronize:function(a){var c=this;c.projects.getProject(a,function(a){a.isAdmin?(c.currentProject=a,
c.syncDialog.find(".project-name").text(a.abbrev),c.syncDialog.find('input[name="start"]').val(a.deployed),a.dir&&c.syncDialog.find('input[name="dir"]').val(a.dir),c.syncDialog.find('input[name="collection"]').val(a.root),c.syncDialog.find('input[name="auto"]').val(a.autoSync?"on":"off"),c.syncDialog.dialog("open")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature.")})},autoSync:function(a){(a=this.projects.getProjectFor(a))&&a.autoSync&&$.ajax({url:"modules/synchronize.xql",
type:"GET",data:{collection:a.root,start:a.deployed,dir:a.dir},success:function(){eXide.util.message("Synchronized directory")}})},runApp:function(a){this.projects.getProject(a,function(a){var d="/exist/apps/"+a.root.replace(/^\/db\//,"")+"/";eXide.util.Dialog.message("Run Application "+a.abbrev,'<p>Click on the following link to open your application:</p><center><a href="'+d+'" target="_new">'+d+"</a></center>")})},saveState:function(){this.projects.saveState()},restoreState:function(){this.projects.restoreState()}};
return Constr}();eXide.namespace("eXide.edit.Template");
eXide.edit.Template=function(){var a=/\n/;Constr=function(c,d,f,e){var b=f.split(a).length;this.code=f;this.editor=c.editor;this.range=d;this.type=e;this.startLine=d.start.row;this.endLine=this.startLine+b-1;$.log("startLine = %i, endLine = %i",this.startLine,this.endLine);this.currentLine=this.startLine;this.lineOffset=this.startColumn=d.start.column;this.regex=/\$[\w\-:_]+/g;if(this.startColumn>0)this.regex.lastIndex=this.startColumn};Constr.prototype={insert:function(){this.editor.getSession().remove(this.range);this.editor.insert(this.code);
var a=this.editor.getSelection().getSelectionLead();this.code.substring(0,1)!="$"&&a.column>0&&this.editor.navigateLeft();this.type!="variable"&&this.nextParam();this.editor.focus()},nextParam:function(){var a=this.editor.getSession(),d=this.editor.getSelection(),f=d.getSelectionLead();$.log("lead.row = %i startLine = %i",f.row,this.startLine);if(f.row<this.startLine||f.row>this.endLine)return!1;for(var e=f=!1;this.currentLine<=this.endLine;){var b=a.getDisplayLine(this.currentLine);$.log("Checking line %s",
b);if(b=this.regex.exec(b)){$.log("Matched %s",b[0]);d.setSelectionAnchor(this.currentLine,b.index);d.selectTo(this.currentLine,b.index+b[0].length);this.lineOffset=b.index;e=!0;break}else this.lineOffset=0,this.currentLine++;if(this.currentLine>this.endLine&&!f){$.log("loop %i",this.startColumn);this.currentLine=this.startLine;if(this.startColumn>0)this.lineOffset=this.startColumn,this.regex.lastIndex=this.lineOffset;f=!0}}return e}};return Constr}();eXide.namespace("eXide.browse.CollectionBrowser");
eXide.browse.CollectionBrowser=function(){Constr=function(a){var c=this;this.events={activate:[]};this.selected=null;var d=document.createElement("div");d.className="eXide-browse-collections eXide-browse-content";a.append(d);this.container=$(d);this.container.dynatree({persist:!1,rootVisible:!1,initAjax:{url:"modules/collections.xql"},clickFolderMode:1,autoFocus:!1,keyboard:!1,onActivate:function(a){var e=a.data.key;$.log("activate %s: is writable: %s",e,a.data.writable);c.selected=e;c.$triggerEvent("activate",
[e,a.data.writable])},onPostInit:function(){var a=null;c.selected&&(a=this.getNodeByKey(c.selected));a==null&&(a=this.getNodeByKey("/db"));a.activate();a.expand(!0)}})};Constr.prototype={getSelection:function(){return this.selected},reload:function(){$.log("Reloading tree...");this.container.dynatree("getTree").reload()},createCollection:function(){var a=this;eXide.app.$checkLogin()&&eXide.util.Dialog.input("Create Collection",'<label for="collection">Name: </label><input type="text" name="collection" id="eXide-browse-collection-name"/>',
function(){$.getJSON("modules/collections.xql",{create:$("#eXide-browse-collection-name").val(),collection:a.selected},function(c){c.status=="fail"?eXide.util.Dialog.warning("Create Collection Error",c.message):a.reload()})})},deleteCollection:function(){var a=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete collection "+a.selected+"?",function(){$.getJSON("modules/collections.xql",{remove:a.selected},function(c){$.log(c.status);c.status=="fail"?eXide.util.Dialog.warning("Delete Collection Error",
c.message):a.reload()})})},addEventListener:function(a,c,d){(a=this.events[a])&&a.push({obj:c,callback:d})},$triggerEvent:function(a,c){var d=this.events[a];if(d)for(var f=0;f<d.length;f++)d[f].callback.apply(d[f].obj,c)}};return Constr}();eXide.namespace("eXide.browse.ResourceBrowser");
eXide.browse.ResourceBrowser=function(){var a=[{id:"name",name:"Name",field:"name",width:120,formatter:function(a,c,b,d,h){return h.isCollection?'<span class="collection"><img src="resources/images/folder_add.png"/> '+b+"</span>":b}},{id:"permissions",name:"Permissions",field:"permissions",width:80},{id:"owner",name:"Owner",field:"owner",width:70},{id:"group",name:"Group",field:"group",width:70},{id:"lastMod",name:"Last Modified",field:"last-modified",width:115}],c={editable:!1,multiSelect:!1},d=
{editable:!1,multiSelect:!0};Constr=function(c){var e=this;this.container=$(c);this.events={activate:[],activateCollection:[],activateParent:[]};this.mode="save";this.collection=null;this.data=[];this.grid=new Slick.Grid(this.container,this.data,a,d);var b=new Slick.RowSelectionModel({selectActiveRow:!0});this.grid.setSelectionModel(b);b.onSelectedRangesChanged.subscribe(function(){for(var a=b.getSelectedRows(),c=!0,d=0;d<a.length;d++)if(!e.data[a[d]].writable){c=!1;break}e.$triggerEvent("activate",
[a.length==1&&!e.data[a[0]].isCollection?e.data[a[0]]:null,c])});this.grid.onDblClick.subscribe(function(a){a=e.grid.getCellFromEvent(a);e.data[a.row].isCollection&&e.$triggerEvent("activateCollection",[e.collection+"/"+e.data[a.row].name])});this.grid.onKeyDown.subscribe(function(a){if(!a.shiftKey&&!a.altKey&&!a.ctrlKey)if(a.which==13)a.stopPropagation(),a.preventDefault(),a=b.getSelectedRows(),a.length==1&&(e.data[a[0]].isCollection?e.$triggerEvent("activateCollection",[e.collection+"/"+e.data[a[0]].name]):
eXide.app.openSelectedDocument());else if(a.which==8){var c=e.collection.lastIndexOf("/");c>0&&(a.stopPropagation(),a.preventDefault(),e.collection!="/db"&&(a=e.collection.substring(0,c),e.$triggerEvent("activateCollection",[a])))}});this.grid.onViewportChanged.subscribe(function(){var a=e.grid.getViewport();e.load(a.top,a.bottom)})};Constr.prototype={setMode:function(a){this.mode=a;a=="manage"?this.grid.setOptions(d):this.grid.setOptions(c)},resize:function(){this.grid.resizeCanvas();this.container.find(".grid-canvas").focus()},
update:function(a){$.log("Opening collection %s",a);this.collection=a;this.grid.invalidate();this.data.length=0;this.grid.getSelectionModel().setSelectedRanges([]);this.grid.onViewportChanged.notify()},load:function(a,c){var b=this;$.getJSON("modules/collections.xql",{root:this.collection,view:"r",start:a,end:c},function(d){for(var h=a;h<=c;h++)b.grid.invalidateRow(h);if(d&&d.items){b.data.length=d.total;for(h=0;h<d.items.length;h++)b.data[a+h]=d.items[h]}else b.data.length=0;b.grid.updateRowCount();
b.grid.render();a==0&&b.data.length>0&&(b.grid.setActiveCell(0,0),b.grid.setSelectedRows([0]),b.container.find(".grid-canvas").focus())})},hasSelection:function(){var a=this.grid.getSelectionModel().getSelectedRows();return a&&a.length>0},deleteResource:function(){var a=this.grid.getSelectionModel().getSelectedRows();if(a.length!=0){for(var c=[],b=0;b<a.length;b++)c.push(this.data[a[b]].name);var d=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete the selected resources?",
function(){$.log("Deleting resources %o",c);$.getJSON("modules/collections.xql",{remove:c,root:d.collection},function(a){$.log(a.status);a.status=="fail"?eXide.util.Dialog.warning("Delete Resource Error",a.message):d.reload()})})}},reload:function(){this.update(this.collection)},addEventListener:function(a,c,b){(a=this.events[a])&&a.push({obj:c,callback:b})},$triggerEvent:function(a,c){var b=this.events[a];if(b)for(var d=0;d<b.length;d++)b[d].callback.apply(b[d].obj,c)}};return Constr}();eXide.namespace("eXide.browse.Upload");
eXide.browse.Upload=function(){Constr=function(a){this.container=a;this.events={done:[]};$("#file_upload").fileUploadUI({sequentialUploads:!0,uploadTable:$("#files"),buildUploadRow:function(a,c){return $("<tr><td>"+a[c].name+'</td><td class="file_upload_progress"><div></div></td><td class="file_upload_cancel"><button class="ui-state-default ui-corner-all" title="Cancel"><span class="ui-icon ui-icon-cancel">Cancel</span></button></td></tr>')},buildDownloadRow:function(a){return a.error?$("<tr><td>"+
a.name+"</td><td>"+a.error+"</td></tr>"):null}});var c=this;$("#eXide-browse-upload-done").button().click(function(){$("#files").empty();c.$triggerEvent("done",[])})};Constr.prototype={update:function(a){$('input[name="collection"]',this.container).val(a)},addEventListener:function(a,c,d){(a=this.events[a])&&a.push({obj:c,callback:d})},$triggerEvent:function(a,c){var d=this.events[a];if(d)for(var f=0;f<d.length;f++)d[f].callback.apply(d[f].obj,c)}};return Constr}();eXide.namespace("eXide.browse.Browser");
eXide.browse.Browser=function(){Constr=function(a){var c=this,d=$(".eXide-browse-toolbar",a),f=document.createElement("button");f.title="Reload";f.id="eXide-browse-toolbar-reload";f.tabindex=1;var e=document.createElement("img");e.src="resources/images/arrow_refresh.png";f.appendChild(e);$(f).click(function(){c.collections.reload()});d.append(f);this.btnDeleteCollection=document.createElement("button");this.btnDeleteCollection.title="Delete Collection";this.btnDeleteCollection.id="eXide-browse-toolbar-delete-collection";
this.btnDeleteCollection.tabindex=2;e=document.createElement("img");e.src="resources/images/folder_delete.png";this.btnDeleteCollection.appendChild(e);$(this.btnDeleteCollection).click(function(a){a.preventDefault();c.collections.deleteCollection()});d.append(this.btnDeleteCollection);this.btnCreateCollection=document.createElement("button");this.btnCreateCollection.title="Create Collection";this.btnCreateCollection.id="eXide-browse-toolbar-create";this.btnCreateCollection.tabindex=3;e=document.createElement("img");
e.src="resources/images/folder_add.png";this.btnCreateCollection.appendChild(e);$(this.btnCreateCollection).click(function(a){a.preventDefault();c.collections.createCollection()});d.append(this.btnCreateCollection);this.btnUpload=document.createElement("button");this.btnUpload.title="Upload Files";this.btnUpload.id="eXide-browse-toolbar-upload";this.btnUpload.tabindex=4;e=document.createElement("img");e.src="resources/images/database_add.png";this.btnUpload.appendChild(e);$(this.btnUpload).click(function(b){b.preventDefault();
$(".eXide-browse-resources",a).hide();$(".eXide-browse-upload",a).show()});d.append(this.btnUpload);this.btnDeleteResource=document.createElement("button");this.btnDeleteResource.title="Delete Resource";this.btnDeleteResource.id="eXide-browse-toolbar-delete-resource";e=document.createElement("img");e.src="resources/images/page_delete.png";this.btnDeleteResource.appendChild(e);$(this.btnDeleteResource).click(function(a){a.preventDefault();c.resources.deleteResource()});d.append(this.btnDeleteResource);
f=document.createElement("button");f.title="Open Selected";f.id="eXide-browse-toolbar-open";f.tabindex=5;e=document.createElement("img");e.src="resources/images/page_edit.png";f.appendChild(e);$(f).click(function(a){a.preventDefault();eXide.app.openSelectedDocument(!1)});d.append(f);this.selection=$(".eXide-browse-form input",a);this.container=a;this.resources=new eXide.browse.ResourceBrowser($(".eXide-browse-resources",a));this.collections=new eXide.browse.CollectionBrowser($(".eXide-browse-collections",
a));this.upload=new eXide.browse.Upload($(".eXide-browse-upload",a).hide());this.layout=null;this.collections.addEventListener("activate",this,this.onActivateCollection);this.collections.addEventListener("activate",this.resources,this.resources.update);this.collections.addEventListener("activate",this.upload,this.upload.update);this.resources.addEventListener("activate",this,this.onActivateResource);this.resources.addEventListener("activateCollection",this,this.onChangeCollection);this.upload.addEventListener("done",
this,function(){$(".eXide-browse-resources",a).show();$(".eXide-browse-upload",a).hide();this.reload()})};Constr.prototype={init:function(){var a=$(this.container).innerHeight()-$(".eXide-browse-form",this.container).height()-25;$(".eXide-browse-panel",this.container).height(a);if(this.layout==null)this.layout=$(".eXide-browse-panel",this.container).layout({enableCursorHotkey:!1,north__resizable:!1,north__closable:!1,north__spacing_open:0,south__resizable:!1,west__size:200,west__initClosed:!1,west__contentSelector:".eXide-browse-content",
center__minSize:300,center__contentSelector:".eXide-browse-content",onresize:function(){this.resources.resize()}}),this.resources.resize()},reload:function(a,c){if(a){$(".eXide-browse-toolbar button",this.container).hide();for(var d=0;d<a.length;d++)$("#eXide-browse-toolbar-"+a[d]).show()}this.resources.setMode(c);c==="open"||c==="save"?$(".eXide-browse-form",this.container).show():$(".eXide-browse-form",this.container).hide();this.layout!=null&&(this.resize(),this.collections.reload(),this.resources.update(this.collections.getSelection()),
$(this.selection).val(""))},resize:function(){var a=$(this.container).innerHeight()-$(".eXide-browse-form",this.container).height()-25;$(".eXide-browse-panel",this.container).height(a);this.layout.resizeAll()},getSelection:function(){var a=$(this.selection).val();return a==null||a==""?null:{name:a,path:this.collections.getSelection()+"/"+a,writable:!0}},onActivateResource:function(a,c){a?$(this.selection).val(a.name):$(this.selection).val("");c?$(this.btnDeleteCollection).css("display",""):$(this.btnDeleteCollection).css("display",
"none")},onActivateCollection:function(a,c){c?($(this.btnCreateCollection).css("display",""),$(this.btnUpload).css("display",""),$(this.btnDeleteCollection).css("display",""),$(this.btnDeleteResource).css("display","")):($(this.btnCreateCollection).css("display","none"),$(this.btnUpload).css("display","none"),$(this.btnDeleteCollection).css("display","none"),$(this.btnDeleteResource).css("display","none"));this.resources.update(a,c);this.upload.update(a,c)},onChangeCollection:function(a){this.collections.selected=
a;this.collections.reload();this.resources.update(this.collections.getSelection())}};return Constr}();eXide.namespace("eXide.find.IncrementalSearch");
eXide.find.IncrementalSearch=function(){Constr=function(a,c){var d=this;d.input=$(a);d.input.hide();d.input.keyup(function(a){switch(a.which){case 27:case 13:d.input.hide();d.editor.focus();break;case 40:a.preventDefault();d.editor.findNext();break;case 38:a.preventDefault();d.editor.findPrevious();break;default:d.onChange()}});d.editor=c};Constr.prototype.start=function(){this.currentLine=this.editor.getSession().getSelection().getSelectionLead().row;this.input.val("");this.input.show().focus()};
Constr.prototype.onChange=function(){this.editor.gotoLine(this.currentLine);this.editor.find(this.input.val())};return Constr}();eXide.namespace("eXide.find.Modules");
eXide.find.Modules=function(){var a={open:[],"import":[]},c=[{id:"prefix",name:"Prefix",field:"prefix",minWidth:100,sortable:!0,resizable:!0},{id:"uri",name:"URI",field:"uri",minWidth:240,sortable:!0,resizable:!0},{id:"at",name:"Location",field:"at",minWidth:200,sortable:!0,resizable:!0}],d={editable:!1,multiSelect:!1},f=[],e;$(document).ready(function(){e=new Slick.Grid("#module-list",f,c,d);var a=new Slick.RowSelectionModel({selectActiveRow:!0});e.setSelectionModel(a);e.onDblClick.subscribe(function(a){a=
e.getCellFromEvent(a);eXide.find.Modules.$triggerEvent("open",[f[a.row]])});$("#select-module-dialog").dialog({modal:!1,autoOpen:!1,height:400,width:600,open:eXide.find.Modules.$init})});return{select:function(a){var c={Open:function(){eXide.find.Modules.trigger("open");$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}};a=="xquery"&&(c.Import=function(){eXide.find.Modules.trigger("import");$(this).dialog("close")});$("#select-module-dialog").dialog("option","buttons",c);$("#select-module-dialog").dialog("open")},
trigger:function(a){var c=e.getSelectionModel().getSelectedRows();c.length==1&&eXide.find.Modules.$triggerEvent(a,[f[c[0]]])},$init:function(){e.resizeCanvas();e.invalidate();f.length=0;$.getJSON("modules/find.xql",function(a){f.length=a.length;for(var c=0;c<a.length;c++)f[c]=a[c];e.updateRowCount();e.render();e.setActiveCell(0,0);e.setSelectedRows([0]);$("#module-list").find(".grid-canvas").focus()})},addEventListener:function(b,c,d){(b=a[b])&&b.push({obj:c,callback:d})},$triggerEvent:function(b,
c){var d=a[b];if(d)for(var e=0;e<d.length;e++)d[e].callback.apply(d[e].obj,c)}}}();
var eXide=eXide||{};eXide.namespace=function(a){var a=a.split("."),b=eXide,d;a[0]=="eXide"&&(a=a.slice(1));for(d=0;d<a.length;d++)typeof b[a[d]]=="undefined"&&(b[a[d]]={}),b=b[a[d]];return b};eXide.namespace("eXide.util");
eXide.util=function(){var a={dir1:"up",dir2:"left",firstpos1:15,firstpos2:15};return{popup:function(a,d,f,g){function c(c){e&&(e.empty(),c.find(".tooltip").each(function(){e.html($(this).html())}))}var h=$(a),e=d?$(d):null,i=null;f.sort(function(c,e){return c.label==e.label?0:c.label>e.label?1:-1});h.empty().css("display","block").focus();a=document.createElement("a");a.href="#";a.className="popup-close";a.appendChild(document.createTextNode("Close"));h.append(a);$(a).click(function(c){c.preventDefault();
h.css("display","none");e&&e.css("display","none")});a=document.createElement("ul");for(d=0;d<f.length;d++){var l=document.createElement("li");if(d==0)l.className="first";l.appendChild(document.createTextNode(f[d].label));if(f[d].tooltip){var o=document.createElement("span");o.className="tooltip";o.appendChild(document.createTextNode(f[d].tooltip));l.appendChild(o)}a.appendChild(l);$(l).click(function(){i.removeClass("selection");$(this).addClass("selection");i=$(this);c(i)});$(l).dblclick(function(){var c=
h.find("li").index(i);h.css("display","none");e&&e.css("display","none");g.call(null,f[c])})}h.append(a);i=h.find("ul li:first").addClass("selection");c(i);var p=$(a).css("position","absolute").scrollTop(0);e&&e.css({display:"block",top:p.offset().top+"px"});var j=p.innerHeight();$(h).keydown(function(a){a.preventDefault();if(a.which==40)a=i.next(),a.length>0&&(i.removeClass("selection"),a.addClass("selection"),i=a,a.position().top+a.height()>=j&&a.get(0).scrollIntoView(),c(a));else if(a.which==38)a=
i.prev(),a.length>0&&(i.removeClass("selection"),a.addClass("selection"),i=a,a.hasClass("first")?p.scrollTop(0):a.position().top<0&&a.get(0).scrollIntoView(),c(a));else if(a.which==13){var b=h.find("li").index(i);h.css("display","none");e&&e.css("display","none");$(h).unbind(a);g.call(null,f[b])}else return h.css("display","none"),e&&e.css("display","none"),$(h).unbind(a),g.call(null,null),!0;return!1})},supportsHtml5Storage:function(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return!1}},
normalizePath:function(a){for(var a=a.replace(/^xmldb:exist:\/\//,""),d=[],a=a.split("/"),f=a.length-1;f>-1;f--)a[f]==".."?f--:d.push(a[f]);return d.reverse().join("/")},parseSignature:function(a){var d=a.indexOf("(");if(d>-1){var f=a.substring(0,d+1),a=a.substring(d);if(a=a.match(/\$[\w:-_]+/g))for(d=0;d<a.length;d++)d>0&&(f+=", "),f+=a[d];f+=")";return f}return a},message:function(b){$.pnotify({pnotify_text:b,pnotify_shadow:!0,pnotify_hide:!0,pnotify_closer:!0,pnotify_opacity:0.75,pnotify_addclass:"stack-bottomright",
pnotify_stack:a})},error:function(b,d){var f={pnotify_text:b,pnotify_type:"error",pnotify_shadow:!0,pnotify_hide:!0,pnotify_addclass:"stack-bottomright",pnotify_stack:a};if(d)f.pnotify_title=d;$.pnotify(f)}}}();eXide.namespace("eXide.util.Dialog");
eXide.util.Dialog=function(){var a;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-message">\t<img id="eXide-dialog-message-icon" src="images/error.png"/>\t<div id="eXide-dialog-message-body"></div></div>');a=$("#eXide-dialog-message");a.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close")}}})});return{message:function(b,d){a.dialog("option","title",b);$("#eXide-dialog-message-body").html(d);$("#eXide-dialog-message-icon").attr("src","images/information.png");
a.dialog("open")},warning:function(b,d){a.dialog("option","title",b);$("#eXide-dialog-message-body").html(d);$("#eXide-dialog-message-icon").attr("src","images/error.png");a.dialog("open")}}}();eXide.namespace("eXide.util.mimeTypes");
eXide.util.mimeTypes=function(){var a={xml:["text/xml","application/xml","application/xhtml+xml"],xquery:["application/xquery"],css:["text/css"],html:["text/html"],javascript:["application/x-javascript"]};return{getMime:function(a){var d=a.indexOf(";");d>-1&&(a=a.substring(0,d));return a},getLangFromMime:function(b){for(var d in a)for(var f=a[d],g=0;g<f.length;g++)if(b==f[g])return d;return"xquery"},getMimeFromLang:function(b){return(b=a[b])?b[0]:"application/xquery"}}}();
(function(a){a.log=function(){window.console&&window.console.log&&console.log.apply(window.console,arguments)};a.fn.log=function(){a.log(this);return this}})(jQuery);eXide.namespace("eXide.edit.commands");
eXide.edit.commands=function(){var a=require("pilot/canon");return{init:function(b){a.addCommand({name:"saveDocument",exec:function(){eXide.app.saveDocument()}});a.addCommand({name:"runQuery",exec:function(){eXide.app.runQuery()}});a.addCommand({name:"openDocument",exec:function(){eXide.app.openDocument()}});a.addCommand({name:"newDocument",exec:function(){eXide.app.newDocument()}});a.addCommand({name:"closeDocument",exec:function(){eXide.app.closeDocument()}});a.addCommand({name:"autocomplete",exec:function(){b.autocomplete()}});
a.addCommand({name:"nextTab",exec:function(){b.nextTab()}});a.addCommand({name:"previousTab",exec:function(){b.previousTab()}});a.addCommand({name:"functionDoc",exec:function(){b.showFunctionDoc()}});a.addCommand({name:"gotoDefinition",exec:function(){b.gotoDefinition()}});a.addCommand({name:"indentOrParam",exec:function(a){var f=b.getActiveDocument();(!f.template||!f.template.nextParam())&&a.editor.indent()}});a.addCommand({name:"escape",exec:function(a){b.getActiveDocument().template=null;a.editor.clearSelection()}})}}}();eXide.namespace("eXide.edit.Outline");
eXide.edit.Outline=function(){Constr=function(a){a.addEventListener("activate",this,this.updateOutline);a.addEventListener("validate",this,this.updateOutline);a.addEventListener("close",this,this.clearOutline);this.funcRe=/declare\s+function\s+(([^\(]+)\([^\)]*\))/;this.funcDefRe=/declare\s+function\s+[^\(]+\([^\)]*\)/g;this.varDefRe=/declare\s+variable\s+\$[^\s;]+/gm;this.varRe=/declare\s+variable\s+(\$[^\s;]+)/;this.parseImportRe=/import\s+module\s+namespace\s+[^=]+\s*=\s*["'][^"']+["']\s*at\s+["'][^"']+["']\s*;/g;this.moduleRe=
/import\s+module\s+namespace\s+([^=\s]+)\s*=\s*["']([^"']+)["']\s*at\s+["']([^"']+)["']\s*;/;this.currentDoc=null;this.templates=[];this.$loadTemplates()};Constr.prototype={getTemplates:function(a){for(var a=RegExp("^"+a),b=[],d=0;d<this.templates.length;d++)this.templates[d].name.match(a)&&b.push(this.templates[d]);return b},gotoDefinition:function(a,b){$.each(a.functions,function(a,f){if(b==f.name)switch(f.type){case "function":eXide.app.findFunction(f.source==""?null:f.source,b);break;case "variable":eXide.app.findVarDecl(f.source==
""?null:f.source,b)}})},updateOutline:function(a){this.currentDoc=a;a.functions=[];$("#outline").empty();if(a.getMime()=="application/xquery"){var b=a.getText();this.$parseLocalFunctions(b,a);this.$outlineUpdate(a);(b=this.$parseImports(b))&&this.$resolveImports(a,b)}},clearOutline:function(){$("#outline").empty()},$parseLocalFunctions:function(a,b){b.functions=[];var d=a.match(this.funcDefRe);if(d)for(var f=0;f<d.length;f++){var g=this.funcRe.exec(d[f]);b.functions.push({type:"function",name:g[2],
signature:g[1]})}if(d=a.match(this.varDefRe))for(f=0;f<d.length;f++)g=this.varRe.exec(d[f]),b.functions.push({type:"variable",name:g[1]})},$parseImports:function(a){return a.match(this.parseImportRe)},$resolveImports:function(a,b){for(var d=this,f=[],g=[],c=0;c<b.length;c++){var h=this.moduleRe.exec(b[c]);h!=null&&h.length==4&&(g.push("prefix="+encodeURIComponent(h[1])),g.push("uri="+encodeURIComponent(h[2])),g.push("source="+encodeURIComponent(h[3])))}c="xmldb:exist://"+a.getBasePath();g.push("base="+
encodeURIComponent(c));$.ajax({url:"outline",dataType:"json",type:"POST",data:g.join("&"),success:function(c){if(c!=null){for(var c=c.modules,h=0;h<c.length;h++){var b=c[h].functions;if(b)for(var g=0;g<b.length;g++)f.push({type:"function",name:b[g],signature:b[g],source:c[h].source});if(b=c[h].variables)for(g=0;g<b.length;g++)f.push({type:"variable",name:"$"+b[g],source:c[h].source})}a.functions=a.functions.concat(f);d.$outlineUpdate(a)}}});return f},$sortFunctions:function(a){a.functions.sort(function(a,
d){return a.name==d.name?0:a.name>d.name?1:-1})},$outlineUpdate:function(a){this.$sortFunctions(a);if(this.currentDoc==a){$("body").layout().open("west");eXide.app.resize();var b=$("#outline");b.empty();for(var d=0;d<a.functions.length;d++){var f=a.functions[d],g=document.createElement("li"),c=document.createElement("a");if(f.signature)c.title=f.signature;c.className=f.type=="function"?"t_function":"t_variable";c.href=f.source?"#"+f.source:"#";c.appendChild(document.createTextNode(f.name));g.appendChild(c);
b.append(g);$(c).click(function(){var c=this.hash.substring(1);this.className=="t_function"?eXide.app.findFunction(c==""?null:c,$(this).text()):eXide.app.findVarDecl(c==""?null:c,$(this).text());return!1})}}},$loadTemplates:function(){var a=this;$.ajax({url:"templates/snippets.xml",dataType:"xml",type:"GET",success:function(b){$(b).find("snippet").each(function(){var b=$(this),f=b.attr("abbrev"),g=b.find("description").text(),b=b.find("code").text();a.templates.push({TYPE:"template",name:f,help:g,
template:b})})}})}};return Constr}();eXide.namespace("eXide.keyboard");
eXide.keyboard=function(){var a=require("ace/keyboard/hash_handler").HashHandler,b={selectall:"Ctrl-A",removeline:"Ctrl-D",gotoline:"Ctrl-L",togglecomment:"Ctrl-7",findnext:"Ctrl-K",findprevious:"Ctrl-Shift-K",find:"Ctrl-F",replace:"Ctrl-R",undo:"Ctrl-Z",redo:"Ctrl-Shift-Z|Ctrl-Y",overwrite:"Insert",copylinesup:"Ctrl-Alt-Up",movelinesup:"Alt-Up",selecttostart:"Alt-Shift-Up",gotostart:"Ctrl-Home|Ctrl-Up",selectup:"Shift-Up",golineup:"Up",copylinesdown:"Ctrl-Alt-Down",movelinesdown:"Alt-Down",selecttoend:"Alt-Shift-Down",
gotoend:"Ctrl-End|Ctrl-Down",selectdown:"Shift-Down",golinedown:"Down",selectwordleft:"Ctrl-Shift-Left",gotowordleft:"Ctrl-Left",selecttolinestart:"Alt-Shift-Left",gotolinestart:"Alt-Left|Home",selectleft:"Shift-Left",gotoleft:"Left",selectwordright:"Ctrl-Shift-Right",gotowordright:"Ctrl-Right",selecttolineend:"Alt-Shift-Right",gotolineend:"Alt-Right|End",selectright:"Shift-Right",gotoright:"Right",selectpagedown:"Shift-PageDown",gotopagedown:"PageDown",selectpageup:"Shift-PageUp",gotopageup:"PageUp",
selectlinestart:"Shift-Home",selectlineend:"Shift-End",del:"Delete",backspace:"Backspace",outdent:"Shift-Tab",indentOrParam:"Tab",saveDocument:"Ctrl-Shift-S",openDocument:"Ctrl-Shift-O",newDocument:"Ctrl-Shift-N",closeDocument:"Ctrl-Shift-W",runQuery:"Ctrl-Return",autocomplete:"Ctrl-Space",escape:"Esc",functionDoc:"Ctrl-Shift-H|F1",nextTab:"Ctrl-Shift-PageDown",previousTab:"Ctrl-Shift-PageUp",gotoDefinition:"Ctrl-Shift-B|F3"};return{getKeybinding:function(){return new a(b)},help:function(a){$(a).find("table").each(function(){this.innerHTML=
"";for(var a in b)if(a!="reverse"){var d=document.createElement("tr"),c=document.createElement("td");c.appendChild(document.createTextNode(a));d.appendChild(c);c=document.createElement("td");c.appendChild(document.createTextNode(b[a]));d.appendChild(c);this.appendChild(d)}})}}}();define("ace/mode/xquery_highlight_rules",function(a,b){var d=a("pilot/oop"),f=a("pilot/lang"),g=a("ace/mode/text_highlight_rules").TextHighlightRules,c=function(){var c=f.arrayToMap("return|for|let|declare|function|xquery|version|option|namespace|import|module|if|then|else|as|and|or|typeswitch|case".split("|"));this.$rules={start:[{token:"text",regex:"<\\!\\[CDATA\\[",next:"cdata"},{token:"xml_pe",regex:"<\\?.*?\\?>"},{token:"comment",regex:"<\\!--",next:"comment"},{token:"comment",regex:"\\(:",next:"comment"},
{token:"text",regex:"<\\/?",next:"tag"},{token:"constant",regex:"[+-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"variable",regex:"\\$[a-zA-Z_][a-zA-Z0-9_\\-:]*\\b"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"},{token:"text",regex:"\\s+"},{token:function(a){return c[a]?"keyword":"identifier"},regex:"[a-zA-Z_$][a-zA-Z0-9_$]*\\b"}],tag:[{token:"text",regex:">",next:"start"},{token:"keyword",regex:"[-_a-zA-Z0-9:]+"},{token:"text",regex:"\\s+"},{token:"string",regex:'".*?"'},
{token:"string",regex:"'.*?'"}],cdata:[{token:"text",regex:"\\]\\]>",next:"start"},{token:"text",regex:"\\s+"},{token:"text",regex:"(?:[^\\]]|\\](?!\\]>))+"}],comment:[{token:"comment",regex:".*?--\>",next:"start"},{token:"comment",regex:".*:\\)",next:"start"},{token:"comment",regex:".+"}]}};d.inherits(c,g);b.XQueryHighlightRules=c});
define("ace/mode/xquery",function(a,b){var d=a("pilot/oop"),f=a("ace/mode/text").Mode,g=a("ace/tokenizer").Tokenizer,c=a("ace/mode/xquery_highlight_rules").XQueryHighlightRules,h=a("ace/range").Range,e=function(){this.$tokenizer=new g((new c).getRules())};d.inherits(e,f);(function(){this.getNextLineIndent=function(c,a,e){c=this.$getIndent(a);a.match(/\s*(?:then|else|return|[{\(]|<\w+>)\s*$/)&&(c+=e);return c};this.checkOutdent=function(c,a,e){if(!/^\s+$/.test(a))return!1;return/^\s*[\}\)]/.test(e)};
this.autoOutdent=function(c,a,e){c=a.getLine(e).match(/^(\s*[\}\)])/);if(!c)return 0;var c=c[1].length,b=a.findMatchingBracket({row:e,column:c});if(!b||b.row==e)return 0;b=this.$getIndent(a.getLine(b.row));a.replace(new h(e,0,e,c-1),b)};this.$getIndent=function(c){if(c=c.match(/^(\s+)/))return c[1];return""}}).call(e.prototype);b.Mode=e});eXide.namespace("eXide.edit.Document");
eXide.edit.Document=function(){Constr=function(a,b,d){this.name=a;this.path=b;this.mime="application/xquery";this.syntax="xquery";this.saved=!1;this.editable=!0;this.functions=[];this.$session=d};Constr.prototype={getText:function(){return this.$session.getValue()},getName:function(){return this.name},getPath:function(){return this.path},getBasePath:function(){return this.path.replace(/(^.+)\/[^\/]*$/,"$1")},getMime:function(){return this.mime},getSyntax:function(){return this.syntax},isSaved:function(){return this.saved},
isEditable:function(){return this.editable},isXQuery:function(){return this.mime=="application/xquery"}};return Constr}();eXide.namespace("eXide.edit.Editor");
eXide.edit.Editor=function(){var a=require("ace/virtual_renderer").VirtualRenderer,b=require("ace/editor").Editor,d=require("ace/edit_session").EditSession,f=require("ace/undomanager").UndoManager,g=/^[\$\w:\-_\.]+/;Constr=function(c){var h=this;h.container=c;h.documents=[];h.activeDoc=null;h.tabCounter=0;h.newDocCounter=0;h.pendingCheck=!1;h.events={activate:[],validate:[],close:[]};eXide.edit.commands.init(h);require("pilot/plugin_manager").catalog.registerPlugins(["pilot/index"]);c=new a(h.container,
"ace/theme/eclipse");c.setShowGutter(!0);this.editor=new b(c);this.editor.setKeyboardHandler(eXide.keyboard.getKeybinding());this.outline=new eXide.edit.Outline(this);this.status=document.getElementById("error-status");$(this.status).click(function(c){c.preventDefault();var a=this.pathname,c=this.hash.substring(1);if(a=h.getDocument(a))h.switchTo(a),h.editor.gotoLine(parseInt(c)+1)});this.lastChangeEvent=(new Date).getTime();this.validateTimeout=null};Constr.prototype={init:function(){this.documents.length==
0&&this.newDocument()},getActiveDocument:function(){return this.activeDoc},getText:function(){return this.activeDoc.getText()},newDocument:function(){for(var c=this,a=0,e=0;e<c.documents.length;e++)c.documents[e].path.match(/^__new__(\d+)/)&&(a=parseInt(RegExp.$1));a++;var b=new eXide.edit.Document("new-document "+a,"__new__"+a,new d('xquery version "1.0";\n'));b.$session.setUndoManager(new f);b.$session.addEventListener("change",function(){b.saved=!1;c.triggerCheck()});a=require("ace/mode/xquery").Mode;
b.$session.setMode(new a);this.addTab(b);this.editor.setSession(b.$session);this.editor.focus()},newDocumentWithText:function(c,a,e){c=new eXide.edit.Document(e.name,e.path,new d(c));c.editable=e.writable;c.mime=a;c.syntax=eXide.util.mimeTypes.getLangFromMime(a);c.saved=!1;this.$initDocument(c)},openDocument:function(c,a,e){e.writable?eXide.util.message("Opening "+e.path):eXide.util.message("Opening "+e.path+" readonly!");c=new eXide.edit.Document(e.name,e.path,new d(c));c.editable=e.writable;c.mime=
a;c.syntax=eXide.util.mimeTypes.getLangFromMime(a);c.saved=!0;$.log("opening %s, mime: %s, syntax: %s",e.name,c.mime,c.syntax);this.$initDocument(c)},$initDocument:function(c){var a=this;a.$setMode(c);c.$session.setUndoManager(new f);c.$session.addEventListener("change",function(){if(c.saved)c.saved=!1,a.updateTabStatus(c.path,c);a.triggerCheck()});a.addTab(c);a.editor.setSession(c.$session);a.editor.resize();a.editor.focus()},setMode:function(c){this.activeDoc.syntax=c;this.$setMode(this.activeDoc,
!0)},$setMode:function(c,a){switch(c.syntax){case "xquery":var e=require("ace/mode/xquery").Mode;c.$session.setMode(new e);if(a)c.mime="application/xquery";break;case "xml":e=require("ace/mode/xml").Mode;c.$session.setMode(new e);if(a)c.mime="application/xml";break;case "html":e=require("ace/mode/html").Mode;c.$session.setMode(new e);if(a)c.mime="text/html";break;case "javascript":e=require("ace/mode/javascript").Mode;c.$session.setMode(new e);if(a)c.mime="application/x-javascript";break;case "css":if(e=
require("ace/mode/css").Mode,c.$session.setMode(new e),a)c.mime="text/css"}},closeDocument:function(){this.$triggerEvent("close",[this.activeDoc]);$("#tabs a[title="+this.activeDoc.path+"]").parent().remove();for(var c=0;c<this.documents.length;c++)this.documents[c].path==this.activeDoc.path&&this.documents.splice(c,1);this.documents.length==0?this.newDocument():(this.activeDoc=this.documents[this.documents.length-1],$("#tabs a[title="+this.activeDoc.path+"]").addClass("active"),this.editor.setSession(this.activeDoc.$session),
this.editor.resize(),this.$triggerEvent("activate",[this.activeDoc]))},saveDocument:function(c,a,e){var b=this,d=b.activeDoc.path,f=b.activeDoc.name;if(c)b.activeDoc.path=c.path,b.activeDoc.name=c.name;eXide.util.message("Storing resource "+b.activeDoc.name+"...");c={path:b.activeDoc.path,data:b.activeDoc.getText()};if(b.activeDoc.mime)c.mime=b.activeDoc.mime;$.ajax({url:"store.xql",type:"POST",data:c,dataType:"json",success:function(c){c?e?e.apply(b.activeDoc,[c.message]):eXide.util.error(c.message):
(b.activeDoc.saved=!0,b.updateTabStatus(d,b.activeDoc),a?a.apply(b.activeDoc):eXide.util.message(b.activeDoc.name+" stored."))},error:function(c){b.activeDoc.path=d;b.activeDoc.name=f;e?e.apply(b.activeDoc,c.responseText):eXide.util.error(c.responseText)}})},getDocument:function(c){for(var c=eXide.util.normalizePath(c),a=0;a<this.documents.length;a++)if(this.documents[a].path==c)return this.documents[a]},autocomplete:function(){if(this.activeDoc.isXQuery()){require("pilot/lang");for(var c=require("ace/range").Range,
a=this.editor.getSelection(),e=this.editor.getSession(),a=a.getSelectionLead(),b=e.getDisplayLine(a.row),e=a.column-1,d=a.column;e>=0;){var f=b.substring(e,d);if(f.match(/^\$[\w:\-_\.]+$/))break;if(!f.match(/^[\w:\-_\.]+$/)){e++;break}e--}b=b.substring(e,d);$.log("completing token: %s",b);c=new c(a.row,e,a.row,d);a=this.editor.renderer.textToScreenCoordinates(a.row,a.column);$("#autocomplete-box").css({left:a.pageX+"px",top:a.pageY+20+"px"});$("#autocomplete-help").css({left:a.pageX+324+"px",top:a.pageY+
20+"px"});b.length==0?this.templateLookup(this.activeDoc,b,c,!0):this.functionLookup(this.activeDoc,b,c,!0);return!0}},$localVars:function(c,a){for(var e=[],b=/declare function|};/,d=/let \$[\w\:]+|for \$[\w\:]+|\$[\w\:]+\)/,f=/\$[\w\:]+/,g=RegExp("^\\"+c),j=this.editor.getSession(),n=a.start.row;n>-1;){var k=j.getDisplayLine(n),m;if(m=k.match(d))$.log("Var: %s",m[0]),m=m[0].match(f),m[0].match(g)&&e.push({name:m[0],type:"variable"});if(k.match(b)){$.log("Stop: %s",k);break}n--}return e},functionLookup:function(c,
a,e,b){var d=this;$.ajax({url:"docs.xql",dataType:"text",type:"POST",data:{prefix:a},success:function(f){var f=$.parseJSON(f),g=[],j;a.substring(0,1)=="$"?(j="^\\"+a,g=d.$localVars(a,e,b)):j="^"+a;var n=RegExp(j);$.each(d.activeDoc.functions,function(c,a){a.name.match(n)&&g.push(a)});f&&(g=g.concat(f));f=[];for(j=0;j<g.length;j++){var k={label:g[j].signature?g[j].signature:g[j].name,type:g[j].type};if(g[j].help)k.tooltip=g[j].help;f.push(k)}d.$addTemplates(a,f);d.$showPopup(c,e,f)},error:function(c,
a){eXide.util.error(a)}})},templateLookup:function(c,a,e){var b=[];this.$addTemplates(a,b);this.$showPopup(c,e,b)},$addTemplates:function(c,a){for(var e=this.outline.getTemplates(c),b=0;b<e.length;b++)a.push({type:"template",label:"[S] "+e[b].name,tooltip:e[b].help,template:e[b].template})},$showPopup:function(c,a,e){var b=this;eXide.util.popup($("#autocomplete-box"),$("#autocomplete-help"),e,function(e){if(e){var d=e.label;e.type=="template"?d=e.template:e.type=="function"&&(d=eXide.util.parseSignature(d));
c.template=new eXide.edit.Template(b,a,d,e.type);c.template.insert()}b.editor.focus()})},getFunctionAtCursor:function(c){var a=c.row,a=this.editor.getSession().getDisplayLine(a),e=c.column;do e--;while(e>=0&&a.charAt(e).match(g));e++;for(c=c.column;c<a.length&&a.charAt(c).match(g);)c++;return a.substring(e,c)},showFunctionDoc:function(){var a=this.editor.getSelection().getSelectionLead(),b=this.editor.renderer.textToScreenCoordinates(a.row,a.column);$("#autocomplete-box").css({left:b.pageX+"px",top:b.pageY+
20+"px"});$("#autocomplete-help").css({left:b.pageX+324+"px",top:b.pageY+20+"px"});this.functionLookup(this.activeDoc,this.getFunctionAtCursor(a),null,!1)},gotoDefinition:function(){var a=this.getFunctionAtCursor(this.editor.getSelection().getSelectionLead());$.log("funcName = %s",a);a&&this.outline.gotoDefinition(this.activeDoc,a)},gotoFunction:function(a){var b=this.getModuleNamespacePrefix();b!=null&&(a=a.replace(/[^:]+:/,b+":"));$.log("Goto function %s",a);for(var a=RegExp("function\\s+"+a+"\\s*\\("),
b=this.activeDoc.$session.getLength(),e=0;e<b;e++)if(this.activeDoc.$session.getLine(e).match(a)){this.editor.gotoLine(e+1);this.editor.focus();break}},gotoVarDecl:function(a){var b=this.getModuleNamespacePrefix();b!=null&&(a=a.replace(/[^:]+:/,"$"+b+":"));$.log("Goto variable declaration %s",a);for(var a=RegExp("variable\\s+\\"+a),b=this.activeDoc.$session.getLength(),e=0;e<b;e++)if(this.activeDoc.$session.getLine(e).match(a)){this.editor.gotoLine(e+1);this.editor.focus();break}},getModuleNamespacePrefix:function(){for(var a=
/^\s*module\s+namespace\s+([^=\s]+)\s*=/,b=this.activeDoc.$session.getLength(),e=0;e<b;e++){var d=this.activeDoc.$session.getLine(e).match(a);if(d)return d[1]}return null},resize:function(){this.editor.resize()},addTab:function(a){var b=this,e="t"+b.tabCounter++,d=a.name;a.saved||(d+="*");$("#tabs li a").removeClass("active");var f=document.createElement("li"),g=document.createElement("a");g.appendChild(document.createTextNode(d));g.className="tab active";g.id=e;g.title=a.path;f.appendChild(g);$("#tabs").append(f);
$(g).click(function(e){e.preventDefault();b.switchTo(a)});b.activeDoc=a;b.documents.push(a);b.$triggerEvent("activate",[a])},nextTab:function(){if(!(this.documents.length<2)){for(var a=0,b=0;b<this.documents.length;b++)if(this.documents[b]==this.activeDoc){a=b;break}a==this.documents.length-1?a=0:a++;this.switchTo(this.documents[a])}},previousTab:function(){if(!(this.documents.length<2)){for(var a=0,b=0;b<this.documents.length;b++)if(this.documents[b]==this.activeDoc){a=b;break}a==0?a=this.documents.length-
1:a--;this.switchTo(this.documents[a])}},switchTo:function(a){this.editor.setSession(a.$session);this.editor.resize();this.activeDoc=a;$("#tabs a").each(function(){this.title==a.path?$(this).addClass("active"):$(this).removeClass("active")});this.status.innerHTML="";this.$triggerEvent("activate",[a])},updateTabStatus:function(a,b){var e;e=b.saved?b.name:b.name+"*";$("#tabs a[title="+a+"]").attr("title",b.path).text(e)},setTheme:function(a){$.log("Changing theme to %s",a);this.editor.setTheme(a)},
triggerCheck:function(){if(this.activeDoc.isXQuery()){var a=this;if(!a.pendingCheck){var b=(new Date).getTime();a.validateTimeout&&b-a.lastChangeEvent<2E3&&clearTimeout(a.validateTimeout);a.lastChangeEvent=b;a.validateTimeout=setTimeout(function(){a.validateQuery.apply(a)},2E3)}}},validateQuery:function(){if(this.activeDoc.isXQuery){this.pendingCheck=!0;$.log("Running validation...");var a=this,b=a.getText(),e="xmldb:exist://"+a.activeDoc.getBasePath();$.ajax({type:"POST",url:"compile.xql",data:{q:b,
base:e},dataType:"json",success:function(b){a.compileError(b);a.pendingCheck=!1},error:function(b,e){a.pendingCheck=!1;$.log("Compile error: %s - %s",e,b.responseText)}});a.$triggerEvent("validate",[a.activeDoc])}},evalError:function(a){var b=/.*line\s(\d+)/i.exec(a),e=-1;b&&(e=parseInt(b[1]));$.log("error in line %d",b[1]);this.editor.focus();this.editor.gotoLine(e);b=[{row:e-1,text:a,type:"error"}];this.status.innerHTML=a;this.editor.getSession().setAnnotations(b)},compileError:function(a){if(a.result==
"fail"){var b;b=a.error.line?a.error["#text"]:a.error;var e=/.*line:?\s(\d+)/i.exec(b),d=-1;e?d=parseInt(e[1])-1:a.error.line&&(d=parseInt(a.error.line)-1);a=[{row:d,text:b,type:"error"}];this.status.innerHTML=b;this.status.href=this.activeDoc.path+"#"+d;this.editor.getSession().setAnnotations(a)}else this.clearErrors(),this.status.innerHTML=""},clearErrors:function(){this.editor.getSession().clearAnnotations()},saveState:function(){var a=0;$.each(this.documents,function(b,e){e.path.match("^__new__.*")?
(localStorage["eXide."+a+".path"]=e.path,localStorage["eXide."+a+".name"]=e.name,localStorage["eXide."+a+".mime"]=e.mime,localStorage["eXide."+a+".data"]=e.getText()):(localStorage["eXide."+a+".path"]=e.path,localStorage["eXide."+a+".name"]=e.name,localStorage["eXide."+a+".mime"]=e.mime,localStorage["eXide."+a+".writable"]=e.editable?"true":"false",e.saved||(localStorage["eXide."+a+".data"]=e.getText()));a++});localStorage["eXide.documents"]=a},addEventListener:function(a,b,e){(a=this.events[a])&&
a.push({obj:b,callback:e})},$triggerEvent:function(a,b){var e=this.events[a];if(e)for(var d=0;d<e.length;d++)e[d].callback.apply(e[d].obj,b)}};return Constr}();$(document).ready(function(){eXide.app.init()});eXide.namespace("eXide.app");
eXide.app=function(){var a,b,d,f=0,g=0,c=0,h=0;return{init:function(){a=new eXide.edit.Editor(document.getElementById("editor"));b=new eXide.edit.PackageEditor(document.getElementById("deployment-editor"));d=new eXide.browse.Browser(document.getElementById("open-dialog"));eXide.app.initGUI();eXide.app.restoreState();a.init();a.addEventListener("outlineChange",eXide.app.onOutlineChange);eXide.app.resize();$(window).resize(eXide.app.resize);$(window).unload(function(){eXide.app.saveState()})},resize:function(){$("#editor");
$(".header");a.resize()},newDocument:function(){a.newDocument()},findDocument:function(b){var c=a.getDocument(b);c==null?(b={name:b.match(/[^\/]+$/),path:b},eXide.app.$doOpenDocument(b)):a.switchTo(c)},findFunction:function(b,c){if(b==null)a.gotoFunction(c);else{$.log("Locating function %s in document %s",c,b);var d=a.getDocument(b);d==null?(d={name:b.match(/[^\/]+$/),path:b},eXide.app.$doOpenDocument(d,function(){a.gotoFunction(c)})):(a.switchTo(d),a.gotoFunction(c))}},findVarDecl:function(b,c){if(b==
null)a.gotoVarDecl(c);else{$.log("Locating variable %s in document %s",c,b);var d=a.getDocument(b);d==null?(d={name:b.match(/[^\/]+$/),path:b},eXide.app.$doOpenDocument(d,function(){a.gotoVarDecl(c)})):(a.switchTo(d),a.gotoVarDecl(c))}},openDocument:function(){d.reload();$("#open-dialog").dialog("option","buttons",{cancel:function(){$(this).dialog("close")},open:eXide.app.openSelectedDocument});$("#open-dialog").dialog("open")},openSelectedDocument:function(){var a=d.getSelection();eXide.app.$doOpenDocument(a);
$(this).dialog("close")},$doOpenDocument:function(b,c){b.path=eXide.util.normalizePath(b.path);$.ajax({url:"load.xql?path="+b.path,dataType:"text",success:function(d,f,g){f=eXide.util.mimeTypes.getMime(g.getResponseHeader("Content-Type"));a.openDocument(d,f,b);c&&c.call(null,b)},error:function(a){eXide.util.error("Failed to load document "+b.path+": "+a.status+" "+a.statusText)}})},closeDocument:function(){a.getActiveDocument().isSaved()?a.closeDocument():$("#dialog-confirm-close").dialog({resizable:!1,
height:140,modal:!0,buttons:{Close:function(){$(this).dialog("close");a.closeDocument()},Cancel:function(){$(this).dialog("close")}}})},saveDocument:function(){a.getActiveDocument().getPath().match("^__new__")?($("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){a.saveDocument(d.getSelection(),function(){$("#open-dialog").dialog("close")},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}}),$("#open-dialog").dialog("open")):a.saveDocument(null,
function(){eXide.util.message(a.getActiveDocument().getName()+" stored.")},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})},download:function(){var b=a.getActiveDocument();b.getPath().match("^__new__")||!b.isSaved()?eXide.util.error("There are unsaved changes in the document. Please save it first."):window.location.href="load.xql?download=true&path="+encodeURIComponent(b.getPath())},runQuery:function(){var b=a.getText(),d="xmldb:exist://"+a.getActiveDocument().getBasePath();$("#results-container .results").empty();
$.ajax({type:"POST",url:"execute",dataType:"xml",data:{qu:b,base:d},success:function(b){b=b.documentElement;if(b.nodeName=="error")b=$(b).text(),eXide.util.error(b,"Compilation Error"),a.evalError(b);else{a.clearErrors();var e=$("body").layout();e.open("south");e.sizePane("south",300);eXide.app.resize();c=g=1;f=b.getAttribute("hits");h=g+10-1;f<h&&(h=f);eXide.util.message("Found "+f+" in "+b.getAttribute("elapsed"));eXide.app.retrieveNext()}},error:function(a){eXide.util.error(a.responseText,"Server Error")}})},
checkQuery:function(){a.validateQuery()},retrieveNext:function(){$.log("retrieveNext: %d",c);if(c>0&&c<=h){var a="results/"+c;c++;$.ajax({url:a,dataType:"html",success:function(a){$("#results-container .results").append(a);$("#results-container .current").text("Showing results "+g+" to "+(c-1)+" of "+f);$("#results-container .pos:last a").click(function(){eXide.app.findDocument(this.pathname);return!1});eXide.app.retrieveNext()}})}},browseNext:function(){c>0&&h<f&&(g=c,h=c+10-1,f<h&&(h=f),$("#results-container .results").empty(),
eXide.app.retrieveNext());return!1},browsePrevious:function(){c>0&&g>1&&(g-=10,g<1&&(g=1),c=g,h=c+9,f<h&&(h=f),$("#results-container .results").empty(),eXide.app.retrieveNext());return!1},deploymentSettings:function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());c&&eXide.app.$checkLogin()&&($.log("Editing deployment settings for collection: %s",c[1]),b.open(c[1]))},newDeployment:function(){eXide.app.$checkLogin()&&b.open()},deploy:function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());
if(!c)return eXide.util.error("The file open in the editor does not belong to an application package!"),!1;eXide.app.$checkLogin();$.log("Deploying application from collection: %s",c[1]);b.deploy(c[1]);return!1},synchronize:function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());c&&b.synchronize(c[1])},openApp:function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());c&&b.runApp(c[1])},restoreState:function(){if(!eXide.util.supportsHtml5Storage)return!1;var c=localStorage["eXide.theme"];
c&&($("#theme").val(c),a.setTheme(c));(c=localStorage["eXide.documents"])||(c=0);for(var d=0;d<c;d++){var f={path:localStorage["eXide."+d+".path"],name:localStorage["eXide."+d+".name"],writable:localStorage["eXide."+d+".writable"]=="true"},g=localStorage["eXide."+d+".data"];g?a.newDocumentWithText(g,localStorage["eXide."+d+".mime"],f):eXide.app.$doOpenDocument(f)}b.restoreState();return!0},saveState:function(){eXide.util.supportsHtml5Storage&&(localStorage.clear(),localStorage["eXide.theme"]=$("#theme").val(),
a.saveState(),b.saveState())},$checkLogin:function(){if(eXide.app.login)return!0;eXide.util.error("Warning: you are not logged in.");return!1},initGUI:function(){$("body").layout({enableCursorHotkey:!1,north__size:78,north__resizable:!1,south__minSize:200,south__initClosed:!0,west__size:200,west__initClosed:!0,west__contentSelector:".content",center__minSize:300,center__onresize:eXide.app.resize,center__contentSelector:".content"});$(".menu ul li").hover(function(){$("ul",this).slideDown(200)},function(){$("ul",
this).slideUp(200)});$("#open-dialog").dialog({title:"Open File",modal:!0,autoOpen:!1,height:400,width:700,open:function(){d.init()}});$("#login-dialog").dialog({title:"Login",modal:!0,autoOpen:!1,buttons:{Login:function(){$.ajax({url:"login",data:$("#login-form").serialize(),success:function(){eXide.app.login=$("#login-form input[name=user]").val();$.log("Logged in as %s",eXide.app.login);$("#login-dialog").dialog("close");$("#user").text("Logged in as "+eXide.app.login+". ");$("#login").text("Logout")},
error:function(){$("#login-error").text("Login failed. Bad username or password.");$("#login-dialog input:first").focus()}})},Cancel:function(){$(this).dialog("close")}},open:function(){$(this).find("input").val("");$(this).find("input:first").focus();$("#login-error").empty();var a=$(this);a.find("input").keyup(function(b){b.keyCode==13&&a.parent().find(".ui-dialog-buttonpane button:first").trigger("click")})}});$("#keyboard-help").dialog({title:"Keyboard Shortcuts",modal:!1,autoOpen:!1,height:400,
buttons:{Close:function(){$(this).dialog("close")}},open:function(){eXide.keyboard.help($("#keyboard-help"))}});$("#help-shortcuts").click(function(a){a.preventDefault();$("#keyboard-help").dialog("open")});var b=$("#open").button({icons:{primary:"ui-icon-folder-open"}});b.click(eXide.app.openDocument);$("#menu-file-open").click(eXide.app.openDocument);b=$("#close").button({icons:{primary:"ui-icon-close"}});b.click(eXide.app.closeDocument);$("#menu-file-close").click(eXide.app.closeDocument);b=$("#new").button({icons:{primary:"ui-icon-document"}});
b.click(eXide.app.newDocument);$("#menu-file-new").click(eXide.app.newDocument);b=$("#run").button({icons:{primary:"ui-icon-play"}});b.click(eXide.app.runQuery);b=$("#validate").button({icons:{primary:"ui-icon-check"}});b.click(eXide.app.checkQuery);b=$("#save").button({icons:{primary:"ui-icon-disk"}});b.click(eXide.app.saveDocument);$("#menu-file-save").click(eXide.app.saveDocument);b=$("#download").button({icons:{primary:"ui-icon-transferthick-e-w"}});b.click(eXide.app.download);$("#menu-file-download").click(eXide.app.download);
$("#menu-deploy-new").click(eXide.app.newDeployment);$("#menu-deploy-edit").click(eXide.app.deploymentSettings);$("#menu-deploy-deploy").click(eXide.app.deploy);$("#menu-deploy-sync").click(eXide.app.synchronize);$("#menu-edit-undo").click(function(b){b.preventDefault();a.editor.undo()});$("#menu-edit-redo").click(function(b){b.preventDefault();a.editor.redo()});$("#menu-deploy-run").click(eXide.app.openApp);$("#theme").change(function(){a.setTheme($(this).val())});$("#syntax").change(function(){a.setMode($(this).val())});
a.addEventListener("activate",null,function(a){$("#syntax").val(a.getSyntax())});$("#login").click(function(a){a.preventDefault();$("#login-dialog").dialog("open")});$("#results-container .next").click(eXide.app.browseNext);$("#results-container .previous").click(eXide.app.browsePrevious)}}}();eXide.namespace("eXide.edit.PackageEditor");
eXide.edit.PackageEditor=function(){Constr=function(){var a=this;this.directory=null;this.container=$("#sandbox_dialog_deploy");if(this.container.length==0){var b=document.createElement("div");b.id="sandbox_dialog_deploy";document.body.appendChild(b);this.container=$(b)}this.container.dialog({title:"Deployment Editor",modal:!0,autoOpen:!1,width:480,height:600});this.syncDialog=$("#synchronize-dialog");this.syncDialog.dialog({title:"Synchronize to Directory",modal:!0,autoOpen:!1,width:500,height:400,
buttons:{Synchronize:function(){var b=a.syncDialog.find("input[name=dir]").val();!b||b.length==0?$("#synchronize-report").text("No output directory specified!"):($("#synchronize-report").text("Synchronization in progress ..."),$("#synchronize-report").load("synchronize.xql",{collection:a.collection,start:a.syncDialog.find("input[name=date]").val(),dir:b}),this.directory=b)},Close:function(){$(this).dialog("close")}}});this.directory&&this.syncDialog.find("input[name=dir]").val(this.directory)};Constr.prototype=
{open:function(a){var b=this,d=null;a&&(d={collection:a});$.ajax({url:"deployment.xql",type:"POST",data:d,success:function(a){b.container.html(a);b.container.form({done:function(){var a=b.container.find("form").serialize();$.ajax({url:"deployment.xql",type:"POST",data:a,success:function(){b.container.dialog("close")},error:function(a){eXide.util.error(a.responseText)}})},cancel:function(){b.container.dialog("close")}});b.container.find(".author-repeat").repeat("#author-add-trigger",{deleteTrigger:"#author-remove-trigger"});
b.container.dialog("open")},error:function(a){eXide.util.error(a.responseText)}})},deploy:function(a){$.ajax({url:"deployment.xql",type:"POST",dataType:"json",data:{collection:a,deploy:"true"},success:function(a){a=location.protocol+"//"+location.hostname+":"+location.port+"/exist/apps/"+a+"/";eXide.util.Dialog.message("Application Deployed",'<p>The application has been deployed. On a standard installation the following link should open it:</p><center><a href="'+a+'" target="_new">'+a+"</a></center>")},
error:function(a){eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>")}})},synchronize:function(a){var b=this;$.getJSON("deployment.xql",{info:a},function(a){a.isAdmin?(b.collection=a.root,b.syncDialog.find("input[name=date]").val(a.deployed),b.syncDialog.dialog("open")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature.")})},runApp:function(a){$.getJSON("deployment.xql",{info:a},function(a){a.isAdmin?
(a="/exist/apps/"+a.root.replace(/^\/db\//,"")+"/",eXide.util.Dialog.message("Run Application",'<p>Click on the following link to open your application:</p><center><a href="'+a+'" target="_new">'+a+"</a></center>")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature.")})},saveState:function(){localStorage["eXide.synchronize.dir"]=this.directory},restoreState:function(){this.directory=localStorage["eXide.synchronize.dir"]}};return Constr}();eXide.namespace("eXide.edit.Template");
eXide.edit.Template=function(){var a=/\n/;Constr=function(b,d,f,g){var c=f.split(a).length;this.code=f;this.editor=b.editor;this.range=d;this.type=g;this.startLine=d.start.row;this.endLine=this.startLine+c-1;$.log("startLine = %i, endLine = %i",this.startLine,this.endLine);this.currentLine=this.startLine;this.lineOffset=this.startColumn=d.start.column;this.regex=/\$[\w\-:_]+/g;if(this.startColumn>0)this.regex.lastIndex=this.startColumn};Constr.prototype={insert:function(){this.editor.getSession().remove(this.range);this.editor.insert(this.code);
this.code.substring(0,1)!="$"&&this.editor.navigateLeft();this.type!="variable"&&this.nextParam();this.editor.focus()},nextParam:function(){var a=this.editor.getSession(),d=this.editor.getSelection(),f=d.getSelectionLead();if(f.row<this.startLine||f.row>this.endLine)return!1;for(var g=f=!1;this.currentLine<=this.endLine;){var c=a.getDisplayLine(this.currentLine);$.log("Checking line %s",c);if(c=this.regex.exec(c)){$.log("Matched %s",c[0]);d.setSelectionAnchor(this.currentLine,c.index);d.selectTo(this.currentLine,
c.index+c[0].length);this.lineOffset=c.index;g=!0;break}else this.lineOffset=0,this.currentLine++;if(this.currentLine>this.endLine&&!f){$.log("loop %i",this.startColumn);this.currentLine=this.startLine;if(this.startColumn>0)this.lineOffset=this.startColumn,this.regex.lastIndex=this.lineOffset;f=!0}}return g}};return Constr}();eXide.namespace("eXide.browse.CollectionBrowser");
eXide.browse.CollectionBrowser=function(){Constr=function(a){var b=this;this.events={activate:[]};this.selected=null;var d=document.createElement("div");d.className="eXide-browse-toolbar";a.appendChild(d);var f=document.createElement("button");f.title="Reload";var g=document.createElement("img");g.src="images/arrow_refresh.png";f.appendChild(g);$(f).click(function(a){a.preventDefault();b.reload()});d.appendChild(f);d=document.createElement("div");d.className="eXide-browse-collections eXide-browse-content";
a.appendChild(d);this.container=$(d);this.container.dynatree({persist:!1,rootVisible:!1,initAjax:{url:"collections.xql"},clickFolderMode:1,onActivate:function(a){a=a.data.key;$.log("activate %s",a);b.selected=a;b.$triggerEvent("activate",[a])},onPostInit:function(){var a;b.selected?($.log("prevKey: %s",b.selected),a=this.getNodeByKey(b.selected)):a=this.getNodeByKey("/db");a.activate();a.expand(!0)}})};Constr.prototype={getSelection:function(){return this.selected},reload:function(){$.log("Reloading tree...");
this.container.dynatree("getTree").reload()},addEventListener:function(a,b,d){(a=this.events[a])&&a.push({obj:b,callback:d})},$triggerEvent:function(a,b){var d=this.events[a];if(d)for(var f=0;f<d.length;f++)d[f].callback.apply(d[f].obj,b)}};return Constr}();eXide.namespace("eXide.browse.ResourceBrowser");
eXide.browse.ResourceBrowser=function(){var a=["name","permissions","owner","group","lastModified"],b=["Name","Permissions","Owner","Group","Last Modified"];Constr=function(a){this.container=a;this.events={activate:[]};var f=document.createElement("table"),g=document.createElement("thead");f.appendChild(g);var c=document.createElement("tr");g.appendChild(c);for(g=0;g<b.length;g++){var h=document.createElement("th");h.appendChild(document.createTextNode(b[g]));c.appendChild(h)}c=document.createElement("tbody");
f.appendChild(c);a.appendChild(f);this.view=c;this.activeRow=null};Constr.prototype={update:function(d){$.log("Opening collection %s",d);var f=this;f.activeRow=null;$.getJSON("collections.xql",{root:d,view:"r"},function(g){f.view.innerHTML="";if(g)for(var c=0;c<g.length;c++){var h=c%2==0?"even":"uneven",e=document.createElement("tr");e.className=h;e.style.cursor="pointer";for(h=0;h<b.length;h++){var i=document.createElement("td");i.className=a[h];i.appendChild(document.createTextNode(g[c][h]));e.appendChild(i)}f.view.appendChild(e);
e.doc={name:g[c][0],path:d+"/"+g[c][0],writable:g[c][5]};$(e).click(function(){f.activeRow&&$(f.activeRow).removeClass("eXide-browser-active");f.activeRow=this;$(this).addClass("eXide-browser-active");f.$triggerEvent("activate",[this.doc])})}})},addEventListener:function(a,b,g){(a=this.events[a])&&a.push({obj:b,callback:g})},$triggerEvent:function(a,b){var g=this.events[a];if(g)for(var c=0;c<g.length;c++)g[c].callback.apply(g[c].obj,b)}};return Constr}();eXide.namespace("eXide.browse.Browser");
eXide.browse.Browser=function(){Constr=function(a){var b=document.createElement("div");b.className="eXide-browse-panel";a.appendChild(b);var d=document.createElement("div");d.className="eXide-browse-collections ui-layout-west";b.appendChild(d);var f=document.createElement("div");f.className="eXide-browse-resources ui-layout-center";b.appendChild(f);b=document.createElement("div");b.className="eXide-browse-form";b.style.paddingTop="10px";var g=document.createElement("label");g.appendChild(document.createTextNode("Selection: "));
b.appendChild(g);g=document.createElement("input");g.name="resource";g.type="text";b.appendChild(g);a.appendChild(b);this.selection=g;this.container=a;this.resources=new eXide.browse.ResourceBrowser(f);this.collections=new eXide.browse.CollectionBrowser(d);this.initialized=!1;this.collections.addEventListener("activate",this.resources,this.resources.update);this.resources.addEventListener("activate",this,this.$resourceSelected)};Constr.prototype={init:function(){var a=$(this.container).innerHeight()-
$(".eXide-browse-form",this.container).height()-25;$.log("height: %i",a);$(".eXide-browse-panel",this.container).height(a);if(!this.initialized)$(".eXide-browse-panel",this.container).layout({enableCursorHotkey:!1,south__resizable:!1,west__size:200,west__initClosed:!1,west__contentSelector:".eXide-browse-content",center__minSize:300}),this.initialized=!0},reload:function(){this.collections.reload();this.resources.update(this.collections.getSelection());$(this.selection).val("")},getSelection:function(){var a=
$(this.selection).val();return{name:a,path:this.collections.getSelection()+"/"+a,writable:!0}},$resourceSelected:function(a){$(this.selection).val(a.name)}};return Constr}();
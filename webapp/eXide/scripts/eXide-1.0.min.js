define("eXide/mode/xquery_highlight_rules",function(a,b){var e=a("pilot/oop"),f=a("pilot/lang"),d=a("ace/mode/text_highlight_rules").TextHighlightRules,c=function(){var d=f.arrayToMap("return|for|let|declare|function|xquery|version|option|namespace|import|module|if|then|else|as|and|or|typeswitch|case".split("|"));this.$rules={start:[{token:"text",regex:"<\\!\\[CDATA\\[",next:"cdata"},{token:"xml_pe",regex:"<\\?.*?\\?>"},{token:"comment",regex:"<\\!--",next:"comment"},{token:"comment",regex:"\\(:",
next:"comment"},{token:"text",regex:"<\\/?",next:"tag"},{token:"constant",regex:"[+-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"variable",regex:"\\$[a-zA-Z_][a-zA-Z0-9_\\-:]*\\b"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"},{token:"text",regex:"\\s+"},{token:function(c){return d[c]?"keyword":"identifier"},regex:"[a-zA-Z_$][a-zA-Z0-9_$]*\\b"}],tag:[{token:"text",regex:">",next:"start"},{token:"keyword",regex:"[-_a-zA-Z0-9:]+"},{token:"text",regex:"\\s+"},{token:"string",
regex:'".*?"'},{token:"string",regex:"'.*?'"}],cdata:[{token:"text",regex:"\\]\\]>",next:"start"},{token:"text",regex:"\\s+"},{token:"text",regex:"(?:[^\\]]|\\](?!\\]>))+"}],comment:[{token:"comment",regex:".*?--\>",next:"start"},{token:"comment",regex:".*:\\)",next:"start"},{token:"comment",regex:".+"}]}};e.inherits(c,d);b.XQueryHighlightRules=c});
define("eXide/mode/behaviour/xquery",function(a,b){var e=a("pilot/oop"),f=a("ace/mode/behaviour").Behaviour,d=a("ace/mode/behaviour/cstyle").CstyleBehaviour,c=function(c){this.inherit(d,["braces","parens","string_dquotes"]);this.parent=c;this.add("brackets","insertion",function(d,c,a,f,b){return b=="\n"&&(c=a.getCursorPosition(),f.doc.getLine(c.row).substring(c.column,c.column+2)=="</")?(d=this.$getIndent(f.doc.getLine(c.row))+f.getTabString(),f=this.$getIndent(f.doc.getLine(c.row)),{text:"\n"+d+
"\n"+f,selection:[1,d.length,1,d.length]}):!1});this.add("slash","insertion",function(d,a,f,b,e){e=="/"&&(d=f.getCursorPosition(),a=b.doc.getLine(d.row),d.column>0&&a.charAt(d.column-1)=="<"&&(a=a.substring(0,d.column)+"/"+a.substring(d.column),f=b.doc.getAllLines(),f[d.row]=a,c.exec("closeTag",f.join(b.doc.getNewLineCharacter()),d.row)));return!1})};e.inherits(c,f);b.XQueryBehaviour=c});
define("eXide/mode/xquery",function(a,b){var e=a("pilot/oop"),f=a("ace/mode/text").Mode,d=a("ace/tokenizer").Tokenizer,c=a("eXide/mode/xquery_highlight_rules").XQueryHighlightRules,g=a("eXide/mode/behaviour/xquery").XQueryBehaviour,h=a("ace/range").Range,i=function(a){this.$tokenizer=new d((new c).getRules());this.$behaviour=new g(a)};e.inherits(i,f);(function(){this.getNextLineIndent=function(d,c,a){d=this.$getIndent(c);c.match(/\s*(?:then|else|return|[{\(]|<\w+>)\s*$/)&&(d+=a);return d};this.checkOutdent=
function(d,c,a){return!/^\s+$/.test(c)?!1:/^\s*[\}\)]/.test(a)};this.autoOutdent=function(d,c,a){d=c.getLine(a).match(/^(\s*[\}\)])/);if(!d)return 0;var d=d[1].length,f=c.findMatchingBracket({row:a,column:d});if(!f||f.row==a)return 0;f=this.$getIndent(c.getLine(f.row));c.replace(new h(a,0,a,d-1),f)};this.$getIndent=function(d){return(d=d.match(/^(\s+)/))?d[1]:""}}).call(i.prototype);b.Mode=i});
define("eXide/mode/behaviour/xml",function(a,b){var e=a("pilot/oop"),f=a("ace/mode/behaviour").Behaviour,d=a("ace/mode/behaviour/cstyle").CstyleBehaviour;a("eXide/mode/behaviour/xquery");var c=function(c){this.inherit(d,["braces","parens","string_dquotes"]);this.parent=c;this.add("brackets","insertion",function(d,c,a,f,b){return b=="\n"&&(c=a.getCursorPosition(),f.doc.getLine(c.row).substring(c.column,c.column+2)=="</")?(d=this.$getIndent(f.doc.getLine(c.row))+f.getTabString(),f=this.$getIndent(f.doc.getLine(c.row)),
{text:"\n"+d+"\n"+f,selection:[1,d.length,1,d.length]}):!1});this.add("slash","insertion",function(d,a,f,b,e){e=="/"&&(d=f.getCursorPosition(),a=b.doc.getLine(d.row),d.column>0&&a.charAt(d.column-1)=="<"&&(a=a.substring(0,d.column)+"/"+a.substring(d.column),f=b.doc.getAllLines(),f[d.row]=a,c.exec("closeTag",f.join(b.doc.getNewLineCharacter()),d.row)));return!1})};e.inherits(c,f);b.XMLBehaviour=c});
define("eXide/mode/xml",function(a,b){var e=a("pilot/oop"),f=a("ace/mode/xml").Mode,d=a("ace/tokenizer").Tokenizer,c=a("ace/mode/xml_highlight_rules").XmlHighlightRules,g=a("eXide/mode/behaviour/xml").XMLBehaviour;a("ace/range");var h=function(a){this.$tokenizer=new d((new c).getRules());this.$behaviour=new g(a)};e.inherits(h,f);(function(){}).call(h.prototype);b.Mode=h});var eXide=eXide||{};eXide.namespace=function(a){var a=a.split("."),b=eXide,e;a[0]=="eXide"&&(a=a.slice(1));for(e=0;e<a.length;e++)typeof b[a[e]]=="undefined"&&(b[a[e]]={}),b=b[a[e]];return b};eXide.namespace("eXide.util");
eXide.util=function(){var a={dir1:"up",dir2:"left",firstpos1:15,firstpos2:15};return{popup:function(a,e,f,d){function c(d){h&&(h.empty(),d.find(".tooltip").each(function(){h.html($(this).html())}))}var g=$(a),h=e?$(e):null,i=null;f.sort(function(d,a){return d.label==a.label?0:d.label>a.label?1:-1});g.empty().css("display","block").focus();a=document.createElement("a");a.href="#";a.className="popup-close";a.appendChild(document.createTextNode("Close"));g.append(a);$(a).click(function(d){d.preventDefault();
g.css("display","none");h&&h.css("display","none")});a=document.createElement("ul");for(e=0;e<f.length;e++){var j=document.createElement("li");if(e==0)j.className="first";j.appendChild(document.createTextNode(f[e].label));if(f[e].tooltip){var k=document.createElement("span");k.className="tooltip";k.appendChild(document.createTextNode(f[e].tooltip));j.appendChild(k)}a.appendChild(j);$(j).click(function(){i.removeClass("selection");$(this).addClass("selection");i=$(this);c(i)});$(j).dblclick(function(){var a=
g.find("li").index(i);g.css("display","none");h&&h.css("display","none");d.call(null,f[a])})}g.append(a);i=g.find("ul li:first").addClass("selection");c(i);var l=$(a).css("position","absolute").scrollTop(0);h&&h.css({display:"block",top:l.offset().top+"px"});var m=l.innerHeight();$(g).keydown(function(a){a.preventDefault();if(a.which==40)a=i.next(),a.length>0&&(i.removeClass("selection"),a.addClass("selection"),i=a,a.position().top+a.height()>=m&&a.get(0).scrollIntoView(),c(a));else if(a.which==38)a=
i.prev(),a.length>0&&(i.removeClass("selection"),a.addClass("selection"),i=a,a.hasClass("first")?l.scrollTop(0):a.position().top<0&&a.get(0).scrollIntoView(),c(a));else if(a.which==13){var b=g.find("li").index(i);g.css("display","none");h&&h.css("display","none");$(g).unbind(a);d.call(null,f[b])}else return g.css("display","none"),h&&h.css("display","none"),$(g).unbind(a),d.call(null,null),!0;return!1})},supportsHtml5Storage:function(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return!1}},
normalizePath:function(a){for(var a=a.replace(/^xmldb:exist:\/\//,""),e=[],a=a.split("/"),f=a.length-1;f>-1;f--)a[f]==".."?f--:e.push(a[f]);return e.reverse().join("/")},parseSignature:function(a){var e=a.indexOf("(");if(e>-1){var f=a.substring(0,e+1),a=a.substring(e);if(a=a.match(/\$[\w:-_]+/g))for(e=0;e<a.length;e++)e>0&&(f+=", "),f+=a[e];f+=")";return f}return a},message:function(b){$.pnotify({pnotify_text:b,pnotify_shadow:!0,pnotify_hide:!0,pnotify_closer:!0,pnotify_opacity:0.75,pnotify_addclass:"stack-bottomright",
pnotify_stack:a})},error:function(b,e){var f={pnotify_text:b,pnotify_type:"error",pnotify_shadow:!0,pnotify_hide:!0,pnotify_addclass:"stack-bottomright",pnotify_stack:a};if(e)f.pnotify_title=e;$.pnotify(f)}}}();eXide.namespace("eXide.util.Dialog");
eXide.util.Dialog=function(){var a,b=null;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-message">\t<img id="eXide-dialog-message-icon" src="images/error.png"/>\t<div id="eXide-dialog-message-body"></div></div>');a=$("#eXide-dialog-message");a.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close")}}});$(document.body).append('<div id="eXide-dialog-input">\t<img id="eXide-dialog-input-icon" src="images/information.png"/>\t<div id="eXide-dialog-input-body"></div></div>');
inputDialog=$("#eXide-dialog-input");inputDialog.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close");b!=null&&b.apply($("eXide-dialog-input-body"),[])},Cancel:function(){$(this).dialog("close")}}})});return{message:function(b,f){f==null&&(f="");a.dialog("option","title",b);$("#eXide-dialog-message-body").html(f);$("#eXide-dialog-message-icon").attr("src","images/information.png");a.dialog("open")},warning:function(b,f){f==null&&(f="");a.dialog("option","title",b);$("#eXide-dialog-message-body").html(f);
$("#eXide-dialog-message-icon").attr("src","images/error.png");a.dialog("open")},input:function(a,f,d){b=d;inputDialog.dialog("option","title",a);$("#eXide-dialog-input-body").html(f);inputDialog.dialog("open")}}}();eXide.namespace("eXide.util.mimeTypes");
eXide.util.mimeTypes=function(){var a={xml:["text/xml","application/xml","application/xhtml+xml"],xquery:["application/xquery"],css:["text/css"],html:["text/html"],javascript:["application/x-javascript"]};return{getMime:function(a){var e=a.indexOf(";");e>-1&&(a=a.substring(0,e));return a},getLangFromMime:function(b){for(var e in a)for(var f=a[e],d=0;d<f.length;d++)if(b==f[d])return e;return"xquery"},getMimeFromLang:function(b){return(b=a[b])?b[0]:"application/xquery"}}}();eXide.namespace("eXide.util.oop");
eXide.util.oop.inherit=function(){var a=function(){};return function(b,e){a.prototype=e.prototype;b.prototype=new a;b.super_=e.prototype;b.prototype.constructor=b}}();(function(a){a.log=function(){window.console&&window.console.log&&console.log.apply(window.console,arguments)};a.fn.log=function(){a.log(this);return this}})(jQuery);eXide.namespace("eXide.edit.commands");
eXide.edit.commands=function(){function a(a,d){return{win:a,mac:d,sender:"editor"}}var b=require("pilot/canon"),e=require("pilot/useragent");return{init:function(f){b.addCommand({name:"saveDocument",bindKey:a("Ctrl-Shift-S","Command-Shift-S"),exec:function(){eXide.app.saveDocument()}});b.addCommand({name:"runQuery",bindKey:a("Ctrl-Return","Command-Return"),exec:function(){eXide.app.runQuery()}});b.addCommand({name:"openDocument",bindKey:a("Ctrl-Shift-O","Command-Shift-O"),exec:function(){eXide.app.openDocument()}});
b.addCommand({name:"newDocument",bindKey:a("Ctrl-Shift-N","Command-Shift-N"),exec:function(){eXide.app.newDocument()}});b.addCommand({name:"closeDocument",bindKey:a("Ctrl-Shift-W","Command-Shift-W"),exec:function(){eXide.app.closeDocument()}});b.addCommand({name:"autocomplete",bindKey:a("Ctrl-Space","Ctrl-Space"),exec:function(){f.autocomplete()}});b.addCommand({name:"nextTab",bindKey:a("Ctrl-Shift-PageDown","Command-Shift-PageDown"),exec:function(){f.nextTab()}});b.addCommand({name:"previousTab",
bindKey:a("Ctrl-Shift-PageUp","Command-Shift-PageUp"),exec:function(){f.previousTab()}});b.addCommand({name:"functionDoc",bindKey:a("F1","F1"),exec:function(){f.exec("showFunctionDoc")}});b.addCommand({name:"gotoDefinition",bindKey:a("F3","F3"),exec:function(){f.exec("gotoDefinition")}});b.addCommand({name:"indentOrParam",bindKey:a("Tab","Tab"),exec:function(d){var a=f.getActiveDocument();(!a.template||!a.template.nextParam())&&d.editor.indent()}});b.addCommand({name:"escape",bindKey:a("Esc","Esc"),
exec:function(d){f.getActiveDocument().template=null;d.editor.clearSelection()}});b.addCommand({name:"dbManager",bindKey:a("Ctrl-Shift-M","Command-Shift-M"),exec:function(){eXide.app.manage()}})},help:function(a){$(a).find("table").each(function(){this.innerHTML="";for(var d=b.getCommandNames(),a=0;a<d.length;a++){var f=b.getCommand(d[a]),h=document.createElement("tr"),i=document.createElement("td");i.appendChild(document.createTextNode(d[a]));h.appendChild(i);i=document.createElement("td");e.isMac?
i.appendChild(document.createTextNode(f.bindKey.mac)):i.appendChild(document.createTextNode(f.bindKey.win));h.appendChild(i);this.appendChild(h)}})}}}();eXide.namespace("eXide.edit.ModeHelper");eXide.edit.ModeHelper=function(){Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.commands={}};Constr.prototype={addCommand:function(a,b){if(!this.commands)this.commands={};this.commands[a]=b},exec:function(a,b,e){if(this.commands&&this.commands[a]){for(var b=[b],f=0;f<e.length;f++)b.push(e[f]);$.log("Calling command %s ...",a);this.commands[a].apply(this,b)}}};return Constr}();eXide.namespace("eXide.edit.XQueryModeHelper");
eXide.edit.XQueryModeHelper=function(){function a(a){var d;d=a.line?a["#text"]:a;var c=e.exec(d),g=-1;c?g=parseInt(c[1])-1:a.line&&(g=parseInt(a.line)-1);return{line:g,msg:d}}var b=/^[\$\w:\-_\.]+/;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("showFunctionDoc",this.showFunctionDoc);this.addCommand("gotoDefinition",this.gotoDefinition);this.addCommand("locate",this.locate);this.addCommand("closeTag",this.closeTag)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);
Constr.prototype.closeTag=function(f,d,c){var f="xmldb:exist://"+f.getBasePath(),g=this;$.ajax({type:"POST",url:"compile.xql",data:{q:d,base:f},dataType:"json",success:function(d){d.result=="fail"&&(d=a(d.error),d.line<=c&&(d=/constructor:\s(.*)$/.exec(d.msg),d.length>0&&g.editor.insert(d[1]+">")))},error:function(){}})};Constr.prototype.validate=function(a,d,c){$.log("Running validation...");var g=this,b="xmldb:exist://"+a.getBasePath();$.ajax({type:"POST",url:"compile.xql",data:{q:d,base:b},dataType:"json",
success:function(d){g.compileError(d,a);c.call(this,!0)},error:function(d,a){c.call(this,!0);$.log("Compile error: %s - %s",a,d.responseText)}})};Constr.prototype.compileError=function(f,d){if(f.result=="fail"){var c=a(f.error),b=[{row:c.line,text:c.msg,type:"error"}];this.parent.updateStatus(c.msg,d.getPath()+"#"+c.line);d.getSession().setAnnotations(b)}else this.parent.clearErrors(),this.parent.updateStatus("")};Constr.prototype.autocomplete=function(a){require("pilot/lang");for(var d=require("ace/range").Range,
c=this.editor.getSelection(),b=a.getSession(),c=c.getSelectionLead(),b=b.getDisplayLine(c.row),e=c.column-1,i=c.column;e>=0;){var j=b.substring(e,i);if(j.match(/^\$[\w:\-_\.]+$/))break;if(!j.match(/^[\w:\-_\.]+$/)){e++;break}e--}b=b.substring(e,i);$.log("completing token: %s",b);d=new d(c.row,e,c.row,i);c=this.editor.renderer.textToScreenCoordinates(c.row,c.column);e=this.parent.getHeight();if(c.pageY+150>e)c.pageY=e-150,$.log("window height: %i, pageY: %i",e,c.pageY);$("#autocomplete-box").css({left:c.pageX+
"px",top:c.pageY+10+"px"});$("#autocomplete-help").css({left:c.pageX+324+"px",top:c.pageY+10+"px"});b.length==0?this.templateLookup(a,b,d,!0):this.functionLookup(a,b,d,!0);return!0};Constr.prototype.$localVars=function(a,d){for(var c=[],b=/declare function|};/,e=/let \$[\w\:]+|for \$[\w\:]+|\$[\w\:]+\)/,i=/\$[\w\:]+/,j=RegExp("^\\"+a),k=this.editor.getSession(),l=d.start.row;l>-1;){var m=k.getDisplayLine(l),n;if(n=m.match(e))$.log("Var: %s",n[0]),n=n[0].match(i),n[0].match(j)&&c.push({name:n[0],type:"variable"});
if(m.match(b)){$.log("Stop: %s",m);break}l--}return c};Constr.prototype.functionLookup=function(a,d,c,b){var e=this;$.ajax({url:"docs.xql",dataType:"text",type:"POST",data:{prefix:d},success:function(i){var i=$.parseJSON(i),j=[],k;d.substring(0,1)=="$"?(k="^\\"+d,j=e.$localVars(d,c,b)):k="^"+d;var l=RegExp(k);$.each(a.functions,function(d,a){a.name.match(l)&&j.push(a)});i&&(j=j.concat(i));i=[];for(k=0;k<j.length;k++){var m={label:j[k].signature?j[k].signature:j[k].name,type:j[k].type};if(j[k].help)m.tooltip=
j[k].help;i.push(m)}e.$addTemplates(d,i);e.$showPopup(a,c,i)},error:function(d,a){eXide.util.error(a)}})};Constr.prototype.templateLookup=function(a,d,c){var b=[];this.$addTemplates(d,b);this.$showPopup(a,c,b)};Constr.prototype.$addTemplates=function(a,d){for(var c=this.parent.outline.getTemplates(a),b=0;b<c.length;b++)d.push({type:"template",label:"[S] "+c[b].name,tooltip:c[b].help,template:c[b].template})};Constr.prototype.$showPopup=function(a,d,c){var b=this;eXide.util.popup($("#autocomplete-box"),
$("#autocomplete-help"),c,function(c){if(c){var e=c.label;c.type=="template"?e=c.template:c.type=="function"&&(e=eXide.util.parseSignature(e));a.template=new eXide.edit.Template(b.parent,d,e,c.type);a.template.insert()}b.editor.focus()})};Constr.prototype.getFunctionAtCursor=function(a){var d=a.row,d=this.editor.getSession().getDisplayLine(d),c=a.column;do c--;while(c>=0&&d.charAt(c).match(b));c++;for(a=a.column;a<d.length&&d.charAt(a).match(b);)a++;return d.substring(c,a)};Constr.prototype.showFunctionDoc=
function(a){var d=this.editor.getSelection().getSelectionLead(),c=this.editor.renderer.textToScreenCoordinates(d.row,d.column);$("#autocomplete-box").css({left:c.pageX+"px",top:c.pageY+20+"px"});$("#autocomplete-help").css({left:c.pageX+324+"px",top:c.pageY+20+"px"});d=this.getFunctionAtCursor(d);this.functionLookup(a,d,null,!1)};Constr.prototype.gotoDefinition=function(a){var d=this.getFunctionAtCursor(this.editor.getSelection().getSelectionLead());d&&this.parent.outline.gotoDefinition(a,d)};Constr.prototype.locate=
function(a,d,c){switch(d){case "function":this.gotoFunction(a,c);break;default:this.gotoVarDecl(a,c)}};Constr.prototype.gotoFunction=function(a,d){$.log("Goto function %s",d);var c=this.getModuleNamespacePrefix();c!=null&&(d=d.replace(/[^:]+:/,c+":"));for(var c=RegExp("function\\s+"+d+"\\s*\\("),b=a.$session.getLength(),e=0;e<b;e++)if(a.$session.getLine(e).match(c)){this.editor.gotoLine(e+1);this.editor.focus();break}};Constr.prototype.gotoVarDecl=function(a,d){var c=this.getModuleNamespacePrefix();
c!=null&&(d=d.replace(/[^:]+:/,"$"+c+":"));$.log("Goto variable declaration %s",d);for(var c=RegExp("variable\\s+\\"+d),b=a.$session.getLength(),e=0;e<b;e++)if(a.$session.getLine(e).match(c)){this.editor.gotoLine(e+1);this.editor.focus();break}};Constr.prototype.getModuleNamespacePrefix=function(){for(var a=/^\s*module\s+namespace\s+([^=\s]+)\s*=/,d=this.parent.getActiveDocument().$session.getLength(),c=0;c<d;c++){var b=this.parent.getActiveDocument().$session.getLine(c).match(a);if(b)return b[1]}return null};
var e=/.*line:?\s(\d+)/i;return Constr}();eXide.namespace("eXide.edit.XMLModeHelper");
eXide.edit.XMLModeHelper=function(){Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("closeTag",this.closeTag)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.closeTag=function(a,b,e){a.getBasePath();var f=this;$.ajax({type:"POST",url:"validate-xml.xql",data:{xml:b},dataType:"json",success:function(a){a.status&&a.status=="invalid"&&parseInt(a.message.line)-1<=e&&(a=/element type \"([^\"]+)\"/.exec(a.message["#text"]),a.length>0&&f.editor.insert(a[1]+
">"))},error:function(){}})};Constr.prototype.validate=function(a,b,e){var f=this;$.ajax({type:"POST",url:"validate-xml.xql",data:{xml:b},dataType:"json",success:function(d){f.compileError(d,a);e.call(this,!0)},error:function(a,c){e.call(this,!0);$.log("Compile error: %s - %s",c,a.responseText)}})};Constr.prototype.compileError=function(a,b){$.log("Validation returned %o",a);if(a.status&&a.status=="invalid"){var e=[{row:parseInt(a.message.line)-1,text:a.message["#text"],type:"error"}];$.log("annotation: %o",
e);this.parent.updateStatus(a.message["#text"],b.getPath()+"#"+a.message.line);b.getSession().setAnnotations(e)}else this.parent.clearErrors(),this.parent.updateStatus("")};return Constr}();eXide.namespace("eXide.edit.Outline");
eXide.edit.Outline=function(){Constr=function(a){a.addEventListener("activate",this,this.updateOutline);a.addEventListener("validate",this,this.updateOutline);a.addEventListener("close",this,this.clearOutline);this.funcDefRe=/declare\s+function\s+([^\(]+)\(/g;this.varDefRe=/declare\s+variable\s+\$[^\s;]+/gm;this.varRe=/declare\s+variable\s+(\$[^\s;]+)/;this.parseImportRe=/import\s+module\s+namespace\s+[^=]+\s*=\s*["'][^"']+["']\s*at\s+["'][^"']+["']\s*;/g;this.moduleRe=/import\s+module\s+namespace\s+([^=\s]+)\s*=\s*["']([^"']+)["']\s*at\s+["']([^"']+)["']\s*;/;
this.currentDoc=null;this.templates=[];this.$loadTemplates()};Constr.prototype={getTemplates:function(a){for(var a=RegExp("^"+a),b=[],e=0;e<this.templates.length;e++)this.templates[e].name.match(a)&&b.push(this.templates[e]);return b},gotoDefinition:function(a,b){$.each(a.functions,function(a,f){b==f.name&&eXide.app.locate(f.type,f.source==""?null:f.source,b)})},updateOutline:function(a){this.currentDoc=a;a.functions=[];$("#outline").empty();if(a.getMime()=="application/xquery"){var b=a.getText();
this.$parseLocalFunctions(b,a);this.$outlineUpdate(a);(b=this.$parseImports(b))&&this.$resolveImports(a,b)}},clearOutline:function(){$("#outline").empty()},$parseLocalFunctions:function(a,b){for(b.functions=[];;){var e=this.funcDefRe.exec(a);if(e==null)break;var f=this.funcDefRe.lastIndex,d=this.$findMatchingParen(a,f);b.functions.push({type:"function",name:e[1],signature:e[1]+"("+a.substring(f,d)+")"})}if(e=a.match(this.varDefRe))for(f=0;f<e.length;f++)d=this.varRe.exec(e[f]),b.functions.push({type:"variable",
name:d[1]})},$findMatchingParen:function(a,b){for(var e=1,f=b;f<a.length;f++){var d=a.charAt(f);if(d==")"){if(e-=1,e==0)return f}else d=="("&&(e+=1)}return-1},$parseImports:function(a){return a.match(this.parseImportRe)},$resolveImports:function(a,b){for(var e=this,f=[],d=[],c=0;c<b.length;c++){var g=this.moduleRe.exec(b[c]);g!=null&&g.length==4&&(d.push("prefix="+encodeURIComponent(g[1])),d.push("uri="+encodeURIComponent(g[2])),d.push("source="+encodeURIComponent(g[3])))}c="xmldb:exist://"+a.getBasePath();
d.push("base="+encodeURIComponent(c));$.ajax({url:"outline",dataType:"json",type:"POST",data:d.join("&"),success:function(d){if(d!=null){for(var d=d.modules,c=0;c<d.length;c++){var b=d[c].functions;if(b)for(var g=0;g<b.length;g++)f.push({type:"function",name:b[g].name,signature:b[g].signature,source:d[c].source});if(b=d[c].variables)for(g=0;g<b.length;g++)f.push({type:"variable",name:"$"+b[g],source:d[c].source})}a.functions=a.functions.concat(f);e.$outlineUpdate(a)}}});return f},$sortFunctions:function(a){a.functions.sort(function(a,
e){return a.name==e.name?0:a.name>e.name?1:-1})},$outlineUpdate:function(a){this.$sortFunctions(a);if(this.currentDoc==a){$("body").layout().open("west");eXide.app.resize();var b=$("#outline");b.empty();for(var e=0;e<a.functions.length;e++){var f=a.functions[e],d=document.createElement("li"),c=document.createElement("a");if(f.signature)c.title=f.signature;c.className=f.type=="function"?"t_function":"t_variable";c.href=f.source?"#"+f.source:"#";c.appendChild(document.createTextNode(f.name));d.appendChild(c);
b.append(d);$(c).click(function(){var a=this.hash.substring(1);this.className=="t_function"?eXide.app.locate("function",a==""?null:a,$(this).text()):eXide.app.locate("variable",a==""?null:a,$(this).text());return!1})}}},$loadTemplates:function(){var a=this;$.ajax({url:"templates/snippets.xml",dataType:"xml",type:"GET",success:function(b){$(b).find("snippet").each(function(){var b=$(this),f=b.attr("abbrev"),d=b.find("description").text(),b=b.find("code").text();a.templates.push({TYPE:"template",name:f,
help:d,template:b})})}})}};return Constr}();eXide.namespace("eXide.edit.Document");
eXide.edit.Document=function(){Constr=function(a,b,e){this.name=a;this.path=b;this.mime="application/xquery";this.syntax="xquery";this.saved=!1;this.editable=!0;this.functions=[];this.helper=null;this.history=[];this.$session=e};Constr.prototype={getText:function(){return this.$session.getValue()},getName:function(){return this.name},getPath:function(){return this.path},getBasePath:function(){return this.path.replace(/(^.+)\/[^\/]*$/,"$1")},getMime:function(){return this.mime},getSyntax:function(){return this.syntax},
getSession:function(){return this.$session},isSaved:function(){return this.saved},isEditable:function(){return this.editable},isXQuery:function(){return this.mime=="application/xquery"},setModeHelper:function(a){this.helper=a},getModeHelper:function(){return this.helper},addToHistory:function(a){this.history.push(a)},getLastLine:function(){return this.history.pop(line)},getCurrentLine:function(){return this.$session.getSelection().getSelectionLead().row}};return Constr}();eXide.namespace("eXide.edit.Editor");
eXide.edit.Editor=function(){var a=require("ace/virtual_renderer").VirtualRenderer,b=require("ace/editor").Editor,e=require("ace/edit_session").EditSession,f=require("ace/undomanager").UndoManager;Constr=function(d){var c=this;c.container=d;c.documents=[];c.activeDoc=null;c.tabCounter=0;c.newDocCounter=0;c.pendingCheck=!1;c.events={activate:[],validate:[],close:[]};eXide.edit.commands.init(c);require("pilot/plugin_manager").catalog.registerPlugins(["pilot/index"]);d=new a(c.container,"ace/theme/eclipse");
d.setShowGutter(!0);this.editor=new b(d);this.editor.setBehavioursEnabled(!0);this.outline=new eXide.edit.Outline(this);this.status=document.getElementById("error-status");$(this.status).click(function(a){a.preventDefault();var d=this.pathname,a=this.hash.substring(1);if(d=c.getDocument(d))c.switchTo(d),c.editor.gotoLine(parseInt(a)+1)});this.lastChangeEvent=(new Date).getTime();this.validateTimeout=null;c.modes={xquery:new eXide.edit.XQueryModeHelper(c),xml:new eXide.edit.XMLModeHelper(c)}};Constr.prototype=
{init:function(){this.documents.length==0&&this.newDocument()},exec:function(){if(this.activeDoc.getModeHelper()){var a=Array.prototype.slice.call(arguments,1);this.activeDoc.getModeHelper().exec(arguments[0],this.activeDoc,a)}},getActiveDocument:function(){return this.activeDoc},getText:function(){return this.activeDoc.getText()},newDocument:function(){for(var a=0,c=0;c<this.documents.length;c++)this.documents[c].path.match(/^__new__(\d+)/)&&(a=parseInt(RegExp.$1));a++;this.$initDocument(new eXide.edit.Document("new-document "+
a,"__new__"+a,new e('xquery version "1.0";\n')))},newDocumentWithText:function(a,c,b){a=new eXide.edit.Document(b.name,b.path,new e(a));a.editable=b.writable;a.mime=c;a.syntax=eXide.util.mimeTypes.getLangFromMime(c);a.saved=!1;b.line&&(a.addToHistory(b.line),this.editor.gotoLine(b.line));this.$initDocument(a)},openDocument:function(a,c,b){b.writable?eXide.util.message("Opening "+b.path):eXide.util.message("Opening "+b.path+" readonly!");a=new eXide.edit.Document(b.name,b.path,new e(a));a.editable=
b.writable;a.mime=c;a.syntax=eXide.util.mimeTypes.getLangFromMime(c);a.saved=!0;b.line&&(a.addToHistory(b.line),c=a.$session.getSelection(),c.clearSelection(),c.moveCursorTo(b.line,1),a.$session.setScrollTopRow(b.line));$.log("opening %s, mime: %s, syntax: %s, line: %i",b.name,a.mime,a.syntax,b.line);this.$initDocument(a)},$initDocument:function(a){var c=this;c.$setMode(a);a.$session.setUndoManager(new f);a.$session.addEventListener("change",function(){if(a.saved)a.saved=!1,c.updateTabStatus(a.path,
a);c.triggerCheck()});c.addTab(a);c.editor.setSession(a.$session);c.editor.resize();c.editor.focus()},setMode:function(a){this.activeDoc.syntax=a;this.$setMode(this.activeDoc,!0)},$setMode:function(a,c){switch(a.getSyntax()){case "xquery":var b=require("eXide/mode/xquery").Mode;a.$session.setMode(new b(this));if(c)a.mime="application/xquery";break;case "xml":b=require("eXide/mode/xml").Mode;a.$session.setMode(new b(this));if(c)a.mime="application/xml";break;case "html":b=require("ace/mode/html").Mode;
a.$session.setMode(new b);if(c)a.mime="text/html";break;case "javascript":b=require("ace/mode/javascript").Mode;a.$session.setMode(new b);if(c)a.mime="application/x-javascript";break;case "css":if(b=require("ace/mode/css").Mode,a.$session.setMode(new b),c)a.mime="text/css"}a.setModeHelper(this.modes[a.getSyntax()])},closeDocument:function(){this.$triggerEvent("close",[this.activeDoc]);$("#tabs a[title="+this.activeDoc.path+"]").parent().remove();for(var a=0;a<this.documents.length;a++)this.documents[a].path==
this.activeDoc.path&&this.documents.splice(a,1);this.documents.length==0?this.newDocument():(this.activeDoc=this.documents[this.documents.length-1],$("#tabs a[title="+this.activeDoc.path+"]").addClass("active"),this.editor.setSession(this.activeDoc.$session),this.editor.resize(),this.$triggerEvent("activate",[this.activeDoc]))},saveDocument:function(a,c,b){var f=this,e=f.activeDoc.path,j=f.activeDoc.name;if(a)f.activeDoc.path=a.path,f.activeDoc.name=a.name;eXide.util.message("Storing resource "+f.activeDoc.name+
"...");a={path:f.activeDoc.path,data:f.activeDoc.getText()};if(f.activeDoc.mime)a.mime=f.activeDoc.mime;$.ajax({url:"store.xql",type:"POST",data:a,dataType:"json",success:function(a){a.status=="error"?b?b.apply(f.activeDoc,[a.message]):eXide.util.error(a.message):(f.activeDoc.saved=!0,f.updateTabStatus(e,f.activeDoc),c?c.apply(f.activeDoc):eXide.util.message(f.activeDoc.name+" stored."))},error:function(a){f.activeDoc.path=e;f.activeDoc.name=j;b?b.apply(f.activeDoc,a.responseText):eXide.util.error(a.responseText)}})},
getDocument:function(a){for(var a=eXide.util.normalizePath(a),c=0;c<this.documents.length;c++)if(this.documents[c].path==a)return this.documents[c]},onInput:function(a,c){var b=a.getModeHelper();if(b&&b.onInput)b.onInput(a,c)},autocomplete:function(){var a=this.activeDoc.getModeHelper();a&&a.autocomplete&&a.autocomplete(this.activeDoc)},getHeight:function(){return $(this.container).height()},resize:function(){this.editor.resize()},clearErrors:function(){this.editor.getSession().clearAnnotations()},
addTab:function(a){var c=this,b="t"+c.tabCounter++,f=a.name;a.saved||(f+="*");$("#tabs li a").removeClass("active");var e=document.createElement("li"),j=document.createElement("a");j.appendChild(document.createTextNode(f));j.className="tab active";j.id=b;j.title=a.path;e.appendChild(j);$("#tabs").append(e);$(j).click(function(b){b.preventDefault();c.switchTo(a)});c.activeDoc=a;c.documents.push(a);c.$triggerEvent("activate",[a])},nextTab:function(){if(!(this.documents.length<2)){for(var a=0,c=0;c<
this.documents.length;c++)if(this.documents[c]==this.activeDoc){a=c;break}a==this.documents.length-1?a=0:a++;this.switchTo(this.documents[a])}},previousTab:function(){if(!(this.documents.length<2)){for(var a=0,c=0;c<this.documents.length;c++)if(this.documents[c]==this.activeDoc){a=c;break}a==0?a=this.documents.length-1:a--;this.switchTo(this.documents[a])}},switchTo:function(a){this.editor.setSession(a.$session);this.editor.resize();this.activeDoc=a;$("#tabs a").each(function(){this.title==a.path?
$(this).addClass("active"):$(this).removeClass("active")});this.updateStatus("");this.$triggerEvent("activate",[a])},updateTabStatus:function(a,c){var b;b=c.saved?c.name:c.name+"*";$("#tabs a[title="+a+"]").attr("title",c.path).text(b)},setTheme:function(a){$.log("Changing theme to %s",a);this.editor.setTheme(a)},updateStatus:function(a,c){this.status.innerHTML=a;if(c)this.status.href=c},triggerCheck:function(){if(this.activeDoc.getModeHelper()){var a=this;if(!a.pendingCheck){var c=(new Date).getTime();
a.validateTimeout&&c-a.lastChangeEvent<2E3&&clearTimeout(a.validateTimeout);a.lastChangeEvent=c;a.validateTimeout=setTimeout(function(){a.validate.apply(a)},2E3)}}},validate:function(){var a=this,c=a.activeDoc.getModeHelper();if(c&&c.validate)a.pendingCheck=!0,$.log("Running validation..."),c.validate(a.activeDoc,a.getText(),function(){a.pendingCheck=!1}),a.$triggerEvent("validate",[a.activeDoc])},evalError:function(a){var c=/.*line\s(\d+)/i.exec(a),b=-1;c&&(b=parseInt(c[1]));$.log("error in line %d",
c[1]);this.editor.focus();this.editor.gotoLine(b);c=[{row:b-1,text:a,type:"error"}];this.status.innerHTML=a;this.editor.getSession().setAnnotations(c)},focus:function(){this.editor.focus()},saveState:function(){var a=0;$.each(this.documents,function(c,b){b.path.match("^__new__.*")?(localStorage["eXide."+a+".path"]=b.path,localStorage["eXide."+a+".name"]=b.name,localStorage["eXide."+a+".mime"]=b.mime,localStorage["eXide."+a+".data"]=b.getText(),localStorage["eXide."+a+".last-line"]=b.getCurrentLine()):
(localStorage["eXide."+a+".path"]=b.path,localStorage["eXide."+a+".name"]=b.name,localStorage["eXide."+a+".mime"]=b.mime,localStorage["eXide."+a+".writable"]=b.editable?"true":"false",localStorage["eXide."+a+".last-line"]=b.getCurrentLine(),b.saved||(localStorage["eXide."+a+".data"]=b.getText()));a++});localStorage["eXide.documents"]=a},addEventListener:function(a,c,b){(a=this.events[a])&&a.push({obj:c,callback:b})},$triggerEvent:function(a,b){var f=this.events[a];if(f)for(var e=0;e<f.length;e++)f[e].callback.apply(f[e].obj,
b)}};return Constr}();$(document).ready(function(){eXide.app.init();/^\?open=/.test(window.location.search)&&($.log("parameters: %s",window.location.search),eXide.app.findDocument(window.location.search.substring(6)))});eXide.namespace("eXide.app");
eXide.app=function(){var a,b,e,f=0,d=0,c=0,g=0,h={theme:"ace/theme/dawn",fontSize:"12px",showInvisibles:!1,showPrintMargin:!0,showHScroll:!1};return{init:function(){a=new eXide.edit.Editor(document.getElementById("editor"));b=new eXide.edit.PackageEditor(document.getElementById("deployment-editor"));e=new eXide.browse.Browser(document.getElementById("open-dialog"));eXide.app.initGUI();eXide.app.restoreState();a.init();a.addEventListener("outlineChange",eXide.app.onOutlineChange);eXide.app.resize();
$(window).resize(eXide.app.resize);$(window).unload(function(){eXide.app.saveState()})},resize:function(){$("#editor");$(".header");a.resize()},newDocument:function(){a.newDocument()},findDocument:function(b){var c=a.getDocument(b);c==null?(b={name:b.match(/[^\/]+$/),path:b},eXide.app.$doOpenDocument(b)):a.switchTo(c)},locate:function(b,c,d){if(c==null)a.exec("locate",b,d);else{$.log("Locating %s in document %s",d,c);var f=a.getDocument(c);f==null?(c={name:c.match(/[^\/]+$/),path:c},eXide.app.$doOpenDocument(c,
function(){a.exec("locate",b,d)})):(a.switchTo(f),a.exec("locate",b,d))}},openDocument:function(){e.reload(["reload"],!0);$("#open-dialog").dialog("option","title","Open Document");$("#open-dialog").dialog("option","buttons",{cancel:function(){$(this).dialog("close");a.focus()},open:eXide.app.openSelectedDocument});$("#open-dialog").dialog("open")},openSelectedDocument:function(a){var b=e.getSelection();b&&eXide.app.$doOpenDocument(b);(a==void 0||a)&&$("#open-dialog").dialog("close")},$doOpenDocument:function(b,
c){b.path=eXide.util.normalizePath(b.path);$.ajax({url:"load.xql?path="+b.path,dataType:"text",success:function(d,f,e){f=eXide.util.mimeTypes.getMime(e.getResponseHeader("Content-Type"));a.openDocument(d,f,b);c&&c.call(null,b)},error:function(a){eXide.util.error("Failed to load document "+b.path+": "+a.status+" "+a.statusText)}})},closeDocument:function(){a.getActiveDocument().isSaved()?a.closeDocument():$("#dialog-confirm-close").dialog({resizable:!1,height:140,modal:!0,buttons:{Close:function(){$(this).dialog("close");
a.closeDocument()},Cancel:function(){$(this).dialog("close")}}})},saveDocument:function(){a.getActiveDocument().getPath().match("^__new__")?(e.reload(["reload","create"],!0),$("#open-dialog").dialog("option","title","Save Document"),$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){a.saveDocument(e.getSelection(),function(){$("#open-dialog").dialog("close")},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}}),$("#open-dialog").dialog("open")):
a.saveDocument(null,function(){eXide.util.message(a.getActiveDocument().getName()+" stored.")},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})},download:function(){var b=a.getActiveDocument();b.getPath().match("^__new__")||!b.isSaved()?eXide.util.error("There are unsaved changes in the document. Please save it first."):window.location.href="load.xql?download=true&path="+encodeURIComponent(b.getPath())},runQuery:function(){a.updateStatus("Running query ...");var b=a.getText(),
e="xmldb:exist://"+a.getActiveDocument().getBasePath();$("#results-container .results").empty();$.ajax({type:"POST",url:"execute",dataType:"xml",data:{qu:b,base:e},success:function(b){b=b.documentElement;if(b.nodeName=="error")b=$(b).text(),eXide.util.error(b,"Compilation Error"),a.evalError(b);else{a.updateStatus("");a.clearErrors();var e=$("body").layout();e.open("south");e.sizePane("south",300);eXide.app.resize();c=d=1;f=b.getAttribute("hits");g=d+10-1;f<g&&(g=f);eXide.util.message("Found "+f+
" in "+b.getAttribute("elapsed"));eXide.app.retrieveNext()}},error:function(a){eXide.util.error(a.responseText,"Server Error")}})},checkQuery:function(){a.validate()},retrieveNext:function(){$.log("retrieveNext: %d",c);if(c>0&&c<=g){var a="results/"+c;c++;$.ajax({url:a,dataType:"html",success:function(a){$("#results-container .results").append(a);$("#results-container .current").text("Showing results "+d+" to "+(c-1)+" of "+f);$("#results-container .pos:last a").click(function(){eXide.app.findDocument(this.pathname);
return!1});eXide.app.retrieveNext()}})}},browseNext:function(){c>0&&g<f&&(d=c,g=c+10-1,f<g&&(g=f),$("#results-container .results").empty(),eXide.app.retrieveNext());return!1},browsePrevious:function(){c>0&&d>1&&(d-=10,d<1&&(d=1),c=d,g=c+9,f<g&&(g=f),$("#results-container .results").empty(),eXide.app.retrieveNext());return!1},manage:function(){eXide.app.$checkLogin()&&(e.reload(["reload","create","upload","open"],!1),$("#open-dialog").dialog("option","title","DB Manager"),$("#open-dialog").dialog("option",
"buttons",{Close:function(){$(this).dialog("close")}}),$("#open-dialog").dialog("open"))},deploymentSettings:function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());c&&eXide.app.$checkLogin()&&($.log("Editing deployment settings for collection: %s",c[1]),b.open(c[1]))},newDeployment:function(){eXide.app.$checkLogin()&&b.open()},deploy:function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());if(!c)return eXide.util.error("The file open in the editor does not belong to an application package!"),
!1;eXide.app.$checkLogin();$.log("Deploying application from collection: %s",c[1]);b.deploy(c[1]);return!1},synchronize:function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());c&&b.synchronize(c[1])},openApp:function(){var c=/^(.*)\/[^\/]+$/.exec(a.getActiveDocument().getPath());c&&b.runApp(c[1])},preferences:function(){var a=$("#preferences-dialog form");$("select[name=theme]",a).val(h.theme);$("select[name=font-size]",a).val(h.fontSize);$("input[name=show-invisibles]",a).attr("checked",
h.showInvisibles);$("input[name=print-margin]",a).attr("checked",h.showPrintMargin);$("#preferences-dialog").dialog("open")},applyPreferences:function(){$.log("preferences: %o",h);a.setTheme(h.theme);a.editor.setShowInvisibles(h.showInvisibles);a.editor.renderer.setShowPrintMargin(h.showPrintMargin);$("#editor").css("font-size",h.fontSize);a.resize()},restoreState:function(){if(!eXide.util.supportsHtml5Storage)return!1;for(conf in h){var c="eXide.preferences."+conf;localStorage[c]&&(h[conf]=localStorage[c]==
"true"?!0:localStorage[c]=="false"?!1:localStorage[c])}eXide.app.applyPreferences();(c=localStorage["eXide.documents"])||(c=0);for(var d=0;d<c;d++){var f={path:localStorage["eXide."+d+".path"],name:localStorage["eXide."+d+".name"],writable:localStorage["eXide."+d+".writable"]=="true",line:parseInt(localStorage["eXide."+d+".last-line"])};$.log("doc.line = %i",f.line);var e=localStorage["eXide."+d+".data"];e?a.newDocumentWithText(e,localStorage["eXide."+d+".mime"],f):eXide.app.$doOpenDocument(f)}b.restoreState();
return!0},saveState:function(){if(eXide.util.supportsHtml5Storage){localStorage.clear();for(conf in h)localStorage["eXide.preferences."+conf]=h[conf];a.saveState();b.saveState()}},ping:function(){$.ajax({url:"index.html",type:"HEAD",success:function(){setTimeout(function(){eXide.app.ping()},3E4)},error:function(a,b){$.log("ping failed: %s",b);eXide.app.login=null;$("#user").empty();$("#login").text("Login")}})},$checkLogin:function(){if(eXide.app.login)return!0;eXide.util.error("Warning: you are not logged in.");
return!1},initGUI:function(){$("body").layout({enableCursorHotkey:!1,north__size:78,north__resizable:!1,north__closable:!1,north__spacing_open:0,south__minSize:200,south__initClosed:!0,west__size:200,west__initClosed:!0,west__contentSelector:".content",center__minSize:300,center__onresize:eXide.app.resize,center__contentSelector:".content"});$(".menu ul li").hover(function(){$("ul",this).slideDown(200)},function(){$("ul",this).slideUp(200)});$("#open-dialog").dialog({title:"Open File",modal:!1,autoOpen:!1,
height:480,width:700,open:function(){e.init()},resize:function(){e.resize()}});$("#preferences-dialog").dialog({title:"Preferences",modal:!0,autoOpen:!1,height:400,width:600,buttons:{Cancel:function(){$(this).dialog("close");a.focus()},Save:function(){var b=$("form",this);h.theme=$("select[name=theme]",b).val();h.fontSize=$("select[name=font-size]",b).val();h.showInvisibles=$("input[name=show-invisibles]",b).is(":checked");h.showPrintMargin=$("input[name=print-margin]",b).is(":checked");eXide.app.applyPreferences();
$(this).dialog("close");a.focus()}}});$("#login-dialog").dialog({title:"Login",modal:!0,autoOpen:!1,buttons:{Login:function(){$.ajax({url:"login",data:$("#login-form").serialize(),success:function(){eXide.app.login=$("#login-form input[name=user]").val();$.log("Logged in as %s",eXide.app.login);$("#login-dialog").dialog("close");$("#user").text("Logged in as "+eXide.app.login+". ");$("#login").text("Logout");setTimeout(function(){eXide.app.ping()},3E4);a.focus()},error:function(){$("#login-error").text("Login failed. Bad username or password.");
$("#login-dialog input:first").focus()}})},Cancel:function(){$(this).dialog("close");a.focus()}},open:function(){$(this).find("input").val("");$(this).find("input:first").focus();$("#login-error").empty();var a=$(this);a.find("input").keyup(function(b){b.keyCode==13&&a.parent().find(".ui-dialog-buttonpane button:first").trigger("click")})}});$("#keyboard-help").dialog({title:"Keyboard Shortcuts",modal:!1,autoOpen:!1,height:400,buttons:{Close:function(){$(this).dialog("close")}},open:function(){eXide.edit.commands.help($("#keyboard-help"))}});
$("#help-shortcuts").click(function(a){a.preventDefault();$("#keyboard-help").dialog("open")});var b=$("#open").button({icons:{primary:"ui-icon-folder-open"}});b.click(eXide.app.openDocument);$("#menu-file-open").click(eXide.app.openDocument);b=$("#close").button({icons:{primary:"ui-icon-close"}});b.click(eXide.app.closeDocument);$("#menu-file-close").click(eXide.app.closeDocument);b=$("#new").button({icons:{primary:"ui-icon-document"}});b.click(eXide.app.newDocument);$("#menu-file-new").click(eXide.app.newDocument);
b=$("#run").button({icons:{primary:"ui-icon-play"}});b.click(eXide.app.runQuery);b=$("#validate").button({icons:{primary:"ui-icon-check"}});b.click(eXide.app.checkQuery);b=$("#save").button({icons:{primary:"ui-icon-disk"}});b.click(eXide.app.saveDocument);$("#menu-file-save").click(eXide.app.saveDocument);b=$("#download").button({icons:{primary:"ui-icon-transferthick-e-w"}});b.click(eXide.app.download);$("#menu-file-download").click(eXide.app.download);$("#menu-file-manager").click(eXide.app.manage);
$("#menu-deploy-new").click(eXide.app.newDeployment);$("#menu-deploy-edit").click(eXide.app.deploymentSettings);$("#menu-deploy-deploy").click(eXide.app.deploy);$("#menu-deploy-sync").click(eXide.app.synchronize);$("#menu-edit-undo").click(function(b){b.preventDefault();a.editor.undo()});$("#menu-edit-redo").click(function(b){b.preventDefault();a.editor.redo()});$("#menu-edit-preferences").click(eXide.app.preferences);$("#menu-deploy-run").click(eXide.app.openApp);$("#syntax").change(function(){a.setMode($(this).val())});
a.addEventListener("activate",null,function(a){$("#syntax").val(a.getSyntax())});$("#login").click(function(a){a.preventDefault();eXide.app.login?($.get("logout"),$("#user").empty(),$("#login").text("Login"),eXide.app.login=null):$("#login-dialog").dialog("open")});$("#results-container .next").click(eXide.app.browseNext);$("#results-container .previous").click(eXide.app.browsePrevious)}}}();eXide.namespace("eXide.edit.PackageEditor");
eXide.edit.PackageEditor=function(){Constr=function(){var a=this;this.directory=null;this.container=$("#sandbox_dialog_deploy");if(this.container.length==0){var b=document.createElement("div");b.id="sandbox_dialog_deploy";document.body.appendChild(b);this.container=$(b)}this.container.dialog({title:"Deployment Editor",modal:!0,autoOpen:!1,width:520,height:600});this.syncDialog=$("#synchronize-dialog");this.syncDialog.dialog({title:"Synchronize to Directory",modal:!0,autoOpen:!1,width:500,height:400,
buttons:{Synchronize:function(){var b=a.syncDialog.find("input[name=dir]").val();!b||b.length==0?$("#synchronize-report").text("No output directory specified!"):($("#synchronize-report").text("Synchronization in progress ..."),$("#synchronize-report").load("synchronize.xql",{collection:a.collection,start:a.syncDialog.find("input[name=date]").val(),dir:b}),this.directory=b)},Close:function(){$(this).dialog("close")}}});this.directory&&this.syncDialog.find("input[name=dir]").val(this.directory)};Constr.prototype=
{open:function(a){var b=this,e=null;a&&(e={collection:a});$.ajax({url:"deployment.xql",type:"POST",data:e,success:function(a){b.container.html(a);b.container.form({done:function(){var a=b.container.find("form").serialize();$.ajax({url:"deployment.xql",type:"POST",data:a,success:function(){b.container.dialog("close")},error:function(a){eXide.util.error(a.responseText)}})},cancel:function(){b.container.dialog("close")}});b.container.find(".author-repeat").repeat("#author-add-trigger",{deleteTrigger:"#author-remove-trigger"});
b.container.dialog("open")},error:function(a){eXide.util.error(a.responseText)}})},deploy:function(a){$.ajax({url:"deployment.xql",type:"POST",dataType:"json",data:{collection:a,deploy:"true"},success:function(a){a=location.protocol+"//"+location.hostname+":"+location.port+"/exist/apps/"+a+"/";eXide.util.Dialog.message("Application Deployed",'<p>The application has been deployed. On a standard installation the following link should open it:</p><center><a href="'+a+'" target="_new">'+a+"</a></center>")},
error:function(a){a.status==404?eXide.util.error("Deployment failed. The document currently opened in the editor should belong to an application package."):eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>")}})},synchronize:function(a){var b=this;$.getJSON("deployment.xql",{info:a},function(a){a?a.isAdmin?(b.collection=a.root,b.syncDialog.find("input[name=date]").val(a.deployed),b.syncDialog.dialog("open")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature."):
eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})},runApp:function(a){$.getJSON("deployment.xql",{info:a},function(a){a?(a="/exist/apps/"+a.root.replace(/^\/db\//,"")+"/",eXide.util.Dialog.message("Run Application",'<p>Click on the following link to open your application:</p><center><a href="'+a+'" target="_new">'+a+"</a></center>")):eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})},
saveState:function(){localStorage["eXide.synchronize.dir"]=this.directory},restoreState:function(){this.directory=localStorage["eXide.synchronize.dir"]}};return Constr}();eXide.namespace("eXide.edit.Template");
eXide.edit.Template=function(){var a=/\n/;Constr=function(b,e,f,d){var c=f.split(a).length;this.code=f;this.editor=b.editor;this.range=e;this.type=d;this.startLine=e.start.row;this.endLine=this.startLine+c-1;$.log("startLine = %i, endLine = %i",this.startLine,this.endLine);this.currentLine=this.startLine;this.lineOffset=this.startColumn=e.start.column;this.regex=/\$[\w\-:_]+/g;if(this.startColumn>0)this.regex.lastIndex=this.startColumn};Constr.prototype={insert:function(){this.editor.getSession().remove(this.range);this.editor.insert(this.code);
var a=this.editor.getSelection().getSelectionLead();this.code.substring(0,1)!="$"&&a.column>0&&this.editor.navigateLeft();this.type!="variable"&&this.nextParam();this.editor.focus()},nextParam:function(){var a=this.editor.getSession(),e=this.editor.getSelection(),f=e.getSelectionLead();$.log("lead.row = %i startLine = %i",f.row,this.startLine);if(f.row<this.startLine||f.row>this.endLine)return!1;for(var d=f=!1;this.currentLine<=this.endLine;){var c=a.getDisplayLine(this.currentLine);$.log("Checking line %s",
c);if(c=this.regex.exec(c)){$.log("Matched %s",c[0]);e.setSelectionAnchor(this.currentLine,c.index);e.selectTo(this.currentLine,c.index+c[0].length);this.lineOffset=c.index;d=!0;break}else this.lineOffset=0,this.currentLine++;if(this.currentLine>this.endLine&&!f){$.log("loop %i",this.startColumn);this.currentLine=this.startLine;if(this.startColumn>0)this.lineOffset=this.startColumn,this.regex.lastIndex=this.lineOffset;f=!0}}return d}};return Constr}();eXide.namespace("eXide.browse.CollectionBrowser");
eXide.browse.CollectionBrowser=function(){Constr=function(a){var b=this;this.events={activate:[]};this.selected=null;var e=document.createElement("div");e.className="eXide-browse-collections eXide-browse-content";a.append(e);this.container=$(e);this.container.dynatree({persist:!1,rootVisible:!1,initAjax:{url:"collections.xql"},clickFolderMode:1,autoFocus:!1,keyboard:!1,onActivate:function(a){var d=a.data.key;$.log("activate %s: is writable: %s",d,a.data.writable);b.selected=d;b.$triggerEvent("activate",
[d,a.data.writable])},onPostInit:function(){var a=null;b.selected&&(a=this.getNodeByKey(b.selected));a==null&&(a=this.getNodeByKey("/db"));a.activate();a.expand(!0)}})};Constr.prototype={getSelection:function(){return this.selected},reload:function(){$.log("Reloading tree...");this.container.dynatree("getTree").reload()},createCollection:function(){var a=this;eXide.app.$checkLogin()&&eXide.util.Dialog.input("Create Collection",'<label for="collection">Name: </label><input type="text" name="collection" id="eXide-browse-collection-name"/>',
function(){$.getJSON("collections.xql",{create:$("#eXide-browse-collection-name").val(),collection:a.selected},function(b){b.status=="fail"?eXide.util.Dialog.warning("Create Collection Error",b.message):a.reload()})})},deleteCollection:function(){var a=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete collection "+a.selected+"?",function(){$.getJSON("collections.xql",{remove:a.selected},function(b){$.log(b.status);b.status=="fail"?eXide.util.Dialog.warning("Delete Collection Error",
b.message):a.reload()})})},addEventListener:function(a,b,e){(a=this.events[a])&&a.push({obj:b,callback:e})},$triggerEvent:function(a,b){var e=this.events[a];if(e)for(var f=0;f<e.length;f++)e[f].callback.apply(e[f].obj,b)}};return Constr}();eXide.namespace("eXide.browse.ResourceBrowser");
eXide.browse.ResourceBrowser=function(){var a=[{id:"name",name:"Name",field:"name",width:120,formatter:function(a,b,c,e,h){return h.isCollection?'<span class="collection"><img src="images/folder_add.png"/> '+c+"</span>":c}},{id:"permissions",name:"Permissions",field:"permissions",width:80},{id:"owner",name:"Owner",field:"owner",width:70},{id:"group",name:"Group",field:"group",width:70},{id:"lastMod",name:"Last Modified",field:"last-modified",width:115}],b={editable:!1,multiSelect:!1},e={editable:!1,
multiSelect:!0};Constr=function(b){var d=this;this.container=$(b);this.events={activate:[],activateCollection:[],activateParent:[]};this.collection=null;this.data=[];this.grid=new Slick.Grid(this.container,this.data,a,e);var c=new Slick.RowSelectionModel({selectActiveRow:!0});this.grid.setSelectionModel(c);c.onSelectedRangesChanged.subscribe(function(){for(var a=c.getSelectedRows(),b=!0,f=0;f<a.length;f++)if(!d.data[a[f]].writable){b=!1;break}d.$triggerEvent("activate",[a.length==1&&!d.data[a[0]].isCollection?
d.data[a[0]]:null,b])});this.grid.onDblClick.subscribe(function(a){a=d.grid.getCellFromEvent(a);d.data[a.row].isCollection&&d.$triggerEvent("activateCollection",[d.collection+"/"+d.data[a.row].name])});this.grid.onKeyDown.subscribe(function(a){if(!a.shiftKey&&!a.altKey&&!a.ctrlKey)if(a.which==13)a.stopPropagation(),a.preventDefault(),a=c.getSelectedRows(),a.length==1&&(d.data[a[0]].isCollection?d.$triggerEvent("activateCollection",[d.collection+"/"+d.data[a[0]].name]):eXide.app.openSelectedDocument());
else if(a.which==8){var b=d.collection.lastIndexOf("/");b>0&&(a.stopPropagation(),a.preventDefault(),d.collection!="/db"&&(a=d.collection.substring(0,b),d.$triggerEvent("activateCollection",[a])))}});this.grid.onViewportChanged.subscribe(function(){var a=d.grid.getViewport();d.load(a.top,a.bottom)})};Constr.prototype={setMode:function(a){a=="manage"?this.grid.setOptions(e):this.grid.setOptions(b)},resize:function(){this.grid.resizeCanvas();this.container.find(".grid-canvas").focus()},update:function(a){$.log("Opening collection %s",
a);this.collection=a;this.grid.invalidate();this.data.length=0;this.grid.getSelectionModel().setSelectedRanges([]);this.grid.onViewportChanged.notify()},load:function(a,b){var c=this;$.getJSON("collections.xql",{root:this.collection,view:"r",start:a,end:b},function(e){for(var h=a;h<=b;h++)c.grid.invalidateRow(h);if(e&&e.items){c.data.length=e.total;for(h=0;h<e.items.length;h++)c.data[a+h]=e.items[h]}else c.data.length=0;c.grid.updateRowCount();c.grid.render();a==0&&(c.grid.setActiveCell(0,0),c.grid.setSelectedRows([0]),
c.container.find(".grid-canvas").focus())})},hasSelection:function(){var a=this.grid.getSelectionModel().getSelectedRows();return a&&a.length>0},deleteResource:function(){var a=this.grid.getSelectionModel().getSelectedRows();if(a.length!=0){for(var b=[],c=0;c<a.length;c++)b.push(this.data[a[c]].name);var e=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete the selected resources?",function(){$.log("Deleting resources %o",b);$.getJSON("collections.xql",{remove:b,root:e.collection},
function(a){$.log(a.status);a.status=="fail"?eXide.util.Dialog.warning("Delete Resource Error",a.message):e.reload()})})}},reload:function(){this.update(this.collection)},addEventListener:function(a,b,c){(a=this.events[a])&&a.push({obj:b,callback:c})},$triggerEvent:function(a,b){var c=this.events[a];if(c)for(var e=0;e<c.length;e++)c[e].callback.apply(c[e].obj,b)}};return Constr}();eXide.namespace("eXide.browse.Upload");
eXide.browse.Upload=function(){Constr=function(a){this.container=a;this.events={done:[]};$("#file_upload").fileUploadUI({sequentialUploads:!0,uploadTable:$("#files"),buildUploadRow:function(a,b){return $("<tr><td>"+a[b].name+'</td><td class="file_upload_progress"><div></div></td><td class="file_upload_cancel"><button class="ui-state-default ui-corner-all" title="Cancel"><span class="ui-icon ui-icon-cancel">Cancel</span></button></td></tr>')},buildDownloadRow:function(a){return a.error?$("<tr><td>"+
a.name+"</td><td>"+a.error+"</td></tr>"):null}});var b=this;$("#eXide-browse-upload-done").button().click(function(){$("#files").empty();b.$triggerEvent("done",[])})};Constr.prototype={update:function(a){$("input[name=collection]",this.container).val(a)},addEventListener:function(a,b,e){(a=this.events[a])&&a.push({obj:b,callback:e})},$triggerEvent:function(a,b){var e=this.events[a];if(e)for(var f=0;f<e.length;f++)e[f].callback.apply(e[f].obj,b)}};return Constr}();eXide.namespace("eXide.browse.Browser");
eXide.browse.Browser=function(){Constr=function(a){var b=this,e=$(".eXide-browse-toolbar",a),f=document.createElement("button");f.title="Reload";f.id="eXide-browse-toolbar-reload";f.tabindex=1;var d=document.createElement("img");d.src="images/arrow_refresh.png";f.appendChild(d);$(f).click(function(){b.collections.reload()});e.append(f);this.btnDeleteCollection=document.createElement("button");this.btnDeleteCollection.title="Delete Collection";this.btnDeleteCollection.id="eXide-browse-toolbar-delete-collection";
this.btnDeleteCollection.tabindex=2;d=document.createElement("img");d.src="images/folder_delete.png";this.btnDeleteCollection.appendChild(d);$(this.btnDeleteCollection).click(function(a){a.preventDefault();b.collections.deleteCollection()});e.append(this.btnDeleteCollection);this.btnCreateCollection=document.createElement("button");this.btnCreateCollection.title="Create Collection";this.btnCreateCollection.id="eXide-browse-toolbar-create";this.btnCreateCollection.tabindex=3;d=document.createElement("img");
d.src="images/folder_add.png";this.btnCreateCollection.appendChild(d);$(this.btnCreateCollection).click(function(a){a.preventDefault();b.collections.createCollection()});e.append(this.btnCreateCollection);this.btnUpload=document.createElement("button");this.btnUpload.title="Upload Files";this.btnUpload.id="eXide-browse-toolbar-upload";this.btnUpload.tabindex=4;d=document.createElement("img");d.src="images/database_add.png";this.btnUpload.appendChild(d);$(this.btnUpload).click(function(b){b.preventDefault();
$(".eXide-browse-resources",a).hide();$(".eXide-browse-upload",a).show()});e.append(this.btnUpload);this.btnDeleteResource=document.createElement("button");this.btnDeleteResource.title="Delete Resource";this.btnDeleteResource.id="eXide-browse-toolbar-delete-resource";d=document.createElement("img");d.src="images/page_delete.png";this.btnDeleteResource.appendChild(d);$(this.btnDeleteResource).click(function(a){a.preventDefault();b.resources.deleteResource()});e.append(this.btnDeleteResource);f=document.createElement("button");
f.title="Open Selected";f.id="eXide-browse-toolbar-open";f.tabindex=5;d=document.createElement("img");d.src="images/page_edit.png";f.appendChild(d);$(f).click(function(a){a.preventDefault();eXide.app.openSelectedDocument(!1)});e.append(f);this.selection=$(".eXide-browse-form input",a);this.container=a;this.resources=new eXide.browse.ResourceBrowser($(".eXide-browse-resources",a));this.collections=new eXide.browse.CollectionBrowser($(".eXide-browse-collections",a));this.upload=new eXide.browse.Upload($(".eXide-browse-upload",
a).hide());this.layout=null;this.collections.addEventListener("activate",this,this.onActivateCollection);this.collections.addEventListener("activate",this.resources,this.resources.update);this.collections.addEventListener("activate",this.upload,this.upload.update);this.resources.addEventListener("activate",this,this.onActivateResource);this.resources.addEventListener("activateCollection",this,this.onChangeCollection);this.upload.addEventListener("done",this,function(){$(".eXide-browse-resources",
a).show();$(".eXide-browse-upload",a).hide();this.reload()})};Constr.prototype={init:function(){var a=$(this.container).innerHeight()-$(".eXide-browse-form",this.container).height()-25;$(".eXide-browse-panel",this.container).height(a);if(this.layout==null)this.layout=$(".eXide-browse-panel",this.container).layout({enableCursorHotkey:!1,north__resizable:!1,north__closable:!1,north__spacing_open:0,south__resizable:!1,west__size:200,west__initClosed:!1,west__contentSelector:".eXide-browse-content",center__minSize:300,
center__contentSelector:".eXide-browse-content",onresize:function(){this.resources.resize()}}),this.resources.resize()},reload:function(a,b){if(a){$(".eXide-browse-toolbar button",this.container).hide();for(var e=0;e<a.length;e++)$("#eXide-browse-toolbar-"+a[e]).show()}b?($(".eXide-browse-form",this.container).show(),this.resources.setMode("open")):($(".eXide-browse-form",this.container).hide(),this.resources.setMode("manage"));this.layout!=null&&(this.resize(),this.collections.reload(),this.resources.update(this.collections.getSelection()),
$(this.selection).val(""))},resize:function(){var a=$(this.container).innerHeight()-$(".eXide-browse-form",this.container).height()-25;$(".eXide-browse-panel",this.container).height(a);this.layout.resizeAll()},getSelection:function(){var a=$(this.selection).val();return a==null||a==""?null:{name:a,path:this.collections.getSelection()+"/"+a,writable:!0}},onActivateResource:function(a,b){a?$(this.selection).val(a.name):$(this.selection).val("");b?$(this.btnDeleteCollection).css("display",""):$(this.btnDeleteCollection).css("display",
"none")},onActivateCollection:function(a,b){b?($(this.btnCreateCollection).css("display",""),$(this.btnUpload).css("display",""),$(this.btnDeleteCollection).css("display",""),$(this.btnDeleteResource).css("display","")):($(this.btnCreateCollection).css("display","none"),$(this.btnUpload).css("display","none"),$(this.btnDeleteCollection).css("display","none"),$(this.btnDeleteResource).css("display","none"));this.resources.update(a,b);this.upload.update(a,b)},onChangeCollection:function(a){this.collections.selected=
a;this.collections.reload();this.resources.update(this.collections.getSelection())}};return Constr}();
<?xml version="1.0" encoding="UTF-8"?>
<TestSet>
    <testName>Lucene indexing tests</testName>
    <description>
        <p>Tests for the Lucene extensions</p>
        <author>Wolfgang Meier</author>
    </description>
    <setup>
		<create-collection parent="/db/system" name="config"/>
		<create-collection parent="/db/system/config" name="db"/>
		<store collection="/db/system/config/db" name="collection.xconf">
			<collection xmlns="http://exist-db.org/collection-config/1.0">
				<index>
					<!-- Disable the standard full text index -->
					<fulltext default="none" attributes="false">
					</fulltext>
					<!-- Lucene index is configured below -->
					<lucene>
						<analyzer class="org.apache.lucene.analysis.standard.StandardAnalyzer"/>
						<text qname="p"/>
					</lucene>
				</index>
			</collection>
		</store>
        <create-collection parent="/db" name="test"/>
        <store collection="/db/test" name="text1.xml">
			<test>
				<p>Eins zwei drei vier zwei fünf sechs.</p>
				<p>Sieben acht <b>neun</b> zehn acht.</p>
			</test>
		</store>
    </setup>
    <tearDown>
        <remove-collection collection="/db/test"/>
    	<remove-document collection="/db/system/config/db" name="collection.xconf"/>
    </tearDown>
	<!-- Following axis tests -->
    <test output="xml">
        <task>Phrase highlighting 1</task>
        <code>
			for $hit in doc("/db/test/text1.xml")//p[ft:query(., '"zwei drei"')]
			return
				util:expand($hit)
		</code>
        <expected>
			<p>Eins <exist:match xmlns:exist="http://exist.sourceforge.net/NS/exist">zwei drei</exist:match> vier zwei fünf sechs.</p>
		</expected>
    </test>
    <test output="xml">
        <task>Phrase highlighting 2</task>
        <code>
			for $hit in doc("/db/test/text1.xml")//p[ft:query(., '"eins zwei"')]
			return
				util:expand($hit)
		</code>
        <expected>
			<p><exist:match xmlns:exist="http://exist.sourceforge.net/NS/exist">Eins zwei</exist:match> drei vier zwei fünf sechs.</p>
		</expected>
    </test>
	<test output="xml">
		<task>Phrase highlighting 3</task>
		<code>
			for $hit in doc("/db/test/text1.xml")//p[ft:query(., '"zwei fünf"')]
			return
			util:expand($hit)
		</code>
		<expected>
			<p>Eins zwei drei vier <exist:match xmlns:exist="http://exist.sourceforge.net/NS/exist">zwei fünf</exist:match> sechs.</p>
		</expected>
	</test>
	<test output="xml">
		<task>Phrase highlighting 4</task>
		<code>
			for $hit in doc("/db/test/text1.xml")//p[ft:query(., '"eins zwei"')]
			return
			util:expand($hit)
		</code>
		<expected>
			<p><exist:match xmlns:exist="http://exist.sourceforge.net/NS/exist">Eins zwei</exist:match> drei vier zwei fünf sechs.</p>
		</expected>
	</test>
	<test output="xml">
		<task>Phrase highlighting 5</task>
		<code>
			for $hit in doc("/db/test/text1.xml")//p[ft:query(., '"acht neun"')]
			return
				util:expand($hit/b)
		</code>
		<expected>
			<b><exist:match xmlns:exist="http://exist.sourceforge.net/NS/exist">neun</exist:match></b>
		</expected>
	</test>
	<test output="xml">
		<task>index-keys test 1</task>
		<code><![CDATA[
			declare function local:key($key, $options) {
				<t>{$key}</t>
			};
			
			<terms>
			{
			let $callback := util:function(xs:QName("local:key"), 2)
			return
				util:index-keys-by-qname(xs:QName("p"), (), $callback, 10000, "lucene-index")
			}
			</terms>]]></code>
		<expected>
			<terms>
				<t>acht</t>
				<t>drei</t>
				<t>eins</t>
				<t>fünf</t>
				<t>neun</t>
				<t>sechs</t>
				<t>sieben</t>
				<t>vier</t>
				<t>zehn</t>
				<t>zwei</t>
			</terms>
		</expected>
	</test>
	<test output="xml">
		<task>index-keys test 2</task>
		<code><![CDATA[
			declare function local:key($key, $options) {
				<t>{$key}</t>
			};
			
			<terms>
			{
			let $callback := util:function(xs:QName("local:key"), 2)
			return
				util:index-keys-by-qname(xs:QName("p"), "s", $callback, 10000, "lucene-index")
			}
			</terms>]]></code>
		<expected>
			<terms>
				<t>sechs</t>
				<t>sieben</t>
			</terms>
		</expected>
	</test>
	<test output="xml">
		<task>index-keys test 2</task>
		<code><![CDATA[
			declare function local:key($key, $options) {
				<t>{$key}</t>
			};
			
			<terms>
			{
			let $callback := util:function(xs:QName("local:key"), 2)
			return
				util:index-keys(doc("/db/test/text1.xml")//p, "s", $callback, 10000, "lucene-index")
			}
			</terms>]]></code>
		<expected>
			<terms>
				<t>sechs</t>
				<t>sieben</t>
			</terms>
		</expected>
	</test>
	<test output="xml">
		<task>index-keys test 2</task>
		<code><![CDATA[
			declare function local:key($key, $options) {
				<t>{$key}</t>
			};
			
			<terms>
			{
			let $callback := util:function(xs:QName("local:key"), 2)
			return
				util:index-keys(doc("/db/test/text1.xml")//p[ft:query(., 'zehn')], "s", $callback, 10000, "lucene-index")
			}
			</terms>]]></code>
		<expected>
			<terms>
				<t>sieben</t>
			</terms>
		</expected>
	</test>
</TestSet>
